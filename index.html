<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Teresa · marketplace with payments & delivery</title>
    <!-- SEO meta tags (same as before) -->
    <meta name="description" content="Teresa – your everyday style and gadgets. Shop the latest trends in beauty, electronics, and accessories.">
    <meta name="keywords" content="Teresa, online shop, gadgets, beauty, earrings, nose ring, Kenya">
    <meta name="author" content="Teresa">
    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://yourdomain.com">
    <meta property="og:title" content="Teresa · style & gadgets">
    <meta property="og:description" content="Your everyday style and gadgets. Shop now!">
    <meta property="og:image" content="https://placehold.co/1200x630/03ac0e/white?text=Teresa">
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://yourdomain.com">
    <meta property="twitter:title" content="Teresa · style & gadgets">
    <meta property="twitter:description" content="Your everyday style and gadgets. Shop now!">
    <meta property="twitter:image" content="https://placehold.co/1200x630/03ac0e/white?text=Teresa">
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Supabase JS client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Favicon (same) -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Cstyle%3E.accent-icon%7Bstroke:%23C72A4C;stroke-width:8;fill:none;stroke-linecap:round;stroke-linejoin:round;%7D%3C/style%3E%3Cpath class='accent-icon' d='M70 50 L100 30 L130 70 L115 130 L85 130 L70 70 L70 50'/%3E%3Ccircle cx='100' cy='55' r='12' fill='%23C72A4C' opacity='0.9'/%3E%3C/svg%3E">
    <style>
        /* ========== GLOBAL STYLES (original + new classes) ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
        body {
            background-color: #f1f3f4;
        }
        :root {
            --tokped-green: #03ac0e;
            --tokped-green-light: #e6f7e6;
            --tokped-border: #e0e0e0;
            --tokped-text: #212121;
            --tokped-price: #03ac0e;
            --brand-magenta: #C72A4C;
        }
        .app {
            max-width: 500px;
            margin: 0 auto;
            background-color: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            position: relative;
            padding-bottom: 70px;
        }
        .header {
            background-color: white;
            padding: 12px 16px 8px;
            border-bottom: 1px solid var(--tokped-border);
            position: sticky;
            top: 0;
            z-index: 15;
        }
        .top-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .logo-area svg {
            display: block;
            height: 45px;
            width: auto;
        }
        .action-icons {
            display: flex;
            gap: 18px;
            color: #424242;
            align-items: center;
        }
        .action-icons i {
            font-size: 1.3rem;
            cursor: pointer;
        }
        .cart-icon {
            position: relative;
        }
        #cartCount {
            position: absolute;
            top: -8px;
            right: -10px;
            background: #e53935;
            color: white;
            font-size: 0.65rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 30px;
            min-width: 18px;
            text-align: center;
        }
        .logout-icon {
            color: #c0392b;
        }
        .search-bar {
            display: flex;
            background-color: #f1f3f4;
            border-radius: 8px;
            padding: 10px 16px;
            align-items: center;
            gap: 8px;
        }
        .search-bar i {
            font-size: 1rem;
            color: #9e9e9e;
        }
        .search-bar input {
            border: none;
            background: transparent;
            flex: 1;
            outline: none;
            font-size: 0.95rem;
        }
        .express-banner {
            background: linear-gradient(135deg, #f9a825, #f57c00);
            color: white;
            padding: 12px 16px;
            margin: 8px 16px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }
        .express-banner i {
            font-size: 1.8rem;
        }
        .express-banner div {
            flex: 1;
        }
        .express-banner .small {
            font-size: 0.8rem;
            opacity: 0.9;
        }
        .banner-carousel {
            margin: 12px 16px;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            display: flex;
            gap: 10px;
            scrollbar-width: none;
            border-radius: 16px;
        }
        .banner-carousel::-webkit-scrollbar { display: none; }
        .banner-item {
            flex: 0 0 90%;
            scroll-snap-align: start;
            background: #e0e0e0;
            border-radius: 16px;
            height: 130px;
            background-size: cover;
            background-position: center;
            position: relative;
        }
        .banner-item a {
            display: block;
            width: 100%;
            height: 100%;
            text-decoration: none;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            padding: 16px;
            font-weight: bold;
            font-size: 1.2rem;
            background: rgba(0,0,0,0.2);
            border-radius: 16px;
        }
        .banner-dots {
            display: flex;
            justify-content: center;
            gap: 6px;
            margin: 4px 0 8px;
        }
        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ccc;
        }
        .dot.active { background: var(--tokped-green); }
        .categories {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 8px 16px 12px;
            white-space: nowrap;
            scrollbar-width: none;
            border-bottom: 1px solid var(--tokped-border);
        }
        .categories::-webkit-scrollbar { display: none; }
        .chip {
            background-color: #f1f3f4;
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 0.85rem;
            font-weight: 500;
            color: #3c3c3c;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: 0.1s;
        }
        .chip img {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            object-fit: cover;
        }
        .chip i {
            color: var(--tokped-green);
        }
        .chip.active {
            background-color: var(--tokped-green);
            color: white;
        }
        .chip.active i { color: white; }
        .admin-bar {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding: 10px 16px 0;
            gap: 8px;
        }
        .admin-badge {
            background: #fdecea;
            color: #b85c5c;
            font-size: 0.7rem;
            padding: 4px 12px;
            border-radius: 30px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }
        .seller-badge {
            background: #f39c12;
            color: white;
            font-size: 0.7rem;
            padding: 4px 12px;
            border-radius: 30px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }
        .product-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            padding: 16px;
        }
        .product-card {
            background: white;
            border-radius: 16px;
            border: 1px solid var(--tokped-border);
            overflow: hidden;
            position: relative;
            box-shadow: 0 2px 6px rgba(0,0,0,0.02);
            cursor: pointer;
        }
        .image-section {
            position: relative;
            width: 100%;
            aspect-ratio: 1/1;
            background-color: #f7f7f7;
            border-bottom: 1px solid #eee;
        }
        .product-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .product-badges {
            position: absolute;
            top: 8px;
            left: 8px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .badge {
            background: rgba(0,0,0,0.7);
            color: white;
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 4px;
            display: inline-block;
        }
        .badge.official {
            background: #1e88e5;
        }
        .badge.nonreturn {
            background: #e53935;
        }
        .badge.stock {
            background: #43a047;
        }
        .badge.outstock {
            background: #757575;
        }
        .product-badge-bottom {
            display: flex;
            align-items: center;
            background: #fef7e6;
            padding: 4px 8px;
            border-bottom: 1px solid #ffecd1;
            gap: 6px;
            font-size: 0.7rem;
            color: #a86800;
            min-height: 32px;
        }
        .product-badge-bottom img {
            height: 20px;
            width: auto;
            max-width: 60px;
            object-fit: contain;
        }
        .product-badge-bottom span {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .product-info {
            padding: 10px 8px 12px;
        }
        .product-name {
            font-weight: 600;
            font-size: 0.9rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            min-height: 2.4rem;
        }
        .price-discount {
            display: flex;
            align-items: baseline;
            gap: 6px;
            flex-wrap: wrap;
            margin: 5px 0 4px;
        }
        .product-price {
            font-weight: 700;
            font-size: 1rem;
            color: var(--tokped-price);
        }
        .original-price {
            font-size: 0.75rem;
            color: #9e9e9e;
            text-decoration: line-through;
        }
        .discount-badge {
            background: #ff5722;
            color: white;
            font-size: 0.65rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 30px;
        }
        .product-rating {
            font-size: 0.7rem;
            color: #757575;
            display: flex;
            align-items: center;
            gap: 4px;
            margin-bottom: 8px;
        }
        .product-rating i { color: #f9a825; }
        .stock-status {
            font-size: 0.7rem;
            color: #43a047;
            margin-bottom: 8px;
        }
        .stock-status.out {
            color: #e53935;
        }
        .add-to-cart-btn {
            background: var(--tokped-green);
            border: none;
            color: white;
            padding: 8px 0;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            cursor: pointer;
            width: 100%;
            border: 1px solid #02940c;
        }
        .add-to-cart-btn:disabled {
            background: #ccc;
            border-color: #aaa;
            cursor: not-allowed;
        }
        .affiliate-btn {
            background: #f39c12;
            border: none;
            color: white;
            padding: 8px 0;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            cursor: pointer;
            width: 100%;
            border: 1px solid #e67e22;
            margin-top: 8px;
            text-decoration: none;
        }
        .btn-copy-link {
            background: #3498db;
            border: none;
            color: white;
            padding: 8px 0;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            cursor: pointer;
            width: 100%;
            border: 1px solid #2980b9;
            margin-top: 8px;
        }
        .admin-controls {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 8px;
            border-top: 1px dashed #ddd;
            padding-top: 6px;
        }
        .admin-controls i {
            font-size: 1rem;
            padding: 6px;
            border-radius: 50%;
            background: #f1f1f1;
            cursor: pointer;
        }
        .admin-controls .fa-edit { color: #2c3e50; }
        .admin-controls .fa-trash { color: #c0392b; }
        .btn-add-product {
            background: white;
            border: 1px dashed var(--tokped-green);
            color: var(--tokped-green);
            padding: 14px;
            margin: 0 16px 16px;
            border-radius: 60px;
            width: calc(100% - 32px);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            max-width: 500px;
            margin: 0 auto;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 10px 0 12px;
            border-top: 1px solid var(--tokped-border);
            z-index: 20;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #757575;
            font-size: 0.65rem;
            cursor: pointer;
        }
        .nav-item i { font-size: 1.3rem; }
        .nav-item.active { color: var(--tokped-green); }
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-card {
            background: white;
            width: 90%;
            max-width: 400px;
            border-radius: 24px;
            padding: 24px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-card h3 { margin-bottom: 18px; }
        .modal-field { margin-bottom: 16px; }
        .modal-field label {
            display: block;
            font-weight: 500;
            font-size: 0.85rem;
            margin-bottom: 4px;
        }
        .modal-field input, .modal-field select, .modal-field textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #dadada;
            border-radius: 12px;
        }
        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        .modal-actions button {
            flex: 1;
            padding: 12px;
            border-radius: 30px;
            border: none;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-save { background: var(--tokped-green); color: white; }
        .btn-cancel { background: #f1f3f4; color: #3c3c3c; }
        .delivery-option {
            border: 1px solid var(--tokped-border);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            cursor: pointer;
        }
        .delivery-option.selected {
            border-color: var(--tokped-green);
            background-color: var(--tokped-green-light);
        }
        .delivery-option-header {
            display: flex;
            justify-content: space-between;
            font-weight: 600;
        }
        .delivery-option-details {
            font-size: 0.8rem;
            color: #666;
            margin-top: 4px;
        }
        .delivery-option-time {
            font-size: 0.75rem;
            color: var(--tokped-green);
            margin-top: 4px;
        }
        .payment-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border: 1px solid var(--tokped-border);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .cart-item {
            display: flex;
            gap: 12px;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding: 12px 0;
        }
        .cart-item-img { width: 50px; height: 50px; background: #f1f1f1; border-radius: 8px; object-fit: cover; }
        .cart-item-details { flex: 1; }
        .cart-item-name { font-weight: 600; font-size: 0.9rem; }
        .cart-item-price { color: var(--tokped-price); font-weight: 600; }
        .cart-item-qty { display: flex; align-items: center; gap: 8px; margin-top: 4px; }
        .cart-item-qty button {
            background: #f1f1f1;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 30px;
            font-weight: bold;
            cursor: pointer;
        }
        .wa-checkout-btn {
            background: #25D366;
            color: white;
            border: none;
            padding: 14px;
            border-radius: 30px;
            font-weight: 600;
            width: 100%;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
        }
        .admin-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .admin-tab {
            background: #f1f3f4;
            padding: 8px 14px;
            border-radius: 30px;
            font-size: 0.85rem;
            cursor: pointer;
        }
        .admin-tab.active { background: var(--tokped-green); color: white; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }
        .banner-list-item, .cat-list-item, .prod-list-item, .user-list-item, .review-list-item {
            display: flex;
            gap: 10px;
            align-items: center;
            background: #f9f9f9;
            padding: 8px;
            border-radius: 12px;
            margin-bottom: 8px;
        }
        .cat-list-item img, .prod-list-item img {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
        }
        .cat-list-item i { font-size: 1.2rem; width: 30px; text-align: center; }
        .prod-list-item span { flex: 1; }
        .user-list-item, .review-list-item { flex-direction: column; align-items: flex-start; }
        .notif-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        .notif-item i {
            font-size: 1.5rem;
            color: var(--tokped-green);
        }
        .notif-item div {
            flex: 1;
        }
        .notif-item .notif-title {
            font-weight: 600;
            font-size: 0.95rem;
        }
        .notif-item .notif-time {
            font-size: 0.7rem;
            color: #999;
        }
        .image-gallery {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            margin: 10px 0;
            padding: 4px 0;
        }
        .gallery-image {
            width: 70px;
            height: 70px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid #ddd;
            cursor: pointer;
        }
        .main-image {
            width: 100%;
            aspect-ratio: 1/1;
            object-fit: cover;
            border-radius: 16px;
            margin-bottom: 10px;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 30px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        .status-ordered { background: #ffecb3; color: #b26a00; }
        .status-waiting_shipment { background: #ffe0b2; color: #bf360c; }
        .status-shipped { background: #b3e5fc; color: #01579b; }
        .status-delivered { background: #c8e6c9; color: #1b5e20; }
        .analytics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }
        .analytics-card {
            background: #f9f9f9;
            border-radius: 16px;
            padding: 16px;
            text-align: center;
        }
        .analytics-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--tokped-green);
        }
        .analytics-label {
            font-size: 0.8rem;
            color: #666;
        }
        .order-detail-item {
            font-size: 0.8rem;
            color: #555;
        }
        .star-rating {
            display: flex;
            gap: 4px;
            font-size: 1.5rem;
            cursor: pointer;
        }
        .star-rating .fa-star {
            color: #ddd;
        }
        .star-rating .fa-star.selected {
            color: #f9a825;
        }
        .also-viewed {
            padding: 16px;
            border-top: 8px solid #f1f3f4;
        }
        .also-viewed h4 {
            margin-bottom: 12px;
        }
        .also-viewed-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .also-item {
            border: 1px solid var(--tokped-border);
            border-radius: 12px;
            padding: 8px;
            cursor: pointer;
        }
        .also-item img {
            width: 100%;
            aspect-ratio: 1/1;
            object-fit: cover;
            border-radius: 8px;
        }
        .also-item .name {
            font-size: 0.8rem;
            margin-top: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .also-item .price {
            font-weight: 600;
            color: var(--tokped-price);
            font-size: 0.8rem;
        }

        /* ===== NEW STYLES FOR PAYMENTS, RETURNS & PRODUCT ATTRIBUTES ===== */
        .instrument-item {
            background: #f9f9f9;
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 10px;
            border: 1px solid var(--tokped-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .instrument-verified {
            color: var(--tokped-green);
            font-size: 0.8rem;
            font-weight: 600;
        }
        .claim-evidence {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 10px 0;
        }
        .claim-evidence img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .file-input-label {
            background: #f1f3f4;
            padding: 8px 16px;
            border-radius: 30px;
            cursor: pointer;
            display: inline-block;
        }
        .file-input-label i {
            margin-right: 5px;
        }
        .product-attributes {
            display: flex;
            gap: 10px;
            font-size: 0.8rem;
            color: #666;
            margin: 5px 0;
        }
        .product-attributes span {
            background: #f1f3f4;
            padding: 2px 8px;
            border-radius: 20px;
        }
    </style>
</head>
<body>
    <div class="app" id="app">
        <!-- HEADER (same as original) -->
        <div class="header">
            <div class="top-row">
                <div class="logo-area">
                    <svg width="100%" height="45" viewBox="0 0 400 160" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg">
                        <style>
                            .brand-main { font-family: 'Segoe Script', 'Brush Script MT', cursive; font-size: 52px; fill: #2C2C2C; }
                            .accent-main { stroke: #C72A4C; stroke-width: 4; fill: none; stroke-linecap: round; stroke-linejoin: round; }
                        </style>
                        <path class="accent-main" d="M60 50 L80 40 L100 70 L90 110 L70 110 L60 70 L60 50" />
                        <circle cx="80" cy="60" r="8" fill="#C72A4C" opacity="0.9" />
                        <text x="120" y="95" class="brand-main">Teresa</text>
                    </svg>
                </div>
                <div class="action-icons">
                    <i class="fas fa-bell" id="notifIcon"></i>
                    <i class="fas fa-sign-out-alt logout-icon" id="logoutIcon" style="display: none;"></i>
                    <div class="cart-icon" id="cartIcon">
                        <i class="fas fa-shopping-cart"></i>
                        <span id="cartCount">0</span>
                    </div>
                </div>
            </div>
            <div class="search-bar">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Search in Teresa...">
            </div>
        </div>

        <!-- EXPRESS BANNER (same) -->
        <div class="express-banner">
            <i class="fas fa-rocket"></i>
            <div>
                <div>Teresa Express</div>
                <div class="small">The BEST products, delivered faster. Now PAY on DELIVERY, Cash or Bank Transfer Anywhere, Zero Wahala!</div>
            </div>
        </div>

        <!-- BANNER CAROUSEL -->
        <div id="bannerCarousel" class="banner-carousel"></div>
        <div id="bannerDots" class="banner-dots"></div>

        <!-- CATEGORIES -->
        <div id="categoryContainer" class="categories"></div>

        <!-- ADMIN/SELLER BAR -->
        <div class="admin-bar">
            <span id="adminModeBadge" class="admin-badge" style="display: none;"><i class="fas fa-unlock-alt"></i> admin</span>
            <span id="sellerModeBadge" class="seller-badge" style="display: none;"><i class="fas fa-store"></i> seller</span>
        </div>

        <!-- PRODUCT GRID -->
        <div id="productGrid" class="product-grid"></div>

        <!-- ADD PRODUCT BUTTON (admin or seller) -->
        <button id="addProductBtn" class="btn-add-product" style="display: none;"><i class="fas fa-plus-circle"></i> Add new product</button>

        <!-- CUSTOMERS ALSO VIEWED (grid) -->
        <div id="alsoViewedSection" class="also-viewed" style="display: none;">
            <h4>Customers also viewed</h4>
            <div class="also-viewed-grid" id="alsoViewedList"></div>
        </div>

        <!-- BOTTOM NAVIGATION -->
        <div class="bottom-nav">
            <div class="nav-item" data-nav="home"><i class="fas fa-home"></i><span>Home</span></div>
            <div class="nav-item" data-nav="promo"><i class="fas fa-tags"></i><span>Promo</span></div>
            <div class="nav-item" data-nav="sell" id="sellNav" style="display: none;"><i class="fas fa-store"></i><span>Sell</span></div>
            <div class="nav-item" data-nav="orders"><i class="fas fa-clipboard-list"></i><span>Orders</span></div>
            <div class="nav-item" data-nav="notif"><i class="fas fa-bell"></i><span>Notif</span></div>
            <div class="nav-item" data-nav="me"><i class="fas fa-user"></i><span>Me</span></div>
        </div>
    </div>

    <!-- CART MODAL (unchanged) -->
    <div id="cartModal" class="modal">
        <div class="modal-card">
            <h3><i class="fas fa-shopping-cart"></i> Your cart</h3>
            <div id="cartItemsList"></div>
            <div id="cartTotal" class="cart-total" style="font-weight:700; margin:16px 0; text-align:right;">Total: KSh 0</div>
            <button class="wa-checkout-btn" id="cartWhatsappBtn"><i class="fab fa-whatsapp"></i> Order via WhatsApp</button>
            <button class="btn-save" id="checkoutBtn" style="margin-top:10px; width:100%;"><i class="fas fa-check"></i> Place order (trackable)</button>
            <div class="modal-actions" style="margin-top:12px;">
                <button class="btn-cancel" id="closeCartBtn">Close</button>
            </div>
        </div>
    </div>

    <!-- CHECKOUT DETAILS MODAL (unchanged) -->
    <div id="checkoutDetailsModal" class="modal">
        <div class="modal-card">
            <h3><i class="fas fa-truck"></i> Delivery & Payment</h3>
            
            <div class="modal-field">
                <label>Full name</label>
                <input type="text" id="checkoutName" placeholder="John Doe">
            </div>
            <div class="modal-field">
                <label>Phone number</label>
                <input type="tel" id="checkoutPhone" placeholder="0712345678">
            </div>
            
            <!-- Delivery Method -->
            <div class="modal-field">
                <label>Delivery Method</label>
                <div id="deliveryOptions">
                    <div class="delivery-option" data-method="door" id="deliveryDoor">
                        <div class="delivery-option-header">
                            <span><i class="fas fa-truck"></i> Door Delivery</span>
                            <span>KSh <span id="deliveryFeeDisplay">250</span></span>
                        </div>
                        <div class="delivery-option-details">Ready for delivery between <span id="doorStart"></span> and <span id="doorEnd"></span></div>
                        <div class="delivery-option-time" id="doorTimer"></div>
                    </div>
                    <div class="delivery-option" data-method="pickup" id="deliveryPickup">
                        <div class="delivery-option-header">
                            <span><i class="fas fa-store"></i> Pickup Station</span>
                            <span>Free</span>
                        </div>
                        <div class="delivery-option-details">Pickup at Teresa Hub, Nairobi</div>
                        <div class="delivery-option-time">Ready for pickup between <span id="pickupStart"></span> and <span id="pickupEnd"></span></div>
                    </div>
                </div>
            </div>

            <!-- Address (only for door delivery) -->
            <div class="modal-field" id="addressField">
                <label>Shipping address</label>
                <textarea id="checkoutAddress" rows="2" placeholder="Street, city, building..."></textarea>
            </div>

            <!-- Payment Method -->
            <div class="modal-field">
                <label>Payment Method</label>
                <div id="paymentOptions">
                    <div class="payment-option">
                        <input type="radio" name="payment" value="cash" id="payCash" checked>
                        <label for="payCash"><i class="fas fa-money-bill-wave"></i> Cash on Delivery</label>
                    </div>
                    <div class="payment-option">
                        <input type="radio" name="payment" value="bank" id="payBank">
                        <label for="payBank"><i class="fas fa-university"></i> Bank Transfer (M-Pesa/Bank)</label>
                    </div>
                </div>
            </div>

            <div class="modal-field">
                <label>Order notes (optional)</label>
                <textarea id="checkoutNotes" rows="2" placeholder="Any special instructions"></textarea>
            </div>

            <div class="modal-actions">
                <button class="btn-cancel" id="checkoutCancel">Cancel</button>
                <button class="btn-save" id="checkoutConfirm">Confirm order</button>
            </div>
        </div>
    </div>

    <!-- AUTH MODAL (unchanged) -->
    <div id="authModal" class="modal">
        <div class="modal-card">
            <h3 id="authModalTitle">Login</h3>
            <div class="modal-field">
                <label>Email</label>
                <input type="email" id="authEmail" placeholder="your@email.com">
            </div>
            <div class="modal-field">
                <label>Password</label>
                <input type="password" id="authPassword" placeholder="••••••••">
            </div>
            <div class="modal-actions">
                <button class="btn-cancel" id="authCancel">Cancel</button>
                <button class="btn-save" id="authLoginBtn">Login</button>
            </div>
            <p style="text-align:center; margin-top:16px;">
                Don't have an account? <a href="#" id="showSignup">Sign up</a>
            </p>
        </div>
    </div>

    <!-- PROFILE MODAL (with seller features) -->
    <div id="profileModal" class="modal">
        <div class="modal-card">
            <h3><i class="fas fa-user"></i> My Account</h3>
            <p><strong id="profileEmail"></strong> <span id="profileRole" class="seller-badge"></span></p>
            <div id="sellerRequestSection" style="margin: 16px 0;"></div>
            <button class="btn-cancel" id="logoutBtn" style="width:100%; margin-bottom:20px;">Logout</button>

            <!-- Referral Stats -->
            <div style="margin: 16px 0;">
                <h4>Referral Stats</h4>
                <div class="analytics-grid" style="grid-template-columns:1fr 1fr;">
                    <div class="analytics-card"><span class="analytics-value" id="totalClicks">0</span><div class="analytics-label">Clicks</div></div>
                    <div class="analytics-card"><span class="analytics-value" id="totalConversions">0</span><div class="analytics-label">Conversions</div></div>
                    <div class="analytics-card"><span class="analytics-value" id="pendingEarnings">0</span><div class="analytics-label">Pending (KSh)</div></div>
                    <div class="analytics-card"><span class="analytics-value" id="paidEarnings">0</span><div class="analytics-label">Paid (KSh)</div></div>
                </div>
            </div>

            <h4>My Orders</h4>
            <div id="userOrdersList"></div>

            <!-- Seller Dashboard (inside profile) -->
            <div id="sellerDashboard" style="display: none; margin-top:20px;"></div>

            <div class="modal-actions"><button class="btn-cancel" id="closeProfileBtn">Close</button></div>
        </div>
    </div>

    <!-- SELLER DASHBOARD MODAL (dedicated) -->
    <div id="sellerDashboardModal" class="modal">
        <div class="modal-card">
            <h3><i class="fas fa-store"></i> Seller Dashboard</h3>
            <div id="sellerDashboardContent"></div>
            <div class="modal-actions"><button class="btn-cancel" id="closeSellerModal">Close</button></div>
        </div>
    </div>

    <!-- SELLER APPLICATION MODAL (unchanged) -->
    <div id="sellerApplyModal" class="modal">
        <div class="modal-card">
            <h3>Become a Seller</h3>
            <p>Apply to start selling your products on Teresa.</p>
            <div class="modal-actions">
                <button class="btn-cancel" id="sellerApplyCancel">Cancel</button>
                <button class="btn-save" id="sellerApplyConfirm">Submit Application</button>
            </div>
        </div>
    </div>

    <!-- REVIEW MODAL (unchanged) -->
    <div id="reviewModal" class="modal">
        <div class="modal-card">
            <h3><i class="fas fa-star"></i> Write a review</h3>
            <div class="modal-field">
                <label>Rating</label>
                <div class="star-rating" id="starRating">
                    <i class="fas fa-star" data-value="1"></i>
                    <i class="fas fa-star" data-value="2"></i>
                    <i class="fas fa-star" data-value="3"></i>
                    <i class="fas fa-star" data-value="4"></i>
                    <i class="fas fa-star" data-value="5"></i>
                </div>
                <input type="hidden" id="reviewRating" value="0">
            </div>
            <div class="modal-field">
                <label>Comment</label>
                <textarea id="reviewComment" rows="3" placeholder="Share your experience..."></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn-cancel" id="reviewCancel">Cancel</button>
                <button class="btn-save" id="reviewSubmit">Submit review</button>
            </div>
        </div>
    </div>

    <!-- ADMIN DASHBOARD MODAL -->
    <div id="adminModal" class="modal">
        <div class="modal-card">
            <h3><i class="fas fa-cog"></i> Admin dashboard</h3>
            <div class="admin-tabs">
                <div class="admin-tab active" data-tab="categories">Categories</div>
                <div class="admin-tab" data-tab="banners">Banners</div>
                <div class="admin-tab" data-tab="products">Products</div>
                <div class="admin-tab" data-tab="orders">Orders</div>
                <div class="admin-tab" data-tab="users">Users</div>
                <div class="admin-tab" data-tab="sellers">Seller Apps</div>
                <div class="admin-tab" data-tab="reviews">Reviews</div>
                <div class="admin-tab" data-tab="analytics">Analytics</div>
                <div class="admin-tab" data-tab="settings">Settings</div>
                <!-- Two new tabs added by JS -->
            </div>
            <!-- Tab panes (some will be populated by JS) -->
            <div id="tab-categories" class="tab-pane active"><div id="categoriesList"></div><button class="btn-add-product" id="addCategoryBtn" style="margin:10px 0;"><i class="fas fa-plus"></i> Add category</button></div>
            <div id="tab-banners" class="tab-pane"><div id="bannersList"></div><button class="btn-add-product" id="addBannerBtn" style="margin:10px 0;"><i class="fas fa-plus"></i> Add banner</button></div>
            <div id="tab-products" class="tab-pane"><div id="productsList"></div></div>
            <div id="tab-orders" class="tab-pane"><div id="adminOrdersList"></div></div>
            <div id="tab-users" class="tab-pane"><div id="usersList"></div></div>
            <div id="tab-sellers" class="tab-pane"><div id="sellerApplicationsList"></div></div>
            <div id="tab-reviews" class="tab-pane"><div id="reviewsList"></div></div>
            <div id="tab-analytics" class="tab-pane"><div class="analytics-grid">...</div></div>
            <div id="tab-settings" class="tab-pane">...</div>
            <!-- New panes will be appended by enhanceAdminModal() -->
            <div class="modal-actions"><button class="btn-cancel" id="closeAdminModal">Close</button></div>
        </div>
    </div>

    <!-- PRODUCT DETAIL MODAL (enhanced with brand/color/size) -->
    <div id="productDetailModal" class="modal">
        <div class="modal-card">
            <h3 id="detailProductName"></h3>
            <div style="display: flex; gap: 5px; margin-bottom: 5px; flex-wrap: wrap;">
                <span class="badge official" id="detailOfficial" style="display: none;">Official Store</span>
                <span class="badge nonreturn" id="detailNonReturn" style="display: none;">Non-returnable</span>
                <span class="badge stock" id="detailInStock" style="display: none;">In stock</span>
                <span class="badge outstock" id="detailOutStock" style="display: none;">Out of stock</span>
            </div>
            <img id="detailMainImage" class="main-image" src="" alt="" loading="lazy">
            <div class="image-gallery" id="detailGallery"></div>
            <p id="detailDescription" style="margin:12px 0;"></p>
            <div class="price-discount" style="margin-bottom:12px;">
                <span class="product-price" id="detailPrice"></span>
                <span class="original-price" id="detailOriginalPrice"></span>
                <span class="discount-badge" id="detailDiscount" style="display:none;"></span>
            </div>
            <div class="product-attributes" id="detailAttributes"></div>
            <div class="stock-status" id="detailStock"></div>
            <div style="font-size:0.8rem; margin-bottom:12px;" id="detailReturnPolicy"></div>
            <button class="add-to-cart-btn" id="detailAddToCart"><i class="fas fa-cart-plus"></i> Add to cart</button>
            <a href="#" target="_blank" rel="noopener" class="affiliate-btn" id="affiliateLinkBtn" style="display:none;"><i class="fas fa-external-link-alt"></i> Affiliate link</a>
            <button class="btn-copy-link" id="copyReferralLink" style="display:none;"><i class="fas fa-link"></i> Copy referral link</button>
            <div class="modal-actions"><button class="btn-cancel" id="closeDetailBtn">Close</button></div>
        </div>
    </div>

    <!-- EDIT PRODUCT MODAL (with brand, color, size) -->
    <div id="productEditModal" class="modal">
        <div class="modal-card">
            <h3 id="productModalTitle">Edit product</h3>
            <div class="modal-field"><label>Product name</label><input type="text" id="prodName"></div>
            <div class="modal-field"><label>Brand</label><input type="text" id="prodBrand" placeholder="e.g. Apple, Samsung"></div>
            <div class="modal-field"><label>Color (comma separated)</label><input type="text" id="prodColor" placeholder="Red, Blue, Black"></div>
            <div class="modal-field"><label>Size (comma separated)</label><input type="text" id="prodSize" placeholder="S, M, L"></div>
            <div class="modal-field"><label>Price (KSh)</label><input type="number" id="prodPrice"></div>
            <div class="modal-field"><label>Cost price (for profit)</label><input type="number" id="prodCost" placeholder="KSh"></div>
            <div class="modal-field"><label>Original price (for discount)</label><input type="number" id="prodOriginalPrice" placeholder="0 = no discount"></div>
            <div class="modal-field"><label>Commission (%)</label><input type="number" id="prodCommission" value="10" min="0" max="100"></div>
            <div class="modal-field"><label>Stock</label><input type="number" id="prodStock" value="10"></div>
            <div class="modal-field"><label>Return policy</label><input type="text" id="prodReturnPolicy" value="Free return within 7 days"></div>
            <div class="modal-field"><label><input type="checkbox" id="prodOfficial"> Official Store</label></div>
            <div class="modal-field"><label><input type="checkbox" id="prodNonReturn"> Non-returnable</label></div>
            <div class="modal-field"><label>Main image URL</label><input type="text" id="prodImage"></div>
            <div class="modal-field"><label>Additional image URLs (comma separated)</label><input type="text" id="prodImages" placeholder="url1, url2, url3"></div>
            <div class="modal-field"><label>Description</label><textarea id="prodDescription" rows="3"></textarea></div>
            <div class="modal-field"><label>Affiliate link (optional)</label><input type="text" id="prodAffiliateLink" placeholder="https://..."></div>
            <div class="modal-field"><label>Category</label><select id="prodCategory"></select></div>
            <div class="modal-field"><label>Rating</label><input type="number" step="0.1" id="prodRating" value="4.5"></div>
            <div class="modal-field"><label>Sold count</label><input type="number" id="prodSold" value="0"></div>
            <div class="modal-field"><label>Small badge image URL (optional)</label><input type="text" id="prodBadgeImage" placeholder="https://..."></div>
            <div class="modal-field"><label>Badge text (e.g. RAMADAN EKSTRASERU)</label><input type="text" id="prodBadgeText" placeholder="Ramadan EKSTRASERU"></div>
            <div class="modal-actions">
                <button class="btn-cancel" id="productModalCancel">Cancel</button>
                <button class="btn-save" id="productModalSave">Save</button>
            </div>
        </div>
    </div>

    <!-- EDIT CATEGORY MODAL (unchanged) -->
    <div id="categoryEditModal" class="modal">
        <div class="modal-card">
            <h3>Edit category</h3>
            <div class="modal-field"><label>Category name</label><input type="text" id="catNameInput"></div>
            <div class="modal-field"><label>Icon class (Font Awesome fallback, e.g. fa-mobile-alt)</label><input type="text" id="catIconInput" placeholder="fa-mobile-alt"></div>
            <div class="modal-field"><label>Category image URL (optional, will replace icon)</label><input type="text" id="catImageInput" placeholder="https://..."></div>
            <div class="modal-actions">
                <button class="btn-cancel" id="catModalCancel">Cancel</button>
                <button class="btn-save" id="catModalSave">Save</button>
            </div>
        </div>
    </div>

    <!-- EDIT BANNER MODAL (unchanged) -->
    <div id="bannerEditModal" class="modal">
        <div class="modal-card">
            <h3>Edit banner</h3>
            <div class="modal-field"><label>Image URL</label><input type="text" id="bannerImageInput"></div>
            <div class="modal-field"><label>Link (optional)</label><input type="text" id="bannerLinkInput"></div>
            <div class="modal-field"><label>Title text</label><input type="text" id="bannerTitleInput"></div>
            <div class="modal-actions">
                <button class="btn-cancel" id="bannerModalCancel">Cancel</button>
                <button class="btn-save" id="bannerModalSave">Save</button>
            </div>
        </div>
    </div>

    <!-- NOTIFICATION MODAL (unchanged) -->
    <div id="notifModal" class="modal">
        <div class="modal-card">
            <h3><i class="fas fa-bell"></i> Notifications</h3>
            <div id="notificationsList"></div>
            <div class="modal-actions"><button class="btn-cancel" id="closeNotifBtn">Close</button></div>
        </div>
    </div>

    <!-- RETURN REQUEST MODAL (new, replaces prompt) -->
    <div id="returnRequestModal" class="modal">
        <div class="modal-card">
            <h3>Request Return</h3>
            <div class="modal-field">
                <label>Reason for return</label>
                <textarea id="returnReason" rows="3" placeholder="Explain why you want to return this item..."></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn-cancel" id="returnCancel">Cancel</button>
                <button class="btn-save" id="returnSubmit">Submit Request</button>
            </div>
        </div>
    </div>

    <!-- CLAIM MODAL will be created dynamically if needed -->

    <script>
        (async function() {
            // ========== SUPABASE SETUP ==========
            const SUPABASE_URL = 'https://odbshafjwvfugdzmzqiy.supabase.co'; // Replace with your project URL
            const SUPABASE_ANON_KEY = 'sb_publishable_jXUYWabg2wvHsshIFZLHSA_GheHJfdk'; // Replace with your anon key
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            // ========== REFERRAL TRACKING ==========
            const urlParams = new URLSearchParams(window.location.search);
            const ref = urlParams.get('ref');
            const productParam = urlParams.get('product');
            if (ref && ref.length > 0) {
                localStorage.setItem('referrer', ref);
                if (productParam) {
                    supabase.from('referral_clicks').insert([
                        { referrer_id: ref, product_id: productParam }
                    ]).then(console.log).catch(console.error);
                }
            }

            // ========== DEFAULT DATA (with brand, color, size) ==========
            const DEFAULT_CATEGORIES = [
                { id: 'cat1', name: 'Gadgets', icon: 'fa-mobile-alt', image: '' },
                { id: 'cat2', name: 'Beauty', icon: 'fa-magic', image: '' },
                { id: 'cat3', name: 'Ladies', icon: 'fa-gem', image: '' },
                { id: 'cat4', name: 'Earrings', icon: 'fa-earrings', image: '' },
                { id: 'cat5', name: 'Nose ring', icon: 'fa-ring', image: '' }
            ];
            const DEFAULT_BANNERS = [
                { id: 'ban1', image: 'https://placehold.co/600x200/03ac0e/white?text=Gadgets+Sale', link: '', title: 'Gadgets Sale' },
                { id: 'ban2', image: 'https://placehold.co/600x200/f9a825/white?text=Beauty+Special', link: '', title: 'Beauty Special' }
            ];
            const DEFAULT_PRODUCTS = [
                { id: 'p1', name: 'Smartphone Android 13', brand: 'Samsung', color: 'Black, Silver', size: '', price: 25999, costPrice: 22000, originalPrice: 29999, commission_percent: 10, image: 'https://placehold.co/400x400/03ac0e/white?text=Smartphone', images: [], description: 'Latest Android 13 smartphone with 128GB storage.', category: 'cat1', rating: 4.5, sold: 78, badgeImage: 'https://p16-uploadpedia-sg.tokopedia-static.net/tos-alisg-i-zxty12jeln-sg/8caaede0c21c7e3be9a1b4e8d550acce.png~tplv-zxty12jeln-image.image', badgeText: 'RAMADAN EKSTRASERU', affiliate_link: '', seller_id: null, stock: 10, return_policy: 'Free return within 7 days', is_official_store: true, is_non_returnable: false },
                { id: 'p2', name: 'TWS Wireless Earbuds Pro', brand: 'Xiaomi', color: 'White', size: '', price: 3999, costPrice: 2500, originalPrice: 5999, commission_percent: 10, image: 'https://placehold.co/400x400/03ac0e/white?text=Earbuds', images: [], description: 'Noise cancelling earbuds with charging case.', category: 'cat1', rating: 4.3, sold: 124, badgeImage: '', badgeText: '', affiliate_link: '', seller_id: null, stock: 5, return_policy: 'Free return within 7 days', is_official_store: false, is_non_returnable: false },
                { id: 'p3', name: 'Matte Lipstick Set (6 pcs)', brand: 'MAC', color: 'Red, Pink, Nude', size: '', price: 1299, costPrice: 800, originalPrice: 1899, commission_percent: 10, image: 'https://placehold.co/400x400/03ac0e/white?text=Lipstick', images: [], description: 'Set of 6 long-lasting matte lipsticks.', category: 'cat2', rating: 4.7, sold: 312, badgeImage: 'https://p16-uploadpedia-sg.tokopedia-static.net/tos-alisg-i-zxty12jeln-sg/8caaede0c21c7e3be9a1b4e8d550acce.png~tplv-zxty12jeln-image.image', badgeText: 'RAMADAN EKSTRASERU', affiliate_link: '', seller_id: null, stock: 20, return_policy: 'Free return within 7 days', is_official_store: true, is_non_returnable: false },
                { id: 'p4', name: 'Gold Plated Hoop Earrings', brand: 'Tiffany', color: 'Gold', size: 'One Size', price: 3499, costPrice: 2000, originalPrice: 4499, commission_percent: 10, image: 'https://placehold.co/400x400/03ac0e/white?text=Earrings', images: [], description: 'Elegant gold plated hoop earrings.', category: 'cat4', rating: 4.8, sold: 56, badgeImage: '', badgeText: '', affiliate_link: '', seller_id: null, stock: 3, return_policy: 'Non-returnable', is_official_store: false, is_non_returnable: true },
                { id: 'p5', name: 'Silver Nose Ring', brand: 'Local', color: 'Silver', size: 'Adjustable', price: 899, costPrice: 400, originalPrice: 1199, commission_percent: 10, image: 'https://placehold.co/400x400/03ac0e/white?text=Nose+Ring', images: [], description: 'Adjustable silver nose ring.', category: 'cat5', rating: 4.4, sold: 103, badgeImage: '', badgeText: '', affiliate_link: '', seller_id: null, stock: 0, return_policy: 'Free return within 7 days', is_official_store: false, is_non_returnable: false }
            ];
            const DEFAULT_SETTINGS = { wa_number: '254700000000', delivery_fee: '250', pickup_stations: 'Teresa Hub Nairobi, Teresa Hub Mombasa' };

            // ========== STATE ==========
            let categories = [];
            let banners = [];
            let products = [];
            let settings = { ...DEFAULT_SETTINGS };
            let orders = [];
            let reviews = [];
            let profiles = [];
            let currentUser = null;
            let currentUserProfile = null;
            let cart = JSON.parse(localStorage.getItem('cart')) || [];

            let activeCategory = null;
            let activePromo = false;
            let searchTerm = '';
            let searchTimeout = null;

            let currentProductId = null, currentCategoryId = null, currentBannerId = null;
            let currentOrderIdForReview = null;
            let currentReturnOrderId = null; // for return modal

            // NEW STATE FOR PAYMENTS & RETURNS
            let paymentInstruments = [];
            let payouts = [];
            let returns = [];
            let claims = [];

            // ========== DOM ELEMENTS (abbreviated for brevity; we'll get them when needed) ==========
            // We'll use document.getElementById throughout

            // ========== STAR RATING HANDLER ==========
            const stars = document.querySelectorAll('#starRating .fa-star');
            stars.forEach(star => {
                star.addEventListener('click', () => {
                    const value = parseInt(star.dataset.value);
                    document.getElementById('reviewRating').value = value;
                    stars.forEach((s, i) => {
                        if (i < value) s.classList.add('selected');
                        else s.classList.remove('selected');
                    });
                });
            });

            // ========== PROFILE FUNCTIONS ==========
            async function getOrCreateProfile(user) {
                if (!user) return null;
                let { data: profile, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('user_id', user.id)
                    .single();
                
                if (error && error.code === 'PGRST116') {
                    let role = 'customer';
                    let seller_status = null;
                    if (user.email === 'admin@teresa.com') {
                        role = 'admin';
                    }
                    const newProfile = {
                        user_id: user.id,
                        email: user.email,
                        role: role,
                        seller_status: seller_status,
                        created_at: new Date().toISOString()
                    };
                    const { data: inserted, error: insertError } = await supabase
                        .from('profiles')
                        .insert([newProfile])
                        .select()
                        .single();
                    if (insertError) console.error('Profile creation error', insertError);
                    profile = inserted;
                } else if (error) {
                    console.error('Profile fetch error', error);
                } else {
                    if (user.email === 'admin@teresa.com' && profile.role !== 'admin') {
                        await supabase.from('profiles').update({ role: 'admin' }).eq('user_id', user.id);
                        profile.role = 'admin';
                    }
                }
                return profile;
            }

            // ========== DELIVERY DATE HELPER ==========
            function getDeliveryDates() {
                const now = new Date();
                const orderCutoff = new Date(now.getTime() + (3 * 60 * 60 * 1000) + (43 * 60 * 1000));
                const today = new Date();
                const startDoor = new Date(today);
                startDoor.setDate(today.getDate() + 2);
                const endDoor = new Date(today);
                endDoor.setDate(today.getDate() + 4);
                const startPickup = new Date(today);
                startPickup.setDate(today.getDate() + 1);
                const endPickup = new Date(today);
                endPickup.setDate(today.getDate() + 2);

                const formatDate = (d) => d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
                const formatTimeRemaining = () => {
                    const diff = orderCutoff - new Date();
                    if (diff <= 0) return 'Order now for fastest delivery';
                    const hours = Math.floor(diff / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    return `Place order within ${hours}hrs ${minutes}mins`;
                };

                return {
                    doorStart: startDoor,
                    doorEnd: endDoor,
                    pickupStart: startPickup,
                    pickupEnd: endPickup,
                    doorStartStr: formatDate(startDoor),
                    doorEndStr: formatDate(endDoor),
                    pickupStartStr: formatDate(startPickup),
                    pickupEndStr: formatDate(endPickup),
                    timer: formatTimeRemaining()
                };
            }

            // ========== SUPABASE FETCH & SEED ==========
            async function loadAllData() {
                // Load categories
                let { data: catData, error: catErr } = await supabase.from('categories').select('*');
                if (catErr) console.error('categories error', catErr);
                if (!catData || catData.length === 0) {
                    const { data: inserted } = await supabase.from('categories').insert(DEFAULT_CATEGORIES).select();
                    categories = inserted || DEFAULT_CATEGORIES;
                } else {
                    categories = catData;
                }

                // Load banners
                let { data: banData, error: banErr } = await supabase.from('banners').select('*');
                if (banErr) console.error('banners error', banErr);
                if (!banData || banData.length === 0) {
                    const { data: inserted } = await supabase.from('banners').insert(DEFAULT_BANNERS).select();
                    banners = inserted || DEFAULT_BANNERS;
                } else {
                    banners = banData;
                }

                // Load products (with new fields)
                let { data: prodData, error: prodErr } = await supabase.from('products').select('*');
                if (prodErr) console.error('products error', prodErr);
                if (!prodData || prodData.length === 0) {
                    const { data: inserted } = await supabase.from('products').insert(DEFAULT_PRODUCTS).select();
                    products = inserted || DEFAULT_PRODUCTS;
                } else {
                    products = prodData;
                }

                // Load settings
                let { data: settingsData, error: settingsErr } = await supabase.from('settings').select('*');
                if (settingsErr) console.error('settings error', settingsErr);
                if (settingsData) {
                    settingsData.forEach(s => settings[s.key] = s.value);
                }
                if (!settings.wa_number) settings.wa_number = DEFAULT_SETTINGS.wa_number;
                if (!settings.delivery_fee) settings.delivery_fee = DEFAULT_SETTINGS.delivery_fee;
                if (!settings.pickup_stations) settings.pickup_stations = DEFAULT_SETTINGS.pickup_stations;
                if (document.getElementById('waNumberInput')) document.getElementById('waNumberInput').value = settings.wa_number;
                if (document.getElementById('deliveryFeeInput')) document.getElementById('deliveryFeeInput').value = settings.delivery_fee;
                if (document.getElementById('deliveryFeeDisplay')) document.getElementById('deliveryFeeDisplay').innerText = settings.delivery_fee;
                if (document.getElementById('pickupStationsInput')) document.getElementById('pickupStationsInput').value = settings.pickup_stations;

                // Load orders
                let { data: ordersData, error: ordersErr } = await supabase.from('orders').select('*');
                if (ordersErr) console.error('orders error', ordersErr);
                if (ordersData) orders = ordersData;

                // Load reviews
                let { data: reviewsData, error: reviewsErr } = await supabase.from('reviews').select('*');
                if (reviewsErr) console.error('reviews error', reviewsErr);
                if (reviewsData) reviews = reviewsData;

                // Load profiles
                let { data: profilesData, error: profilesErr } = await supabase.from('profiles').select('*');
                if (profilesErr) console.error('profiles error', profilesErr);
                if (profilesData) profiles = profilesData;

                // NEW: Load payment_instruments
                let { data: piData } = await supabase.from('payment_instruments').select('*');
                if (piData) paymentInstruments = piData;

                // Load payouts
                let { data: payoutData } = await supabase.from('payouts').select('*');
                if (payoutData) payouts = payoutData;

                // Load returns
                let { data: returnData } = await supabase.from('returns').select('*');
                if (returnData) returns = returnData;

                // Load claims
                let { data: claimData } = await supabase.from('claims').select('*');
                if (claimData) claims = claimData;

                cart = cart.filter(item => products.some(p => p.id === item.id));
                localStorage.setItem('cart', JSON.stringify(cart));

                const { data: { user } } = await supabase.auth.getUser();
                currentUser = user;
                if (user) {
                    currentUserProfile = await getOrCreateProfile(user);
                } else {
                    currentUserProfile = null;
                }

                refreshUI();
            }

            function setupSubscriptions() {
                supabase.channel('categories').on('postgres_changes', { event: '*', schema: 'public', table: 'categories' }, () => loadAllData()).subscribe();
                supabase.channel('banners').on('postgres_changes', { event: '*', schema: 'public', table: 'banners' }, () => loadAllData()).subscribe();
                supabase.channel('products').on('postgres_changes', { event: '*', schema: 'public', table: 'products' }, () => loadAllData()).subscribe();
                supabase.channel('settings').on('postgres_changes', { event: '*', schema: 'public', table: 'settings' }, () => loadAllData()).subscribe();
                supabase.channel('orders').on('postgres_changes', { event: '*', schema: 'public', table: 'orders' }, () => loadAllData()).subscribe();
                supabase.channel('reviews').on('postgres_changes', { event: '*', schema: 'public', table: 'reviews' }, () => loadAllData()).subscribe();
                supabase.channel('profiles').on('postgres_changes', { event: '*', schema: 'public', table: 'profiles' }, () => loadAllData()).subscribe();
                // New tables
                supabase.channel('payment_instruments').on('postgres_changes', { event: '*', schema: 'public', table: 'payment_instruments' }, () => loadAllData()).subscribe();
                supabase.channel('payouts').on('postgres_changes', { event: '*', schema: 'public', table: 'payouts' }, () => loadAllData()).subscribe();
                supabase.channel('returns').on('postgres_changes', { event: '*', schema: 'public', table: 'returns' }, () => loadAllData()).subscribe();
                supabase.channel('claims').on('postgres_changes', { event: '*', schema: 'public', table: 'claims' }, () => loadAllData()).subscribe();
            }

            function updateCartCount() {
                const total = cart.reduce((acc, item) => acc + item.quantity, 0);
                const cartCountSpan = document.getElementById('cartCount');
                if (cartCountSpan) cartCountSpan.innerText = total;
            }

            function getFilteredProducts() {
                let filtered = products;
                if (activeCategory) filtered = filtered.filter(p => p.category === activeCategory);
                if (activePromo) filtered = filtered.filter(p => p.originalPrice && p.originalPrice > p.price);
                if (searchTerm.trim() !== '') {
                    const term = searchTerm.toLowerCase();
                    filtered = filtered.filter(p => p.name.toLowerCase().includes(term));
                }
                return filtered;
            }

            function renderCategories() {
                const container = document.getElementById('categoryContainer');
                if (!container) return;
                let html = '';
                categories.forEach(cat => {
                    const activeClass = activeCategory === cat.id ? 'active' : '';
                    html += `<span class="chip ${activeClass}" data-cat-id="${cat.id}">`;
                    if (cat.image) {
                        html += `<img src="${cat.image}" alt="${cat.name}">`;
                    } else {
                        html += `<i class="fas ${cat.icon}"></i>`;
                    }
                    html += ` ${cat.name}</span>`;
                });
                html += `<span class="chip ${activeCategory === null ? 'active' : ''}" data-cat-id="all"><i class="fas fa-th-large"></i> All</span>`;
                container.innerHTML = html;
            }

            function renderBanners() {
                const carousel = document.getElementById('bannerCarousel');
                const dots = document.getElementById('bannerDots');
                if (!carousel) return;
                let carouselHtml = '', dotsHtml = '';
                banners.forEach((banner, idx) => {
                    carouselHtml += `<div class="banner-item" style="background-image: url('${banner.image}');"><a href="${banner.link || '#'}" target="_blank">${banner.title}</a></div>`;
                    dotsHtml += `<span class="dot ${idx === 0 ? 'active' : ''}" data-index="${idx}"></span>`;
                });
                carousel.innerHTML = carouselHtml;
                if (dots) dots.innerHTML = dotsHtml;
                carousel.removeEventListener('scroll', bannerScrollHandler);
                carousel.addEventListener('scroll', bannerScrollHandler);
            }

            function bannerScrollHandler() {
                const carousel = document.getElementById('bannerCarousel');
                const scrollPos = carousel.scrollLeft;
                const itemWidth = carousel.clientWidth * 0.9 + 10;
                const activeIndex = Math.round(scrollPos / itemWidth);
                document.querySelectorAll('.dot').forEach((d, i) => d.classList.toggle('active', i === activeIndex));
            }

            function renderProducts() {
                const grid = document.getElementById('productGrid');
                if (!grid) return;
                const filtered = getFilteredProducts();
                let html = '';
                filtered.forEach(prod => {
                    const discount = prod.originalPrice && prod.originalPrice > prod.price ? Math.round((1 - prod.price/prod.originalPrice)*100) : 0;
                    const hasBadge = prod.badgeImage || prod.badgeText;
                    const inStock = prod.stock > 0;
                    html += `<div class="product-card" data-product-id="${prod.id}">`;
                    html += `<div class="image-section">`;
                    html += `<img src="${prod.image}" class="product-image" onerror="this.src='https://placehold.co/400x400/eeeeee/aaaaaa?text=Product'" loading="lazy">`;
                    html += `<div class="product-badges">`;
                    if (prod.is_official_store) html += `<span class="badge official">Official Store</span>`;
                    if (prod.is_non_returnable) html += `<span class="badge nonreturn">Non-returnable</span>`;
                    if (inStock) html += `<span class="badge stock">In stock</span>`; else html += `<span class="badge outstock">Out of stock</span>`;
                    html += `</div>`;
                    if (hasBadge) {
                        html += `<div class="product-badge-bottom">`;
                        if (prod.badgeImage) html += `<img src="${prod.badgeImage}" alt="badge">`;
                        if (prod.badgeText) html += `<span>${prod.badgeText}</span>`;
                        html += `</div>`;
                    }
                    html += `</div>`;
                    html += `<div class="product-info">
                        <div class="product-name">${prod.name}</div>`;
                    if (prod.brand) html += `<div class="product-attributes"><span>${prod.brand}</span></div>`;
                    html += `<div class="price-discount">`;
                    if (discount > 0) {
                        html += `<span class="product-price">KSh ${prod.price.toLocaleString()}</span>
                            <span class="original-price">KSh ${prod.originalPrice.toLocaleString()}</span>
                            <span class="discount-badge">-${discount}%</span>`;
                    } else {
                        html += `<span class="product-price">KSh ${prod.price.toLocaleString()}</span>`;
                    }
                    html += `</div><div class="product-rating"><i class="fas fa-star"></i> ${prod.rating} (${prod.sold}+ sold)</div>`;
                    html += `<div class="stock-status ${inStock ? '' : 'out'}">${inStock ? 'In stock' : 'Out of stock'}</div>`;
                    html += `<button class="add-to-cart-btn" data-id="${prod.id}" ${!inStock ? 'disabled' : ''}><i class="fas fa-cart-plus"></i> Add to cart</button>`;
                    
                    if ((currentUserProfile?.role === 'admin') || (currentUserProfile?.role === 'seller' && prod.seller_id === currentUser?.id)) {
                        html += `<div class="admin-controls"><i class="fas fa-edit edit-btn" data-id="${prod.id}"></i><i class="fas fa-trash delete-btn" data-id="${prod.id}"></i></div>`;
                    }
                    html += `</div></div>`;
                });
                if (filtered.length === 0) html = '<div style="grid-column:span 2; text-align:center; padding:40px;">No products</div>';
                grid.innerHTML = html;

                const otherProducts = products.filter(p => !filtered.includes(p)).sort(() => 0.5 - Math.random()).slice(0, 4);
                const alsoList = document.getElementById('alsoViewedList');
                const alsoSection = document.getElementById('alsoViewedSection');
                if (otherProducts.length > 0) {
                    let alsoHtml = '';
                    otherProducts.forEach(p => {
                        alsoHtml += `<div class="also-item" data-product-id="${p.id}">
                            <img src="${p.image}" onerror="this.src='https://placehold.co/120x120'" loading="lazy">
                            <div class="name">${p.name}</div>
                            <div class="price">KSh ${p.price}</div>
                        </div>`;
                    });
                    if (alsoList) alsoList.innerHTML = alsoHtml;
                    if (alsoSection) alsoSection.style.display = 'block';
                } else {
                    if (alsoSection) alsoSection.style.display = 'none';
                }
            }

            function renderCartModal() {
                const itemsList = document.getElementById('cartItemsList');
                const totalSpan = document.getElementById('cartTotal');
                if (!itemsList) return;
                if (cart.length === 0) { itemsList.innerHTML = '<p style="text-align:center;color:#aaa;">Cart empty</p>'; if (totalSpan) totalSpan.innerText = 'Total: KSh 0'; return; }
                let itemsHtml = '', total = 0;
                cart.forEach(item => {
                    const prod = products.find(p => p.id === item.id);
                    if (!prod) return;
                    total += prod.price * item.quantity;
                    itemsHtml += `<div class="cart-item" data-id="${item.id}"><img src="${prod.image}" class="cart-item-img" loading="lazy"><div class="cart-item-details"><div class="cart-item-name">${prod.name}</div><div class="cart-item-price">KSh ${prod.price}</div><div class="cart-item-qty"><button class="cart-qty-minus" data-id="${item.id}">-</button><span>${item.quantity}</span><button class="cart-qty-plus" data-id="${item.id}">+</button><i class="fas fa-trash" style="margin-left:auto; color:#c0392b; cursor:pointer;" data-id="${item.id}" data-remove></i></div></div></div>`;
                });
                itemsList.innerHTML = itemsHtml;
                if (totalSpan) totalSpan.innerText = `Total: KSh ${total}`;
            }

            function renderNotifications() {
                const list = document.getElementById('notificationsList');
                if (list) list.innerHTML = '<p style="text-align:center; color:#aaa;">No notifications</p>';
            }

            function refreshUI() {
                renderCategories();
                renderBanners();
                renderProducts();
                updateCartCount();
                
                const adminBadge = document.getElementById('adminModeBadge');
                const sellerBadge = document.getElementById('sellerModeBadge');
                const addBtn = document.getElementById('addProductBtn');
                const logoutIcon = document.getElementById('logoutIcon');
                const sellNav = document.getElementById('sellNav');

                if (currentUserProfile?.role === 'admin') {
                    if (adminBadge) adminBadge.style.display = 'inline-flex';
                    if (sellerBadge) sellerBadge.style.display = 'none';
                    if (addBtn) addBtn.style.display = 'flex';
                } else if (currentUserProfile?.role === 'seller' && currentUserProfile.seller_status === 'approved') {
                    if (adminBadge) adminBadge.style.display = 'none';
                    if (sellerBadge) sellerBadge.style.display = 'inline-flex';
                    if (addBtn) addBtn.style.display = 'flex';
                } else {
                    if (adminBadge) adminBadge.style.display = 'none';
                    if (sellerBadge) sellerBadge.style.display = 'none';
                    if (addBtn) addBtn.style.display = 'none';
                }

                if (logoutIcon) logoutIcon.style.display = currentUser ? 'inline-block' : 'none';
                if (sellNav) sellNav.style.display = (currentUserProfile?.role === 'seller' && currentUserProfile.seller_status === 'approved') ? 'flex' : 'none';

                document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                if (activePromo) {
                    document.querySelector('[data-nav="promo"]')?.classList.add('active');
                } else {
                    document.querySelector('[data-nav="home"]')?.classList.add('active');
                }

                updateDeliveryDates();
            }

            function updateDeliveryDates() {
                const dates = getDeliveryDates();
                const doorStart = document.getElementById('doorStart');
                const doorEnd = document.getElementById('doorEnd');
                const doorTimer = document.getElementById('doorTimer');
                const pickupStart = document.getElementById('pickupStart');
                const pickupEnd = document.getElementById('pickupEnd');
                if (doorStart) doorStart.innerText = dates.doorStartStr;
                if (doorEnd) doorEnd.innerText = dates.doorEndStr;
                if (doorTimer) doorTimer.innerText = dates.timer;
                if (pickupStart) pickupStart.innerText = dates.pickupStartStr;
                if (pickupEnd) pickupEnd.innerText = dates.pickupEndStr;
            }

            async function signUp(email, password) {
                const { data, error } = await supabase.auth.signUp({ email, password });
                if (error) {
                    alert('Sign up error: ' + error.message);
                } else {
                    alert('Sign up successful! You can now log in.');
                    const authModal = document.getElementById('authModal');
                    if (authModal) authModal.style.display = 'none';
                }
            }

            async function signIn(email, password) {
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) {
                    alert('Login error: ' + error.message);
                } else {
                    currentUser = data.user;
                    currentUserProfile = await getOrCreateProfile(currentUser);
                    const authModal = document.getElementById('authModal');
                    if (authModal) authModal.style.display = 'none';
                    refreshUI();
                }
            }

            async function signOut() {
                await supabase.auth.signOut();
                currentUser = null;
                currentUserProfile = null;
                refreshUI();
                const profileModal = document.getElementById('profileModal');
                const sellerModal = document.getElementById('sellerDashboardModal');
                if (profileModal) profileModal.style.display = 'none';
                if (sellerModal) sellerModal.style.display = 'none';
            }

            document.getElementById('logoutIcon')?.addEventListener('click', signOut);

            // ========== ORDER FUNCTIONS ==========
            async function placeOrderWithDetails() {
                if (!currentUser) {
                    alert('Please login to place an order');
                    openAuthModal();
                    return;
                }
                if (cart.length === 0) {
                    alert('Cart is empty');
                    return;
                }
                document.querySelectorAll('.delivery-option').forEach(opt => opt.classList.remove('selected'));
                const door = document.getElementById('deliveryDoor');
                const pickup = document.getElementById('deliveryPickup');
                const addressField = document.getElementById('addressField');
                if (door) door.classList.add('selected');
                if (addressField) addressField.style.display = 'block';
                updateDeliveryDates();
                const checkoutModal = document.getElementById('checkoutDetailsModal');
                if (checkoutModal) checkoutModal.style.display = 'flex';
            }

            document.getElementById('deliveryDoor')?.addEventListener('click', () => {
                const door = document.getElementById('deliveryDoor');
                const pickup = document.getElementById('deliveryPickup');
                const addressField = document.getElementById('addressField');
                door.classList.add('selected');
                if (pickup) pickup.classList.remove('selected');
                if (addressField) addressField.style.display = 'block';
            });
            document.getElementById('deliveryPickup')?.addEventListener('click', () => {
                const door = document.getElementById('deliveryDoor');
                const pickup = document.getElementById('deliveryPickup');
                const addressField = document.getElementById('addressField');
                pickup.classList.add('selected');
                if (door) door.classList.remove('selected');
                if (addressField) addressField.style.display = 'none';
            });

            document.getElementById('checkoutConfirm')?.addEventListener('click', async () => {
                const name = document.getElementById('checkoutName')?.value.trim();
                const phone = document.getElementById('checkoutPhone')?.value.trim();
                let address = document.getElementById('checkoutAddress')?.value.trim() || '';
                const deliveryMethod = document.getElementById('deliveryDoor')?.classList.contains('selected') ? 'door' : 'pickup';
                if (deliveryMethod === 'door' && !address) {
                    alert('Please enter your shipping address');
                    return;
                }
                if (!name || !phone) {
                    alert('Please fill in name and phone');
                    return;
                }
                const paymentMethod = document.querySelector('input[name="payment"]:checked')?.value;
                if (!paymentMethod) {
                    alert('Please select payment method');
                    return;
                }

                let total = 0;
                const orderItems = cart.map(item => {
                    const prod = products.find(p => p.id === item.id);
                    total += prod.price * item.quantity;
                    return {
                        product_id: item.id,
                        quantity: item.quantity,
                        price: prod.price
                    };
                });

                const deliveryFee = deliveryMethod === 'door' ? parseInt(settings.delivery_fee) : 0;
                total += deliveryFee;

                const dates = getDeliveryDates();
                const estimatedStart = deliveryMethod === 'door' ? dates.doorStart : dates.pickupStart;
                const estimatedEnd = deliveryMethod === 'door' ? dates.doorEnd : dates.pickupEnd;

                const newOrder = {
                    user_id: currentUser.id,
                    user_email: currentUser.email,
                    shipping_name: name,
                    shipping_phone: phone,
                    shipping_address: deliveryMethod === 'door' ? address : 'Pickup at station',
                    notes: document.getElementById('checkoutNotes')?.value.trim() || '',
                    status: 'ordered',
                    total_amount: total,
                    payment_method: paymentMethod,
                    delivery_method: deliveryMethod,
                    delivery_fee: deliveryFee,
                    estimated_delivery_start: estimatedStart.toISOString().split('T')[0],
                    estimated_delivery_end: estimatedEnd.toISOString().split('T')[0],
                    created_at: new Date().toISOString(),
                    items: JSON.stringify(orderItems)
                };

                const { data, error } = await supabase.from('orders').insert([newOrder]).select();

                if (error) {
                    alert('Order failed: ' + error.message);
                } else {
                    // Decrease stock for each product
                    for (let item of orderItems) {
                        const prod = products.find(p => p.id === item.product_id);
                        if (prod) {
                            const newStock = prod.stock - item.quantity;
                            await supabase.from('products').update({ stock: newStock }).eq('id', item.product_id);
                        }
                    }

                    alert('Order placed successfully!');

                    const referrerId = localStorage.getItem('referrer');
                    if (referrerId) {
                        for (let item of orderItems) {
                            const prod = products.find(p => p.id === item.product_id);
                            if (prod && prod.commission_percent) {
                                const commissionAmount = Math.round(item.price * item.quantity * (prod.commission_percent || 0) / 100);
                                await supabase.from('referral_commissions').insert([{
                                    referrer_id: referrerId,
                                    order_id: data[0].id,
                                    product_id: item.product_id,
                                    amount: commissionAmount,
                                    status: 'pending'
                                }]);
                            }
                        }
                        localStorage.removeItem('referrer');
                    }

                    cart = [];
                    localStorage.setItem('cart', JSON.stringify(cart));
                    renderCartModal();
                    updateCartCount();
                    const checkoutModal = document.getElementById('checkoutDetailsModal');
                    const cartModal = document.getElementById('cartModal');
                    if (checkoutModal) checkoutModal.style.display = 'none';
                    if (cartModal) cartModal.style.display = 'none';
                }
            });

            document.getElementById('checkoutCancel')?.addEventListener('click', () => {
                const checkoutModal = document.getElementById('checkoutDetailsModal');
                if (checkoutModal) checkoutModal.style.display = 'none';
            });

            async function openReviewModal(orderId) {
                currentOrderIdForReview = orderId;
                const ratingInput = document.getElementById('reviewRating');
                const comment = document.getElementById('reviewComment');
                if (ratingInput) ratingInput.value = 0;
                stars.forEach(s => s.classList.remove('selected'));
                if (comment) comment.value = '';
                const modal = document.getElementById('reviewModal');
                if (modal) modal.style.display = 'flex';
            }

            document.getElementById('reviewSubmit')?.addEventListener('click', async () => {
                if (!currentUser) {
                    alert('You must be logged in');
                    return;
                }
                const rating = parseInt(document.getElementById('reviewRating')?.value || '0');
                if (rating < 1 || rating > 5) {
                    alert('Please select a rating');
                    return;
                }
                const comment = document.getElementById('reviewComment')?.value.trim();
                if (!comment) {
                    alert('Please enter a comment');
                    return;
                }

                const order = orders.find(o => o.id === currentOrderIdForReview);
                if (!order) return;
                const items = JSON.parse(order.items || '[]');
                const productId = items.length > 0 ? items[0].product_id : null;

                const { error } = await supabase.from('reviews').insert([{
                    user_id: currentUser.id,
                    order_id: currentOrderIdForReview,
                    product_id: productId,
                    rating,
                    comment
                }]);

                if (error) {
                    alert('Error submitting review: ' + error.message);
                } else {
                    alert('Review submitted! Thank you.');
                    const modal = document.getElementById('reviewModal');
                    if (modal) modal.style.display = 'none';
                }
            });

            document.getElementById('reviewCancel')?.addEventListener('click', () => {
                const modal = document.getElementById('reviewModal');
                if (modal) modal.style.display = 'none';
            });

            async function renderUserOrders() {
                if (!currentUser) return;
                const { data: userOrders, error } = await supabase
                    .from('orders')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });
                if (error) console.error(error);

                const { data: userReviews } = await supabase
                    .from('reviews')
                    .select('order_id')
                    .eq('user_id', currentUser.id);
                const reviewedOrderIds = new Set((userReviews || []).map(r => r.order_id));

                let html = '';
                if (userOrders && userOrders.length > 0) {
                    userOrders.forEach(order => {
                        const statusClass = `status-${order.status.replace('_', '-')}`;
                        const canReview = order.status === 'delivered' && !reviewedOrderIds.has(order.id);
                        const canReturn = order.status === 'delivered' && !returns.some(r => r.order_id === order.id);
                        const startDate = order.estimated_delivery_start ? new Date(order.estimated_delivery_start).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) : '';
                        const endDate = order.estimated_delivery_end ? new Date(order.estimated_delivery_end).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) : '';
                        html += `<div style="border-bottom:1px solid #eee; padding:10px 0;">
                            <div><strong>Order #${order.id.slice(-6)}</strong> <span class="status-badge ${statusClass}">${order.status}</span></div>
                            <div>Total: KSh ${order.total_amount} (incl. delivery)</div>
                            <div>Delivery: ${order.delivery_method === 'door' ? 'Door' : 'Pickup'}</div>
                            <div>Payment: ${order.payment_method}</div>
                            <div>Est. delivery: ${startDate} - ${endDate}</div>
                            <div>${new Date(order.created_at).toLocaleDateString()}</div>`;
                        if (canReview) {
                            html += `<button class="btn-save review-order-btn" data-order-id="${order.id}" style="margin-top:8px; padding:4px 12px; font-size:0.8rem;">Write a Review</button>`;
                        } else if (reviewedOrderIds.has(order.id)) {
                            html += `<div style="margin-top:8px; font-style:italic; color:#888;">✓ Review submitted</div>`;
                        }
                        if (canReturn) {
                            html += `<button class="btn-cancel return-order-btn" data-order-id="${order.id}" style="margin-top:8px; padding:4px 12px; font-size:0.8rem;">Request Return</button>`;
                        }
                        html += `</div>`;
                    });
                } else {
                    html = '<p>No orders yet.</p>';
                }
                const list = document.getElementById('userOrdersList');
                if (list) list.innerHTML = html;

                // Use event delegation on userOrdersList for dynamic buttons
                if (list) {
                    list.addEventListener('click', (e) => {
                        const reviewBtn = e.target.closest('.review-order-btn');
                        if (reviewBtn) {
                            const orderId = reviewBtn.dataset.orderId;
                            openReviewModal(orderId);
                        }
                        const returnBtn = e.target.closest('.return-order-btn');
                        if (returnBtn) {
                            const orderId = returnBtn.dataset.orderId;
                            openReturnRequestModal(orderId);
                        }
                    });
                }
            }

            // New return request modal (replaces prompt)
            async function openReturnRequestModal(orderId) {
                currentReturnOrderId = orderId;
                const modal = document.getElementById('returnRequestModal');
                if (modal) {
                    document.getElementById('returnReason').value = '';
                    modal.style.display = 'flex';
                }
            }

            document.getElementById('returnSubmit')?.addEventListener('click', async () => {
                const reason = document.getElementById('returnReason').value.trim();
                if (!reason) {
                    alert('Please enter a reason');
                    return;
                }
                const order = orders.find(o => o.id === currentReturnOrderId);
                if (!order) return;
                const items = JSON.parse(order.items || '[]');
                if (items.length === 0) return;
                const productId = items[0].product_id;
                const { error } = await supabase.from('returns').insert([{
                    order_id: currentReturnOrderId,
                    product_id: productId,
                    reason,
                    status: 'requested',
                    created_at: new Date().toISOString()
                }]);
                if (error) {
                    alert('Error: ' + error.message);
                } else {
                    alert('Return requested. Seller will review.');
                    document.getElementById('returnRequestModal').style.display = 'none';
                }
            });

            document.getElementById('returnCancel')?.addEventListener('click', () => {
                document.getElementById('returnRequestModal').style.display = 'none';
            });

            // ========== REFERRAL STATS ==========
            async function loadReferralStats() {
                if (!currentUser) return;
                const clicksSpan = document.getElementById('totalClicks');
                const convSpan = document.getElementById('totalConversions');
                const pendSpan = document.getElementById('pendingEarnings');
                const paidSpan = document.getElementById('paidEarnings');
                if (clicksSpan) {
                    const { data: clicks, error: clicksErr } = await supabase
                        .from('referral_clicks')
                        .select('id', { count: 'exact', head: false })
                        .eq('referrer_id', currentUser.id);
                    if (!clicksErr) clicksSpan.innerText = clicks.length || 0;
                }

                if (convSpan && pendSpan && paidSpan) {
                    const { data: commissions, error: commErr } = await supabase
                        .from('referral_commissions')
                        .select('amount, status')
                        .eq('referrer_id', currentUser.id);
                    if (!commErr && commissions) {
                        let pending = 0, paid = 0;
                        commissions.forEach(c => {
                            if (c.status === 'pending') pending += c.amount;
                            else if (c.status === 'paid') paid += c.amount;
                        });
                        pendSpan.innerText = pending;
                        paidSpan.innerText = paid;
                        convSpan.innerText = commissions.length;
                    }
                }
            }

            // ========== SELLER DASHBOARD ENHANCEMENTS ==========
            async function renderSellerDashboard(modal = false) {
                if (!currentUser || currentUserProfile?.role !== 'seller' || currentUserProfile.seller_status !== 'approved') return;

                const dashboardHtml = `
                    <div class="admin-tabs" style="margin-bottom: 16px;">
                        <div class="admin-tab active" data-seller-tab="products">My Products</div>
                        <div class="admin-tab" data-seller-tab="orders">Orders</div>
                        <div class="admin-tab" data-seller-tab="payouts">Payouts</div>
                        <div class="admin-tab" data-seller-tab="returns">Returns</div>
                    </div>
                    <div id="sellerProductsPane" class="tab-pane active"></div>
                    <div id="sellerOrdersPane" class="tab-pane"></div>
                    <div id="sellerPayoutsPane" class="tab-pane"></div>
                    <div id="sellerReturnsPane" class="tab-pane"></div>
                `;

                if (modal) {
                    const content = document.getElementById('sellerDashboardContent');
                    if (content) content.innerHTML = dashboardHtml;
                } else {
                    const dash = document.getElementById('sellerDashboard');
                    if (dash) dash.innerHTML = dashboardHtml;
                }

                await renderSellerProductsPane(modal);
                await renderSellerOrdersPane(modal);
                await renderSellerPayoutsPane(modal);
                await renderSellerReturnsPane(modal);

                // Tab switching using delegation on the parent container
                const parent = modal ? document.getElementById('sellerDashboardContent') : document.getElementById('sellerDashboard');
                if (parent) {
                    parent.addEventListener('click', (e) => {
                        const tab = e.target.closest('[data-seller-tab]');
                        if (!tab) return;
                        document.querySelectorAll('[data-seller-tab]').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        document.querySelectorAll('#sellerProductsPane, #sellerOrdersPane, #sellerPayoutsPane, #sellerReturnsPane').forEach(p => p.classList.remove('active'));
                        const target = tab.dataset.sellerTab;
                        if (target === 'products') document.getElementById('sellerProductsPane')?.classList.add('active');
                        if (target === 'orders') document.getElementById('sellerOrdersPane')?.classList.add('active');
                        if (target === 'payouts') document.getElementById('sellerPayoutsPane')?.classList.add('active');
                        if (target === 'returns') document.getElementById('sellerReturnsPane')?.classList.add('active');
                    });
                }
            }

            async function renderSellerProductsPane(modal) {
                const sellerProds = products.filter(p => p.seller_id === currentUser.id);
                let prodHtml = '';
                sellerProds.forEach(prod => {
                    prodHtml += `<div class="prod-list-item" data-prod-id="${prod.id}">
                        <img src="${prod.image}" style="width:30px; height:30px; border-radius:50%; object-fit:cover;">
                        <span>${prod.name} (KSh ${prod.price})</span>
                        <button class="edit-prod-btn" data-id="${prod.id}" style="margin-left:auto; background:none; border:none; color:var(--tokped-green);"><i class="fas fa-edit"></i></button>
                        <button class="delete-prod-btn" data-id="${prod.id}" style="background:none; border:none; color:#c0392b;"><i class="fas fa-trash"></i></button>
                    </div>`;
                });
                if (sellerProds.length === 0) prodHtml = '<p>You have no products yet.</p>';
                const pane = document.getElementById('sellerProductsPane');
                if (pane) pane.innerHTML = prodHtml;
            }

            async function renderSellerOrdersPane(modal) {
                let ordersHtml = '';
                for (let order of orders) {
                    const items = JSON.parse(order.items || '[]');
                    const sellerItems = items.filter(item => {
                        const prod = products.find(p => p.id === item.product_id);
                        return prod && prod.seller_id === currentUser.id;
                    });
                    if (sellerItems.length > 0) {
                        ordersHtml += `<div style="border-bottom:1px solid #eee; padding:10px 0;">
                            <div><strong>Order #${order.id.slice(-6)}</strong> <span class="status-badge status-${order.status.replace('_', '-')}">${order.status}</span></div>
                            <div>Customer: ${order.shipping_name}</div>
                            <div>Items: ${sellerItems.map(i => `${i.quantity}x ${products.find(p => p.id === i.product_id)?.name || 'Deleted product'}`).join(', ')}</div>
                        </div>`;
                    }
                }
                if (ordersHtml === '') ordersHtml = '<p>No orders for your products yet.</p>';
                const pane = document.getElementById('sellerOrdersPane');
                if (pane) pane.innerHTML = ordersHtml;
            }

            async function renderSellerPayoutsPane(modal) {
                let balance = 0;
                const sellerOrders = orders.filter(o => {
                    const items = JSON.parse(o.items || '[]');
                    return items.some(item => {
                        const prod = products.find(p => p.id === item.product_id);
                        return prod && prod.seller_id === currentUser.id;
                    });
                });
                sellerOrders.forEach(order => {
                    const items = JSON.parse(order.items || '[]');
                    items.forEach(item => {
                        const prod = products.find(p => p.id === item.product_id);
                        if (prod && prod.seller_id === currentUser.id) {
                            balance += prod.price * item.quantity;
                        }
                    });
                });
                // Subtract ALL payouts (paid + pending) to avoid double counting
                const allPayouts = payouts.filter(p => p.seller_id === currentUser.id);
                const totalPayouts = allPayouts.reduce((acc, p) => acc + p.amount, 0);
                balance -= totalPayouts;

                const myInstruments = paymentInstruments.filter(pi => pi.user_id === currentUser.id);
                let instrHtml = '';
                myInstruments.forEach(inst => {
                    instrHtml += `<div class="instrument-item" data-id="${inst.id}">
                        <div><strong>${inst.type === 'bank' ? '🏦 Bank' : '📱 M-Pesa'}</strong><br>${inst.type === 'bank' ? inst.details.account_name + ' - ' + inst.details.account_number : inst.details.phone}</div>
                        <div>${inst.verified ? '<span class="instrument-verified">✅ Verified</span>' : '<span style="color:orange;">⏳ Pending</span>'} <button class="delete-instrument-btn" data-id="${inst.id}" style="background:none; border:none; color:#c0392b;"><i class="fas fa-trash"></i></button></div>
                    </div>`;
                });
                if (myInstruments.length === 0) instrHtml = '<p>No payment instruments added.</p>';

                const addInstrumentForm = `
                    <div style="margin-top:16px; padding:12px; background:#f9f9f9; border-radius:12px;">
                        <h5>Add Payment Instrument</h5>
                        <select id="instrumentType" style="width:100%; padding:8px; margin-bottom:8px;">
                            <option value="bank">Bank Account</option>
                            <option value="mpesa">M-Pesa</option>
                        </select>
                        <div id="bankFields"><input type="text" id="bankAccountName" placeholder="Account Name" style="width:100%; margin-bottom:5px;"><input type="text" id="bankAccountNumber" placeholder="Account Number" style="width:100%; margin-bottom:5px;"><input type="text" id="bankCode" placeholder="Bank Code" style="width:100%;"></div>
                        <div id="mpesaFields" style="display:none;"><input type="text" id="mpesaPhone" placeholder="M-Pesa Phone" style="width:100%;"></div>
                        <button class="btn-save" id="addInstrumentBtn" style="margin-top:10px; width:100%;">Add Instrument</button>
                    </div>
                `;

                const myPayouts = payouts.filter(p => p.seller_id === currentUser.id).sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
                let historyHtml = '';
                myPayouts.forEach(p => {
                    historyHtml += `<div style="border-bottom:1px solid #ddd; padding:8px 0;"><div><strong>KSh ${p.amount}</strong> - ${p.status}</div><div>${new Date(p.created_at).toLocaleDateString()}</div></div>`;
                });
                if (myPayouts.length === 0) historyHtml = '<p>No payout history.</p>';

                const payoutPane = `
                    <div style="margin-bottom:16px;"><h4>Available Balance: KSh <span id="sellerBalance">${balance}</span></h4><button class="btn-save" id="requestPayoutBtn" ${balance < 100 ? 'disabled' : ''}>Request Payout</button></div>
                    <h4>Payment Instruments</h4><div id="instrumentList">${instrHtml}</div>${addInstrumentForm}
                    <h4>Payout History</h4><div id="payoutHistory">${historyHtml}</div>
                `;

                const pane = document.getElementById('sellerPayoutsPane');
                if (pane) pane.innerHTML = payoutPane;

                // Attach listeners for dynamic elements (delegation on pane)
                if (pane) {
                    pane.addEventListener('click', async (e) => {
                        if (e.target.closest('.delete-instrument-btn')) {
                            const id = e.target.closest('.delete-instrument-btn').dataset.id;
                            if (confirm('Delete this payment instrument?')) {
                                await supabase.from('payment_instruments').delete().eq('id', id);
                            }
                        }
                    });

                    // Toggle fields when instrument type changes
                    const typeSelect = document.getElementById('instrumentType');
                    if (typeSelect) {
                        typeSelect.addEventListener('change', (e) => {
                            document.getElementById('bankFields').style.display = e.target.value === 'bank' ? 'block' : 'none';
                            document.getElementById('mpesaFields').style.display = e.target.value === 'mpesa' ? 'block' : 'none';
                        });
                    }

                    document.getElementById('addInstrumentBtn')?.addEventListener('click', async () => {
                        const type = document.getElementById('instrumentType').value;
                        let details = {};
                        if (type === 'bank') {
                            const name = document.getElementById('bankAccountName').value.trim();
                            const acc = document.getElementById('bankAccountNumber').value.trim();
                            const code = document.getElementById('bankCode').value.trim();
                            if (!name || !acc) return alert('Please fill all fields');
                            details = { account_name: name, account_number: acc, bank_code: code };
                        } else {
                            const phone = document.getElementById('mpesaPhone').value.trim();
                            if (!phone) return alert('Please enter phone number');
                            details = { phone };
                        }
                        const { error } = await supabase.from('payment_instruments').insert([{
                            user_id: currentUser.id,
                            type,
                            details,
                            verified: false,
                            created_at: new Date().toISOString()
                        }]);
                        if (error) alert('Error: ' + error.message);
                        else {
                            alert('Instrument added, pending admin verification.');
                            document.getElementById('bankAccountName').value = '';
                            document.getElementById('bankAccountNumber').value = '';
                            document.getElementById('bankCode').value = '';
                            document.getElementById('mpesaPhone').value = '';
                        }
                    });

                    document.getElementById('requestPayoutBtn')?.addEventListener('click', async () => {
                        const verifiedInstruments = myInstruments.filter(i => i.verified);
                        if (verifiedInstruments.length === 0) {
                            alert('You need at least one verified payment instrument.');
                            return;
                        }
                        if (balance < 100) {
                            alert('Minimum payout amount is KSh 100');
                            return;
                        }
                        const instrument = verifiedInstruments[0];
                        const { error } = await supabase.from('payouts').insert([{
                            seller_id: currentUser.id,
                            amount: balance,
                            status: 'pending',
                            payment_instrument_id: instrument.id,
                            created_at: new Date().toISOString()
                        }]);
                        if (error) alert('Error: ' + error.message);
                        else alert('Payout requested. Admin will process.');
                    });
                }
            }

            async function renderSellerReturnsPane(modal) {
                const sellerProductIds = products.filter(p => p.seller_id === currentUser.id).map(p => p.id);
                const relevantReturns = returns.filter(r => sellerProductIds.includes(r.product_id));
                let returnsHtml = '';
                for (let ret of relevantReturns) {
                    const order = orders.find(o => o.id === ret.order_id);
                    const product = products.find(p => p.id === ret.product_id);
                    returnsHtml += `<div style="border-bottom:1px solid #eee; padding:10px 0;" data-return-id="${ret.id}">
                        <div><strong>Return #${ret.id.slice(-6)}</strong> - Status: ${ret.status}</div>
                        <div>Product: ${product?.name} (Order #${order?.id.slice(-6)})</div>
                        <div>Reason: ${ret.reason}</div>
                        ${ret.status === 'requested' ? `
                            <div style="margin-top:8px;">
                                <button class="btn-save accept-return-btn" data-id="${ret.id}" style="padding:4px 12px;">Accept & Refund</button>
                                <button class="btn-cancel reject-return-btn" data-id="${ret.id}" style="padding:4px 12px; margin-left:8px;">Reject & Raise Claim</button>
                            </div>
                        ` : ''}
                        ${ret.status === 'claim_raised' ? `<div>Claim raised - awaiting admin decision</div>` : ''}
                    </div>`;
                }
                if (relevantReturns.length === 0) returnsHtml = '<p>No returns for your products.</p>';

                const pane = document.getElementById('sellerReturnsPane');
                if (pane) pane.innerHTML = returnsHtml;

                // Use delegation for accept/reject buttons
                if (pane) {
                    pane.addEventListener('click', (e) => {
                        const acceptBtn = e.target.closest('.accept-return-btn');
                        if (acceptBtn) {
                            const returnId = acceptBtn.dataset.id;
                            acceptReturn(returnId);
                        }
                        const rejectBtn = e.target.closest('.reject-return-btn');
                        if (rejectBtn) {
                            const returnId = rejectBtn.dataset.id;
                            openClaimModal(returnId);
                        }
                    });
                }
            }

            async function acceptReturn(returnId) {
                await supabase.from('returns').update({ status: 'accepted', seller_decision: 'accept' }).eq('id', returnId);
                alert('Return accepted. Refund will be processed.');
            }

            // ========== CLAIM MODAL ==========
            async function openClaimModal(returnId) {
                let claimModal = document.getElementById('claimModal');
                if (!claimModal) {
                    claimModal = document.createElement('div');
                    claimModal.id = 'claimModal';
                    claimModal.className = 'modal';
                    claimModal.innerHTML = `
                        <div class="modal-card">
                            <h3>Raise a Claim (RAC)</h3>
                            <div class="modal-field"><label>Reason for claim</label><textarea id="claimReason" rows="3"></textarea></div>
                            <div class="modal-field"><label>Upload evidence images</label><input type="file" id="claimImages" multiple accept="image/*"><div id="imagePreview" class="claim-evidence"></div></div>
                            <div class="modal-actions"><button class="btn-cancel" id="claimCancel">Cancel</button><button class="btn-save" id="claimSubmit">Submit Claim</button></div>
                        </div>
                    `;
                    document.body.appendChild(claimModal);

                    document.getElementById('claimImages').addEventListener('change', function(e) {
                        const preview = document.getElementById('imagePreview');
                        preview.innerHTML = '';
                        for (let file of e.target.files) {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                const img = document.createElement('img');
                                img.src = e.target.result;
                                preview.appendChild(img);
                            };
                            reader.readAsDataURL(file);
                        }
                    });

                    document.getElementById('claimCancel').addEventListener('click', () => {
                        claimModal.style.display = 'none';
                    });
                }

                claimModal.dataset.returnId = returnId;
                claimModal.style.display = 'flex';

                document.getElementById('claimSubmit').onclick = async () => {
                    const reason = document.getElementById('claimReason').value.trim();
                    if (!reason) return alert('Please provide a reason');
                    const files = document.getElementById('claimImages').files;
                    if (files.length === 0) return alert('Please upload at least one image');

                    const imageUrls = [];
                    for (let file of files) {
                        const fileName = `${Date.now()}_${file.name}`;
                        const { data, error } = await supabase.storage.from('claim-evidence').upload(fileName, file);
                        if (error) {
                            alert('Upload failed: ' + error.message);
                            return;
                        }
                        const { publicURL } = supabase.storage.from('claim-evidence').getPublicUrl(fileName);
                        imageUrls.push(publicURL);
                    }

                    const returnId = claimModal.dataset.returnId;
                    await supabase.from('returns').update({ status: 'claim_raised', seller_decision: 'reject' }).eq('id', returnId);
                    await supabase.from('claims').insert([{
                        return_id: returnId,
                        seller_id: currentUser.id,
                        evidence_images: imageUrls,
                        reason,
                        status: 'pending',
                        created_at: new Date().toISOString()
                    }]);

                    alert('Claim submitted. Admin will review.');
                    claimModal.style.display = 'none';
                };
            }

            // ========== ADMIN DASHBOARD ENHANCEMENTS ==========
            function enhanceAdminModal() {
                const tabContainer = document.querySelector('.admin-tabs');
                if (!tabContainer) return;
                if (!document.querySelector('[data-tab="instruments"]')) {
                    tabContainer.innerHTML += `<div class="admin-tab" data-tab="instruments">Payment Instruments</div><div class="admin-tab" data-tab="claims">Claims</div>`;
                }
                const modalCard = document.querySelector('#adminModal .modal-card');
                if (!document.getElementById('tab-instruments')) {
                    const instrumentsPane = document.createElement('div');
                    instrumentsPane.id = 'tab-instruments';
                    instrumentsPane.className = 'tab-pane';
                    instrumentsPane.innerHTML = '<div id="instrumentsList"></div>';
                    modalCard.appendChild(instrumentsPane);
                }
                if (!document.getElementById('tab-claims')) {
                    const claimsPane = document.createElement('div');
                    claimsPane.id = 'tab-claims';
                    claimsPane.className = 'tab-pane';
                    claimsPane.innerHTML = '<div id="claimsList"></div>';
                    modalCard.appendChild(claimsPane);
                }
                // Use event delegation on admin modal for tabs
                const adminModal = document.getElementById('adminModal');
                if (adminModal) {
                    adminModal.addEventListener('click', async (e) => {
                        const tab = e.target.closest('.admin-tab');
                        if (!tab) return;
                        e.preventDefault();
                        document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
                        const tabName = tab.dataset.tab;
                        const pane = document.getElementById(`tab-${tabName}`);
                        if (pane) pane.classList.add('active');
                        if (tabName === 'instruments') await renderInstrumentsList();
                        if (tabName === 'claims') await renderClaimsList();
                        // other tabs handled by existing functions, but we can call them if needed
                    });
                }
            }

            async function renderInstrumentsList() {
                const listDiv = document.getElementById('instrumentsList');
                if (!listDiv) return;
                let html = '';
                paymentInstruments.forEach(inst => {
                    const user = profiles.find(p => p.user_id === inst.user_id);
                    html += `<div class="user-list-item"><div><strong>${user?.email || 'Unknown'}</strong> (${inst.type})</div><div>${inst.type === 'bank' ? inst.details.account_name + ' - ' + inst.details.account_number : inst.details.phone}</div><div>${inst.verified ? '✅ Verified' : '<button class="verify-instrument-btn" data-id="'+inst.id+'" style="background:green; color:white; border:none; padding:4px 8px; border-radius:4px;">Verify</button>'}</div></div>`;
                });
                listDiv.innerHTML = html;
                // Use delegation on listDiv for verify buttons
                listDiv.addEventListener('click', async (e) => {
                    const btn = e.target.closest('.verify-instrument-btn');
                    if (btn) {
                        const id = btn.dataset.id;
                        await supabase.from('payment_instruments').update({ verified: true }).eq('id', id);
                    }
                });
            }

            async function renderClaimsList() {
                const listDiv = document.getElementById('claimsList');
                if (!listDiv) return;
                let html = '';
                for (let claim of claims) {
                    const ret = returns.find(r => r.id === claim.return_id);
                    const seller = profiles.find(p => p.user_id === claim.seller_id);
                    html += `<div class="user-list-item" data-claim-id="${claim.id}">
                        <div><strong>Claim #${claim.id.slice(-6)}</strong> - ${claim.status}</div>
                        <div>Seller: ${seller?.email}</div>
                        <div>Reason: ${claim.reason}</div>
                        <div>Evidence: ${claim.evidence_images.map(url => `<img src="${url}" style="width:50px; height:50px; object-fit:cover; margin-right:5px;">`).join('')}</div>
                        ${claim.status === 'pending' ? `
                            <div style="margin-top:8px;">
                                <button class="approve-claim-btn" data-id="${claim.id}" style="background:green; color:white; border:none; padding:4px 8px;">Approve</button>
                                <button class="reject-claim-btn" data-id="${claim.id}" style="background:red; color:white; border:none; padding:4px 8px;">Reject</button>
                            </div>
                        ` : ''}
                    </div>`;
                }
                listDiv.innerHTML = html;
                // Use delegation
                listDiv.addEventListener('click', async (e) => {
                    const approveBtn = e.target.closest('.approve-claim-btn');
                    if (approveBtn) {
                        const id = approveBtn.dataset.id;
                        await supabase.from('claims').update({ status: 'approved' }).eq('id', id);
                    }
                    const rejectBtn = e.target.closest('.reject-claim-btn');
                    if (rejectBtn) {
                        const id = rejectBtn.dataset.id;
                        await supabase.from('claims').update({ status: 'rejected' }).eq('id', id);
                    }
                });
            }

            // ========== OTHER ADMIN FUNCTIONS (implemented) ==========
            async function renderCategoriesList() {
                const listDiv = document.getElementById('categoriesList');
                if (!listDiv) return;
                let html = '';
                categories.forEach(cat => {
                    html += `<div class="cat-list-item" data-cat-id="${cat.id}">
                        ${cat.image ? `<img src="${cat.image}">` : `<i class="fas ${cat.icon}"></i>`}
                        <span>${cat.name}</span>
                        <button class="edit-cat-btn" data-id="${cat.id}" style="margin-left:auto; background:none; border:none; color:var(--tokped-green);"><i class="fas fa-edit"></i></button>
                        <button class="delete-cat-btn" data-id="${cat.id}" style="background:none; border:none; color:#c0392b;"><i class="fas fa-trash"></i></button>
                    </div>`;
                });
                listDiv.innerHTML = html;
                // Use delegation
                listDiv.addEventListener('click', async (e) => {
                    const editBtn = e.target.closest('.edit-cat-btn');
                    if (editBtn) {
                        const id = editBtn.dataset.id;
                        const cat = categories.find(c => c.id === id);
                        if (cat) {
                            currentCategoryId = id;
                            document.getElementById('catNameInput').value = cat.name;
                            document.getElementById('catIconInput').value = cat.icon;
                            document.getElementById('catImageInput').value = cat.image || '';
                            document.getElementById('categoryEditModal').style.display = 'flex';
                        }
                    }
                    const deleteBtn = e.target.closest('.delete-cat-btn');
                    if (deleteBtn) {
                        const id = deleteBtn.dataset.id;
                        if (confirm('Delete category?')) {
                            await supabase.from('categories').delete().eq('id', id);
                        }
                    }
                });
            }

            async function renderBannersList() {
                const listDiv = document.getElementById('bannersList');
                if (!listDiv) return;
                let html = '';
                banners.forEach(banner => {
                    html += `<div class="banner-list-item" data-ban-id="${banner.id}">
                        <img src="${banner.image}" style="width:50px; height:30px; object-fit:cover; border-radius:4px;">
                        <span>${banner.title}</span>
                        <button class="edit-banner-btn" data-id="${banner.id}" style="margin-left:auto; background:none; border:none; color:var(--tokped-green);"><i class="fas fa-edit"></i></button>
                        <button class="delete-banner-btn" data-id="${banner.id}" style="background:none; border:none; color:#c0392b;"><i class="fas fa-trash"></i></button>
                    </div>`;
                });
                listDiv.innerHTML = html;
                listDiv.addEventListener('click', async (e) => {
                    const editBtn = e.target.closest('.edit-banner-btn');
                    if (editBtn) {
                        const id = editBtn.dataset.id;
                        const banner = banners.find(b => b.id === id);
                        if (banner) {
                            currentBannerId = id;
                            document.getElementById('bannerImageInput').value = banner.image;
                            document.getElementById('bannerLinkInput').value = banner.link || '';
                            document.getElementById('bannerTitleInput').value = banner.title;
                            document.getElementById('bannerEditModal').style.display = 'flex';
                        }
                    }
                    const deleteBtn = e.target.closest('.delete-banner-btn');
                    if (deleteBtn) {
                        const id = deleteBtn.dataset.id;
                        if (confirm('Delete banner?')) {
                            await supabase.from('banners').delete().eq('id', id);
                        }
                    }
                });
            }

            async function renderProductsList() {
                const listDiv = document.getElementById('productsList');
                if (!listDiv) return;
                let html = '';
                products.forEach(prod => {
                    html += `<div class="prod-list-item" data-prod-id="${prod.id}">
                        <img src="${prod.image}" style="width:30px; height:30px; border-radius:50%; object-fit:cover;">
                        <span>${prod.name} (KSh ${prod.price})</span>
                        <button class="edit-prod-admin-btn" data-id="${prod.id}" style="margin-left:auto; background:none; border:none; color:var(--tokped-green);"><i class="fas fa-edit"></i></button>
                        <button class="delete-prod-admin-btn" data-id="${prod.id}" style="background:none; border:none; color:#c0392b;"><i class="fas fa-trash"></i></button>
                    </div>`;
                });
                listDiv.innerHTML = html;
                listDiv.addEventListener('click', async (e) => {
                    const editBtn = e.target.closest('.edit-prod-admin-btn');
                    if (editBtn) {
                        const prodId = editBtn.dataset.id;
                        const prod = products.find(p => p.id === prodId);
                        if (prod) {
                            currentProductId = prodId;
                            // populate edit modal
                            document.getElementById('prodName').value = prod.name || '';
                            document.getElementById('prodBrand').value = prod.brand || '';
                            document.getElementById('prodColor').value = prod.color || '';
                            document.getElementById('prodSize').value = prod.size || '';
                            document.getElementById('prodPrice').value = prod.price || '';
                            document.getElementById('prodCost').value = prod.costPrice || '';
                            document.getElementById('prodOriginalPrice').value = prod.originalPrice || '';
                            document.getElementById('prodCommission').value = prod.commission_percent || 10;
                            document.getElementById('prodStock').value = prod.stock || 10;
                            document.getElementById('prodReturnPolicy').value = prod.return_policy || 'Free return within 7 days';
                            document.getElementById('prodOfficial').checked = prod.is_official_store || false;
                            document.getElementById('prodNonReturn').checked = prod.is_non_returnable || false;
                            document.getElementById('prodImage').value = prod.image || '';
                            document.getElementById('prodImages').value = (prod.images || []).join(', ');
                            document.getElementById('prodDescription').value = prod.description || '';
                            document.getElementById('prodAffiliateLink').value = prod.affiliate_link || '';
                            let catOptions = '';
                            categories.forEach(c => catOptions += `<option value="${c.id}" ${prod.category === c.id ? 'selected' : ''}>${c.name}</option>`);
                            document.getElementById('prodCategory').innerHTML = catOptions;
                            document.getElementById('prodRating').value = prod.rating || 4.5;
                            document.getElementById('prodSold').value = prod.sold || 0;
                            document.getElementById('prodBadgeImage').value = prod.badgeImage || '';
                            document.getElementById('prodBadgeText').value = prod.badgeText || '';
                            document.getElementById('productEditModal').style.display = 'flex';
                        }
                    }
                    const deleteBtn = e.target.closest('.delete-prod-admin-btn');
                    if (deleteBtn) {
                        const prodId = deleteBtn.dataset.id;
                        if (confirm('Delete product?')) {
                            await supabase.from('products').delete().eq('id', prodId);
                        }
                    }
                });
            }

            async function renderAdminOrders() {
                const listDiv = document.getElementById('adminOrdersList');
                if (!listDiv) return;
                let html = '';
                orders.forEach(order => {
                    const statusClass = `status-${order.status.replace('_', '-')}`;
                    html += `<div style="border-bottom:1px solid #eee; padding:10px 0;">
                        <div><strong>Order #${order.id.slice(-6)}</strong> <span class="status-badge ${statusClass}">${order.status}</span></div>
                        <div>Customer: ${order.shipping_name} (${order.shipping_phone})</div>
                        <div>Total: KSh ${order.total_amount}</div>
                        <div>Payment: ${order.payment_method} / Delivery: ${order.delivery_method}</div>
                        <select class="order-status-select" data-order-id="${order.id}" style="margin-top:8px; padding:4px;">
                            <option value="ordered" ${order.status === 'ordered' ? 'selected' : ''}>Ordered</option>
                            <option value="waiting_shipment" ${order.status === 'waiting_shipment' ? 'selected' : ''}>Waiting Shipment</option>
                            <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>Shipped</option>
                            <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                        </select>
                    </div>`;
                });
                listDiv.innerHTML = html;
                listDiv.addEventListener('change', async (e) => {
                    if (e.target.classList.contains('order-status-select')) {
                        const orderId = e.target.dataset.orderId;
                        const newStatus = e.target.value;
                        await supabase.from('orders').update({ status: newStatus }).eq('id', orderId);
                    }
                });
            }

            async function renderUsersList() {
                const listDiv = document.getElementById('usersList');
                if (!listDiv) return;
                let html = '';
                profiles.forEach(prof => {
                    html += `<div class="user-list-item" data-user-id="${prof.user_id}">
                        <div><strong>${prof.email}</strong> (role: ${prof.role}, seller: ${prof.seller_status || 'none'})</div>
                        <div style="display:flex; gap:8px; margin-top:4px;">
                            <button class="make-admin-btn" data-id="${prof.user_id}" style="background:none; border:1px solid var(--tokped-green); padding:4px 8px; border-radius:4px;">Make Admin</button>
                            ${prof.seller_status === 'pending' ? 
                                `<button class="approve-seller-btn" data-id="${prof.user_id}" style="background:green; color:white; border:none; padding:4px 8px; border-radius:4px;">Approve</button>
                                 <button class="reject-seller-btn" data-id="${prof.user_id}" style="background:red; color:white; border:none; padding:4px 8px; border-radius:4px;">Reject</button>` : ''}
                        </div>
                    </div>`;
                });
                listDiv.innerHTML = html;
                listDiv.addEventListener('click', async (e) => {
                    const makeAdminBtn = e.target.closest('.make-admin-btn');
                    if (makeAdminBtn) {
                        const userId = makeAdminBtn.dataset.id;
                        await supabase.from('profiles').update({ role: 'admin' }).eq('user_id', userId);
                    }
                    const approveBtn = e.target.closest('.approve-seller-btn');
                    if (approveBtn) {
                        const userId = approveBtn.dataset.id;
                        await supabase.from('profiles').update({ role: 'seller', seller_status: 'approved' }).eq('user_id', userId);
                    }
                    const rejectBtn = e.target.closest('.reject-seller-btn');
                    if (rejectBtn) {
                        const userId = rejectBtn.dataset.id;
                        await supabase.from('profiles').update({ seller_status: 'rejected' }).eq('user_id', userId);
                    }
                });
            }

            async function renderSellerApplications() {
                const listDiv = document.getElementById('sellerApplicationsList');
                if (!listDiv) return;
                const pending = profiles.filter(p => p.seller_status === 'pending');
                let html = '';
                pending.forEach(prof => {
                    html += `<div class="user-list-item" data-user-id="${prof.user_id}">
                        <div>${prof.email} applied to become seller.</div>
                        <div style="display:flex; gap:8px; margin-top:4px;">
                            <button class="approve-seller-btn" data-id="${prof.user_id}" style="background:green; color:white; border:none; padding:4px 8px; border-radius:4px;">Approve</button>
                            <button class="reject-seller-btn" data-id="${prof.user_id}" style="background:red; color:white; border:none; padding:4px 8px; border-radius:4px;">Reject</button>
                        </div>
                    </div>`;
                });
                if (pending.length === 0) html = '<p>No pending applications.</p>';
                listDiv.innerHTML = html;
                listDiv.addEventListener('click', async (e) => {
                    const approveBtn = e.target.closest('.approve-seller-btn');
                    if (approveBtn) {
                        const userId = approveBtn.dataset.id;
                        await supabase.from('profiles').update({ role: 'seller', seller_status: 'approved' }).eq('user_id', userId);
                    }
                    const rejectBtn = e.target.closest('.reject-seller-btn');
                    if (rejectBtn) {
                        const userId = rejectBtn.dataset.id;
                        await supabase.from('profiles').update({ seller_status: 'rejected' }).eq('user_id', userId);
                    }
                });
            }

            async function renderReviewsList() {
                const listDiv = document.getElementById('reviewsList');
                if (!listDiv) return;
                let html = '';
                reviews.forEach(rev => {
                    const user = profiles.find(p => p.user_id === rev.user_id);
                    html += `<div class="review-list-item" data-review-id="${rev.id}">
                        <div><strong>${user?.email || 'Unknown'}</strong> rated ${rev.rating} stars</div>
                        <div>${rev.comment}</div>
                        <div style="font-size:0.7rem; color:#999;">Order #${rev.order_id?.slice(-6)}</div>
                        <button class="delete-review-btn" data-id="${rev.id}" style="background:none; border:none; color:#c0392b; align-self:flex-end;"><i class="fas fa-trash"></i></button>
                    </div>`;
                });
                if (reviews.length === 0) html = '<p>No reviews yet.</p>';
                listDiv.innerHTML = html;
                listDiv.addEventListener('click', async (e) => {
                    const deleteBtn = e.target.closest('.delete-review-btn');
                    if (deleteBtn) {
                        const id = deleteBtn.dataset.id;
                        if (confirm('Delete review?')) {
                            await supabase.from('reviews').delete().eq('id', id);
                        }
                    }
                });
            }

            async function renderAnalytics() {
                const deliveredOrders = orders.filter(o => o.status === 'delivered');
                const revenue = deliveredOrders.reduce((acc, o) => acc + o.total_amount, 0);
                document.getElementById('totalRevenue').innerText = revenue;

                let profit = 0;
                deliveredOrders.forEach(order => {
                    const items = JSON.parse(order.items || '[]');
                    items.forEach(item => {
                        const prod = products.find(p => p.id === item.product_id);
                        if (prod && prod.costPrice) {
                            profit += (prod.price - prod.costPrice) * item.quantity;
                        }
                    });
                });
                document.getElementById('totalProfit').innerText = profit;

                const totalSold = deliveredOrders.reduce((acc, o) => {
                    const items = JSON.parse(o.items || '[]');
                    return acc + items.reduce((sum, i) => sum + i.quantity, 0);
                }, 0);
                document.getElementById('totalSold').innerText = totalSold;

                const pendingOrders = orders.filter(o => o.status === 'ordered').length;
                document.getElementById('ordersByStatus').innerText = pendingOrders;

                const statusCounts = orders.reduce((acc, o) => {
                    acc[o.status] = (acc[o.status] || 0) + 1;
                    return acc;
                }, {});
                let breakdownHtml = '';
                for (let [status, count] of Object.entries(statusCounts)) {
                    breakdownHtml += `<div>${status}: ${count}</div>`;
                }
                document.getElementById('statusBreakdown').innerHTML = breakdownHtml;
            }

            // ========== PRODUCT DETAIL ==========
            function openProductDetail(prodId) {
                const prod = products.find(p => p.id === prodId);
                if (!prod) return;
                document.getElementById('detailProductName').innerText = prod.name;
                document.getElementById('detailMainImage').src = prod.image;
                document.getElementById('detailDescription').innerText = prod.description || 'No description';
                document.getElementById('detailPrice').innerText = `KSh ${prod.price.toLocaleString()}`;
                if (prod.originalPrice && prod.originalPrice > prod.price) {
                    document.getElementById('detailOriginalPrice').innerText = `KSh ${prod.originalPrice.toLocaleString()}`;
                    const discount = Math.round((1 - prod.price/prod.originalPrice)*100);
                    document.getElementById('detailDiscount').innerText = `-${discount}%`;
                    document.getElementById('detailDiscount').style.display = 'inline-block';
                } else {
                    document.getElementById('detailOriginalPrice').innerText = '';
                    document.getElementById('detailDiscount').style.display = 'none';
                }
                document.getElementById('detailOfficial').style.display = prod.is_official_store ? 'inline-block' : 'none';
                document.getElementById('detailNonReturn').style.display = prod.is_non_returnable ? 'inline-block' : 'none';
                const inStock = prod.stock > 0;
                document.getElementById('detailInStock').style.display = inStock ? 'inline-block' : 'none';
                document.getElementById('detailOutStock').style.display = !inStock ? 'inline-block' : 'none';
                document.getElementById('detailStock').innerText = inStock ? `In stock (${prod.stock} available)` : 'Out of stock';
                document.getElementById('detailReturnPolicy').innerText = prod.return_policy || 'Free return within 7 days';

                // Attributes
                let attrHtml = '';
                if (prod.brand) attrHtml += `<span>Brand: ${prod.brand}</span>`;
                if (prod.color) attrHtml += `<span>Color: ${prod.color}</span>`;
                if (prod.size) attrHtml += `<span>Size: ${prod.size}</span>`;
                document.getElementById('detailAttributes').innerHTML = attrHtml;

                let galleryHtml = '';
                if (prod.images && Array.isArray(prod.images)) {
                    prod.images.forEach(img => {
                        galleryHtml += `<img src="${img}" class="gallery-image" onclick="document.getElementById('detailMainImage').src='${img}'" loading="lazy">`;
                    });
                }
                document.getElementById('detailGallery').innerHTML = galleryHtml;

                if (prod.affiliate_link) {
                    document.getElementById('affiliateLinkBtn').href = prod.affiliate_link;
                    document.getElementById('affiliateLinkBtn').style.display = 'flex';
                } else {
                    document.getElementById('affiliateLinkBtn').style.display = 'none';
                }

                if (currentUser) {
                    const refLink = `${window.location.origin}${window.location.pathname}?ref=${currentUser.id}&product=${prod.id}`;
                    document.getElementById('copyReferralLink').onclick = () => {
                        navigator.clipboard.writeText(refLink);
                        alert('Referral link copied to clipboard!');
                    };
                    document.getElementById('copyReferralLink').style.display = 'flex';
                } else {
                    document.getElementById('copyReferralLink').style.display = 'none';
                }

                document.getElementById('detailAddToCart').dataset.id = prodId;
                document.getElementById('detailAddToCart').disabled = !inStock;
                document.getElementById('productDetailModal').style.display = 'flex';
            }

            // ========== EVENT LISTENERS (using delegation where possible) ==========
            document.getElementById('categoryContainer')?.addEventListener('click', (e) => {
                const chip = e.target.closest('.chip');
                if (!chip) return;
                const catId = chip.dataset.catId;
                activeCategory = catId === 'all' ? null : catId;
                activePromo = false;
                renderCategories();
                renderProducts();
            });

            document.getElementById('productGrid')?.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-btn');
                if (editBtn) {
                    e.stopPropagation();
                    const prodId = editBtn.dataset.id;
                    const prod = products.find(p => p.id === prodId);
                    if (!prod) return;
                    if (currentUserProfile?.role !== 'admin' && prod.seller_id !== currentUser?.id) {
                        alert('You can only edit your own products.');
                        return;
                    }
                    currentProductId = prodId;
                    // populate edit modal
                    document.getElementById('prodName').value = prod.name || '';
                    document.getElementById('prodBrand').value = prod.brand || '';
                    document.getElementById('prodColor').value = prod.color || '';
                    document.getElementById('prodSize').value = prod.size || '';
                    document.getElementById('prodPrice').value = prod.price || '';
                    document.getElementById('prodCost').value = prod.costPrice || '';
                    document.getElementById('prodOriginalPrice').value = prod.originalPrice || '';
                    document.getElementById('prodCommission').value = prod.commission_percent || 10;
                    document.getElementById('prodStock').value = prod.stock || 10;
                    document.getElementById('prodReturnPolicy').value = prod.return_policy || 'Free return within 7 days';
                    document.getElementById('prodOfficial').checked = prod.is_official_store || false;
                    document.getElementById('prodNonReturn').checked = prod.is_non_returnable || false;
                    document.getElementById('prodImage').value = prod.image || '';
                    document.getElementById('prodImages').value = (prod.images || []).join(', ');
                    document.getElementById('prodDescription').value = prod.description || '';
                    document.getElementById('prodAffiliateLink').value = prod.affiliate_link || '';
                    let catOptions = '';
                    categories.forEach(c => catOptions += `<option value="${c.id}" ${prod.category === c.id ? 'selected' : ''}>${c.name}</option>`);
                    document.getElementById('prodCategory').innerHTML = catOptions;
                    document.getElementById('prodRating').value = prod.rating || 4.5;
                    document.getElementById('prodSold').value = prod.sold || 0;
                    document.getElementById('prodBadgeImage').value = prod.badgeImage || '';
                    document.getElementById('prodBadgeText').value = prod.badgeText || '';
                    document.getElementById('productEditModal').style.display = 'flex';
                    return;
                }

                const deleteBtn = e.target.closest('.delete-btn');
                if (deleteBtn) {
                    e.stopPropagation();
                    const prodId = deleteBtn.dataset.id;
                    const prod = products.find(p => p.id === prodId);
                    if (!prod) return;
                    if (currentUserProfile?.role !== 'admin' && prod.seller_id !== currentUser?.id) {
                        alert('You can only delete your own products.');
                        return;
                    }
                    if (confirm('Delete product?')) {
                        supabase.from('products').delete().eq('id', prodId);
                    }
                    return;
                }

                const addBtn = e.target.closest('.add-to-cart-btn');
                if (addBtn) {
                    e.stopPropagation();
                    const prodId = addBtn.dataset.id;
                    const prod = products.find(p => p.id === prodId);
                    if (prod.stock <= 0) {
                        alert('Out of stock');
                        return;
                    }
                    const existing = cart.find(item => item.id === prodId);
                    if (existing) existing.quantity++; else cart.push({ id: prodId, quantity: 1 });
                    localStorage.setItem('cart', JSON.stringify(cart));
                    renderCartModal();
                    updateCartCount();
                    return;
                }

                const card = e.target.closest('.product-card');
                if (card) {
                    const prodId = card.dataset.productId;
                    openProductDetail(prodId);
                }
            });

            document.getElementById('cartIcon')?.addEventListener('click', () => { renderCartModal(); document.getElementById('cartModal').style.display = 'flex'; });
            document.getElementById('closeCartBtn')?.addEventListener('click', () => { document.getElementById('cartModal').style.display = 'none'; });

            document.getElementById('cartItemsList')?.addEventListener('click', (e) => {
                const itemDiv = e.target.closest('.cart-item');
                if (!itemDiv) return;
                const prodId = itemDiv.dataset.id;
                const cartItem = cart.find(c => c.id === prodId);
                if (!cartItem) return;
                if (e.target.classList.contains('cart-qty-minus')) {
                    if (cartItem.quantity > 1) cartItem.quantity--; else cart = cart.filter(c => c.id !== prodId);
                    localStorage.setItem('cart', JSON.stringify(cart));
                    renderCartModal();
                } else if (e.target.classList.contains('cart-qty-plus')) {
                    cartItem.quantity++;
                    localStorage.setItem('cart', JSON.stringify(cart));
                    renderCartModal();
                } else if (e.target.classList.contains('fa-trash')) {
                    cart = cart.filter(c => c.id !== prodId);
                    localStorage.setItem('cart', JSON.stringify(cart));
                    renderCartModal();
                }
            });

            document.getElementById('cartWhatsappBtn')?.addEventListener('click', () => {
                if (cart.length === 0) return alert('Cart empty');
                let msg = 'Hello, I want to order:%0A';
                let total = 0;
                cart.forEach(item => {
                    const prod = products.find(p => p.id === item.id);
                    if (prod) { msg += `- ${prod.name} x${item.quantity} = KSh ${prod.price * item.quantity}%0A`; total += prod.price * item.quantity; }
                });
                msg += `Total: KSh ${total}%0AThank you.`;
                window.open(`https://wa.me/${settings.wa_number}?text=${msg}`, '_blank');
            });

            document.getElementById('checkoutBtn')?.addEventListener('click', placeOrderWithDetails);

            document.getElementById('adminModeBadge')?.addEventListener('click', async () => {
                if (currentUserProfile?.role !== 'admin') return;
                enhanceAdminModal();
                await renderCategoriesList();
                await renderBannersList();
                await renderProductsList();
                await renderAdminOrders();
                await renderUsersList();
                await renderSellerApplications();
                await renderReviewsList();
                await renderAnalytics();
                await renderInstrumentsList();
                await renderClaimsList();
                document.getElementById('adminModal').style.display = 'flex';
            });
            document.getElementById('closeAdminModal')?.addEventListener('click', () => { document.getElementById('adminModal').style.display = 'none'; });

            document.getElementById('addProductBtn')?.addEventListener('click', () => {
                if (!currentUser || (currentUserProfile?.role !== 'admin' && currentUserProfile?.role !== 'seller')) {
                    alert('You do not have permission to add products.');
                    return;
                }
                currentProductId = null;
                document.getElementById('prodName').value = '';
                document.getElementById('prodBrand').value = '';
                document.getElementById('prodColor').value = '';
                document.getElementById('prodSize').value = '';
                document.getElementById('prodPrice').value = '';
                document.getElementById('prodCost').value = '';
                document.getElementById('prodOriginalPrice').value = '';
                document.getElementById('prodCommission').value = '10';
                document.getElementById('prodStock').value = '10';
                document.getElementById('prodReturnPolicy').value = 'Free return within 7 days';
                document.getElementById('prodOfficial').checked = false;
                document.getElementById('prodNonReturn').checked = false;
                document.getElementById('prodImage').value = '';
                document.getElementById('prodImages').value = '';
                document.getElementById('prodDescription').value = '';
                document.getElementById('prodAffiliateLink').value = '';
                let catOptions = '';
                categories.forEach(c => catOptions += `<option value="${c.id}">${c.name}</option>`);
                document.getElementById('prodCategory').innerHTML = catOptions;
                if (document.getElementById('prodCategory').options.length > 0) document.getElementById('prodCategory').selectedIndex = 0;
                document.getElementById('prodRating').value = '4.5';
                document.getElementById('prodSold').value = '0';
                document.getElementById('prodBadgeImage').value = '';
                document.getElementById('prodBadgeText').value = '';
                document.getElementById('productEditModal').style.display = 'flex';
            });

            document.getElementById('productModalSave')?.addEventListener('click', async () => {
                const name = document.getElementById('prodName').value.trim();
                const price = parseFloat(document.getElementById('prodPrice').value);
                if (!name || isNaN(price)) return alert('Name and price required');
                const imagesArray = document.getElementById('prodImages').value.split(',').map(s => s.trim()).filter(s => s);
                const sellerId = (currentUserProfile?.role === 'seller' && currentUserProfile.seller_status === 'approved') ? currentUser.id : null;
                const productData = {
                    name,
                    brand: document.getElementById('prodBrand').value.trim() || null,
                    color: document.getElementById('prodColor').value.trim() || null,
                    size: document.getElementById('prodSize').value.trim() || null,
                    price,
                    costPrice: parseFloat(document.getElementById('prodCost').value) || undefined,
                    originalPrice: parseFloat(document.getElementById('prodOriginalPrice').value) || undefined,
                    commission_percent: parseInt(document.getElementById('prodCommission').value) || 10,
                    stock: parseInt(document.getElementById('prodStock').value) || 10,
                    return_policy: document.getElementById('prodReturnPolicy').value.trim() || 'Free return within 7 days',
                    is_official_store: document.getElementById('prodOfficial').checked,
                    is_non_returnable: document.getElementById('prodNonReturn').checked,
                    image: document.getElementById('prodImage').value.trim() || 'https://placehold.co/400x400/03ac0e/white?text=Product',
                    images: imagesArray,
                    description: document.getElementById('prodDescription').value.trim(),
                    affiliate_link: document.getElementById('prodAffiliateLink').value.trim() || undefined,
                    category: document.getElementById('prodCategory').value,
                    rating: parseFloat(document.getElementById('prodRating').value) || 4.5,
                    sold: parseInt(document.getElementById('prodSold').value) || 0,
                    badgeImage: document.getElementById('prodBadgeImage').value.trim() || '',
                    badgeText: document.getElementById('prodBadgeText').value.trim() || '',
                    seller_id: sellerId
                };
                if (currentProductId) {
                    const { error } = await supabase.from('products').update(productData).eq('id', currentProductId);
                    if (error) alert('Update error: ' + error.message);
                } else {
                    const newId = 'prod_' + Date.now() + Math.random().toString(36).substr(2, 4);
                    const { error } = await supabase.from('products').insert([{ id: newId, ...productData }]);
                    if (error) alert('Insert error: ' + error.message);
                }
                document.getElementById('productEditModal').style.display = 'none';
            });
            document.getElementById('productModalCancel')?.addEventListener('click', () => { document.getElementById('productEditModal').style.display = 'none'; });

            // Category modal save/cancel
            document.getElementById('catModalSave')?.addEventListener('click', async () => {
                const name = document.getElementById('catNameInput').value.trim();
                const icon = document.getElementById('catIconInput').value.trim();
                const image = document.getElementById('catImageInput').value.trim();
                if (!name) return alert('Category name required');
                const catData = {
                    name,
                    icon: icon || 'fa-tag',
                    image: image || ''
                };
                if (currentCategoryId) {
                    await supabase.from('categories').update(catData).eq('id', currentCategoryId);
                } else {
                    const newId = 'cat_' + Date.now() + Math.random().toString(36).substr(2, 4);
                    await supabase.from('categories').insert([{ id: newId, ...catData }]);
                }
                document.getElementById('categoryEditModal').style.display = 'none';
            });
            document.getElementById('catModalCancel')?.addEventListener('click', () => { document.getElementById('categoryEditModal').style.display = 'none'; });

            // Banner modal
            document.getElementById('bannerModalSave')?.addEventListener('click', async () => {
                const image = document.getElementById('bannerImageInput').value.trim();
                const link = document.getElementById('bannerLinkInput').value.trim();
                const title = document.getElementById('bannerTitleInput').value.trim();
                if (!image || !title) return alert('Image and title required');
                const bannerData = { image, link, title };
                if (currentBannerId) {
                    await supabase.from('banners').update(bannerData).eq('id', currentBannerId);
                } else {
                    const newId = 'ban_' + Date.now() + Math.random().toString(36).substr(2, 4);
                    await supabase.from('banners').insert([{ id: newId, ...bannerData }]);
                }
                document.getElementById('bannerEditModal').style.display = 'none';
            });
            document.getElementById('bannerModalCancel')?.addEventListener('click', () => { document.getElementById('bannerEditModal').style.display = 'none'; });

            document.getElementById('searchInput')?.addEventListener('input', (e) => {
                if (searchTimeout) clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    searchTerm = e.target.value;
                    renderProducts();
                }, 300);
            });

            document.getElementById('saveSettingsBtn')?.addEventListener('click', async () => {
                const newWa = document.getElementById('waNumberInput').value.trim();
                const newFee = document.getElementById('deliveryFeeInput').value.trim();
                const newStations = document.getElementById('pickupStationsInput').value.trim();
                if (!newWa || !newFee || !newStations) return alert('All fields required');
                await supabase.from('settings').upsert([
                    { key: 'wa_number', value: newWa },
                    { key: 'delivery_fee', value: newFee },
                    { key: 'pickup_stations', value: newStations }
                ], { onConflict: 'key' });
                settings.wa_number = newWa;
                settings.delivery_fee = newFee;
                settings.pickup_stations = newStations;
                document.getElementById('deliveryFeeDisplay').innerText = newFee;
                alert('Settings updated');
            });

            document.getElementById('notifIcon')?.addEventListener('click', () => {
                renderNotifications();
                document.getElementById('notifModal').style.display = 'flex';
            });
            document.getElementById('closeNotifBtn')?.addEventListener('click', () => { document.getElementById('notifModal').style.display = 'none'; });

            // Auth
            function openAuthModal() {
                const authModal = document.getElementById('authModal');
                if (authModal) {
                    authModal.style.display = 'flex';
                    document.getElementById('authModalTitle').innerText = 'Login';
                    document.getElementById('authLoginBtn').innerText = 'Login';
                }
            }

            document.getElementById('authCancel')?.addEventListener('click', () => { document.getElementById('authModal').style.display = 'none'; });
            document.getElementById('showSignup')?.addEventListener('click', (e) => {
                e.preventDefault();
                const title = document.getElementById('authModalTitle');
                const btn = document.getElementById('authLoginBtn');
                if (title.innerText === 'Login') {
                    title.innerText = 'Sign Up';
                    btn.innerText = 'Sign Up';
                } else {
                    title.innerText = 'Login';
                    btn.innerText = 'Login';
                }
            });

            document.getElementById('authLoginBtn')?.addEventListener('click', async () => {
                const email = document.getElementById('authEmail').value.trim();
                const password = document.getElementById('authPassword').value.trim();
                if (!email || !password) return alert('Email and password required');
                if (document.getElementById('authModalTitle').innerText === 'Login') {
                    await signIn(email, password);
                } else {
                    await signUp(email, password);
                }
            });

            async function openProfileModal() {
                if (!currentUser) {
                    openAuthModal();
                    return;
                }
                document.getElementById('profileEmail').innerText = currentUser.email;
                document.getElementById('profileRole').innerText = currentUserProfile?.role || 'customer';
                
                const reqSection = document.getElementById('sellerRequestSection');
                if (reqSection) {
                    reqSection.innerHTML = '';
                    if (currentUserProfile?.role === 'customer' && !currentUserProfile.seller_status) {
                        reqSection.innerHTML = '<button class="btn-save" id="applySellerBtn" style="width:100%; margin:10px 0;">Become a Seller</button>';
                        document.getElementById('applySellerBtn')?.addEventListener('click', () => {
                            document.getElementById('sellerApplyModal').style.display = 'flex';
                        });
                    } else if (currentUserProfile?.seller_status === 'pending') {
                        reqSection.innerHTML = '<p style="color:orange;">Seller application pending approval.</p>';
                    } else if (currentUserProfile?.seller_status === 'rejected') {
                        reqSection.innerHTML = '<p style="color:red;">Seller application rejected. Contact admin.</p>';
                    }
                }

                await renderUserOrders();
                await loadReferralStats();

                if (currentUserProfile?.role === 'seller' && currentUserProfile.seller_status === 'approved') {
                    await renderSellerDashboard(false);
                    document.getElementById('sellerDashboard').style.display = 'block';
                } else {
                    document.getElementById('sellerDashboard').style.display = 'none';
                }

                document.getElementById('profileModal').style.display = 'flex';
            }

            document.getElementById('logoutBtn')?.addEventListener('click', signOut);
            document.getElementById('closeProfileBtn')?.addEventListener('click', () => { document.getElementById('profileModal').style.display = 'none'; });

            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const nav = item.dataset.nav;
                    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                    item.classList.add('active');

                    switch (nav) {
                        case 'home':
                            activeCategory = null;
                            activePromo = false;
                            searchTerm = '';
                            document.getElementById('searchInput').value = '';
                            renderCategories();
                            renderProducts();
                            break;
                        case 'promo':
                            activeCategory = null;
                            activePromo = true;
                            renderCategories();
                            renderProducts();
                            break;
                        case 'sell':
                            if (currentUserProfile?.role === 'seller' && currentUserProfile.seller_status === 'approved') {
                                renderSellerDashboard(true);
                                document.getElementById('sellerDashboardModal').style.display = 'flex';
                            }
                            break;
                        case 'orders':
                            renderCartModal();
                            document.getElementById('cartModal').style.display = 'flex';
                            break;
                        case 'notif':
                            renderNotifications();
                            document.getElementById('notifModal').style.display = 'flex';
                            break;
                        case 'me':
                            openProfileModal();
                            break;
                    }
                });
            });

            document.getElementById('alsoViewedList')?.addEventListener('click', (e) => {
                const item = e.target.closest('.also-item');
                if (!item) return;
                const prodId = item.dataset.productId;
                openProductDetail(prodId);
            });

            document.getElementById('closeSellerModal')?.addEventListener('click', () => { document.getElementById('sellerDashboardModal').style.display = 'none'; });

            document.getElementById('sellerApplyConfirm')?.addEventListener('click', async () => {
                if (!currentUser) return;
                const { error } = await supabase
                    .from('profiles')
                    .update({ seller_status: 'pending' })
                    .eq('user_id', currentUser.id);
                if (error) {
                    alert('Error: ' + error.message);
                } else {
                    alert('Application submitted! Admin will review.');
                    document.getElementById('sellerApplyModal').style.display = 'none';
                    currentUserProfile.seller_status = 'pending';
                    refreshUI();
                }
            });
            document.getElementById('sellerApplyCancel')?.addEventListener('click', () => { document.getElementById('sellerApplyModal').style.display = 'none'; });

            // Close detail modal
            document.getElementById('closeDetailBtn')?.addEventListener('click', () => {
                document.getElementById('productDetailModal').style.display = 'none';
            });
            // Also close when clicking outside modal (optional)
            window.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
            });

            // Add category and banner buttons
            document.getElementById('addCategoryBtn')?.addEventListener('click', () => {
                currentCategoryId = null;
                document.getElementById('catNameInput').value = '';
                document.getElementById('catIconInput').value = '';
                document.getElementById('catImageInput').value = '';
                document.getElementById('categoryEditModal').style.display = 'flex';
            });
            document.getElementById('addBannerBtn')?.addEventListener('click', () => {
                currentBannerId = null;
                document.getElementById('bannerImageInput').value = '';
                document.getElementById('bannerLinkInput').value = '';
                document.getElementById('bannerTitleInput').value = '';
                document.getElementById('bannerEditModal').style.display = 'flex';
            });

            // ========== INITIAL LOAD ==========
            await loadAllData();
            setupSubscriptions();
            updateCartCount();
        })();
    </script>
</body>
</html>
