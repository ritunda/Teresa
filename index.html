<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Teresa · marketplace with payments & delivery</title>
    <!-- SEO meta tags -->
    <meta name="description" content="Teresa – your everyday style and gadgets. Shop the latest trends in beauty, electronics, and accessories.">
    <meta name="keywords" content="Teresa, online shop, gadgets, beauty, earrings, nose ring, Kenya">
    <meta name="author" content="Teresa">
    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://yourdomain.com">
    <meta property="og:title" content="Teresa · style & gadgets">
    <meta property="og:description" content="Your everyday style and gadgets. Shop now!">
    <meta property="og:image" content="https://placehold.co/1200x630/03ac0e/white?text=Teresa">
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://yourdomain.com">
    <meta property="twitter:title" content="Teresa · style & gadgets">
    <meta property="twitter:description" content="Your everyday style and gadgets. Shop now!">
    <meta property="twitter:image" content="https://placehold.co/1200x630/03ac0e/white?text=Teresa">
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Supabase JS client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Cstyle%3E.accent-icon%7Bstroke:%23C72A4C;stroke-width:8;fill:none;stroke-linecap:round;stroke-linejoin:round;%7D%3C/style%3E%3Cpath class='accent-icon' d='M70 50 L100 30 L130 70 L115 130 L85 130 L70 70 L70 50'/%3E%3Ccircle cx='100' cy='55' r='12' fill='%23C72A4C' opacity='0.9'/%3E%3C/svg%3E">
    <style>
        /* (Keep all existing styles – same as before) */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
        body {
            background-color: #f1f3f4;
        }
        :root {
            --tokped-green: #03ac0e;
            --tokped-green-light: #e6f7e6;
            --tokped-border: #e0e0e0;
            --tokped-text: #212121;
            --tokped-price: #03ac0e;
            --brand-magenta: #C72A4C;
        }
        .app {
            max-width: 500px;
            margin: 0 auto;
            background-color: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            position: relative;
            padding-bottom: 70px;
        }
        .header {
            background-color: white;
            padding: 12px 16px 8px;
            border-bottom: 1px solid var(--tokped-border);
            position: sticky;
            top: 0;
            z-index: 15;
        }
        .top-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .logo-area svg {
            display: block;
            height: 45px;
            width: auto;
        }
        .action-icons {
            display: flex;
            gap: 18px;
            color: #424242;
            align-items: center;
        }
        .action-icons i {
            font-size: 1.3rem;
            cursor: pointer;
        }
        .cart-icon {
            position: relative;
        }
        #cartCount {
            position: absolute;
            top: -8px;
            right: -10px;
            background: #e53935;
            color: white;
            font-size: 0.65rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 30px;
            min-width: 18px;
            text-align: center;
        }
        .search-bar {
            display: flex;
            background-color: #f1f3f4;
            border-radius: 8px;
            padding: 10px 16px;
            align-items: center;
            gap: 8px;
        }
        .search-bar i {
            font-size: 1rem;
            color: #9e9e9e;
        }
        .search-bar input {
            border: none;
            background: transparent;
            flex: 1;
            outline: none;
            font-size: 0.95rem;
        }
        .express-banner {
            background: linear-gradient(135deg, #f9a825, #f57c00);
            color: white;
            padding: 12px 16px;
            margin: 8px 16px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }
        .express-banner i {
            font-size: 1.8rem;
        }
        .express-banner div {
            flex: 1;
        }
        .express-banner .small {
            font-size: 0.8rem;
            opacity: 0.9;
        }
        .banner-carousel {
            margin: 12px 16px;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            display: flex;
            gap: 10px;
            scrollbar-width: none;
            border-radius: 16px;
        }
        .banner-carousel::-webkit-scrollbar { display: none; }
        .banner-item {
            flex: 0 0 90%;
            scroll-snap-align: start;
            background: #e0e0e0;
            border-radius: 16px;
            height: 130px;
            background-size: cover;
            background-position: center;
            position: relative;
        }
        .banner-item a {
            display: block;
            width: 100%;
            height: 100%;
            text-decoration: none;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            padding: 16px;
            font-weight: bold;
            font-size: 1.2rem;
            background: rgba(0,0,0,0.2);
            border-radius: 16px;
        }
        .banner-dots {
            display: flex;
            justify-content: center;
            gap: 6px;
            margin: 4px 0 8px;
        }
        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ccc;
        }
        .dot.active { background: var(--tokped-green); }
        .categories {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 8px 16px 12px;
            white-space: nowrap;
            scrollbar-width: none;
            border-bottom: 1px solid var(--tokped-border);
        }
        .categories::-webkit-scrollbar { display: none; }
        .chip {
            background-color: #f1f3f4;
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 0.85rem;
            font-weight: 500;
            color: #3c3c3c;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: 0.1s;
        }
        .chip img {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            object-fit: cover;
        }
        .chip i {
            color: var(--tokped-green);
        }
        .chip.active {
            background-color: var(--tokped-green);
            color: white;
        }
        .chip.active i { color: white; }
        .admin-bar {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding: 10px 16px 0;
            gap: 8px;
        }
        .admin-badge {
            background: #fdecea;
            color: #b85c5c;
            font-size: 0.7rem;
            padding: 4px 12px;
            border-radius: 30px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }
        .seller-badge {
            background: #f39c12;
            color: white;
            font-size: 0.7rem;
            padding: 4px 12px;
            border-radius: 30px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }
        .product-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            padding: 16px;
        }
        .product-card {
            background: white;
            border-radius: 16px;
            border: 1px solid var(--tokped-border);
            overflow: hidden;
            position: relative;
            box-shadow: 0 2px 6px rgba(0,0,0,0.02);
        }
        .image-section {
            position: relative;
            width: 100%;
            aspect-ratio: 1/1;
            background-color: #f7f7f7;
            border-bottom: 1px solid #eee;
        }
        .product-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .product-badges {
            position: absolute;
            top: 8px;
            left: 8px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .badge {
            background: rgba(0,0,0,0.7);
            color: white;
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 4px;
            display: inline-block;
        }
        .badge.official {
            background: #1e88e5;
        }
        .badge.nonreturn {
            background: #e53935;
        }
        .badge.stock {
            background: #43a047;
        }
        .badge.outstock {
            background: #757575;
        }
        .product-badge-bottom {
            display: flex;
            align-items: center;
            background: #fef7e6;
            padding: 4px 8px;
            border-bottom: 1px solid #ffecd1;
            gap: 6px;
            font-size: 0.7rem;
            color: #a86800;
            min-height: 32px;
        }
        .product-badge-bottom img {
            height: 20px;
            width: auto;
            max-width: 60px;
            object-fit: contain;
        }
        .product-badge-bottom span {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .product-info {
            padding: 10px 8px 12px;
        }
        .product-name {
            font-weight: 600;
            font-size: 0.9rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            min-height: 2.4rem;
        }
        .price-discount {
            display: flex;
            align-items: baseline;
            gap: 6px;
            flex-wrap: wrap;
            margin: 5px 0 4px;
        }
        .product-price {
            font-weight: 700;
            font-size: 1rem;
            color: var(--tokped-price);
        }
        .original-price {
            font-size: 0.75rem;
            color: #9e9e9e;
            text-decoration: line-through;
        }
        .discount-badge {
            background: #ff5722;
            color: white;
            font-size: 0.65rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 30px;
        }
        .product-rating {
            font-size: 0.7rem;
            color: #757575;
            display: flex;
            align-items: center;
            gap: 4px;
            margin-bottom: 8px;
        }
        .product-rating i { color: #f9a825; }
        .stock-status {
            font-size: 0.7rem;
            color: #43a047;
            margin-bottom: 8px;
        }
        .stock-status.out {
            color: #e53935;
        }
        .add-to-cart-btn {
            background: var(--tokped-green);
            border: none;
            color: white;
            padding: 8px 0;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            cursor: pointer;
            width: 100%;
            border: 1px solid #02940c;
        }
        .add-to-cart-btn:disabled {
            background: #ccc;
            border-color: #aaa;
            cursor: not-allowed;
        }
        .affiliate-btn {
            background: #f39c12;
            border: none;
            color: white;
            padding: 8px 0;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            cursor: pointer;
            width: 100%;
            border: 1px solid #e67e22;
            margin-top: 8px;
            text-decoration: none;
        }
        .btn-copy-link {
            background: #3498db;
            border: none;
            color: white;
            padding: 8px 0;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            cursor: pointer;
            width: 100%;
            border: 1px solid #2980b9;
            margin-top: 8px;
        }
        .admin-controls {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 8px;
            border-top: 1px dashed #ddd;
            padding-top: 6px;
        }
        .admin-controls i {
            font-size: 1rem;
            padding: 6px;
            border-radius: 50%;
            background: #f1f1f1;
            cursor: pointer;
        }
        .admin-controls .fa-edit { color: #2c3e50; }
        .admin-controls .fa-trash { color: #c0392b; }
        .btn-add-product {
            background: white;
            border: 1px dashed var(--tokped-green);
            color: var(--tokped-green);
            padding: 14px;
            margin: 0 16px 16px;
            border-radius: 60px;
            width: calc(100% - 32px);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            max-width: 500px;
            margin: 0 auto;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 10px 0 12px;
            border-top: 1px solid var(--tokped-border);
            z-index: 20;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #757575;
            font-size: 0.65rem;
            cursor: pointer;
        }
        .nav-item i { font-size: 1.3rem; }
        .nav-item.active { color: var(--tokped-green); }
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-card {
            background: white;
            width: 90%;
            max-width: 400px;
            border-radius: 24px;
            padding: 24px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-card h3 { margin-bottom: 18px; }
        .modal-field { margin-bottom: 16px; }
        .modal-field label {
            display: block;
            font-weight: 500;
            font-size: 0.85rem;
            margin-bottom: 4px;
        }
        .modal-field input, .modal-field select, .modal-field textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #dadada;
            border-radius: 12px;
        }
        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        .modal-actions button {
            flex: 1;
            padding: 12px;
            border-radius: 30px;
            border: none;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-save { background: var(--tokped-green); color: white; }
        .btn-cancel { background: #f1f3f4; color: #3c3c3c; }
        .delivery-option {
            border: 1px solid var(--tokped-border);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            cursor: pointer;
        }
        .delivery-option.selected {
            border-color: var(--tokped-green);
            background-color: var(--tokped-green-light);
        }
        .delivery-option-header {
            display: flex;
            justify-content: space-between;
            font-weight: 600;
        }
        .delivery-option-details {
            font-size: 0.8rem;
            color: #666;
            margin-top: 4px;
        }
        .delivery-option-time {
            font-size: 0.75rem;
            color: var(--tokped-green);
            margin-top: 4px;
        }
        .payment-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border: 1px solid var(--tokped-border);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .cart-item {
            display: flex;
            gap: 12px;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding: 12px 0;
        }
        .cart-item-img { width: 50px; height: 50px; background: #f1f1f1; border-radius: 8px; object-fit: cover; }
        .cart-item-details { flex: 1; }
        .cart-item-name { font-weight: 600; font-size: 0.9rem; }
        .cart-item-price { color: var(--tokped-price); font-weight: 600; }
        .cart-item-qty { display: flex; align-items: center; gap: 8px; margin-top: 4px; }
        .cart-item-qty button {
            background: #f1f1f1;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 30px;
            font-weight: bold;
            cursor: pointer;
        }
        .wa-checkout-btn {
            background: #25D366;
            color: white;
            border: none;
            padding: 14px;
            border-radius: 30px;
            font-weight: 600;
            width: 100%;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
        }
        .admin-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .admin-tab {
            background: #f1f3f4;
            padding: 8px 14px;
            border-radius: 30px;
            font-size: 0.85rem;
            cursor: pointer;
        }
        .admin-tab.active { background: var(--tokped-green); color: white; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }
        .banner-list-item, .cat-list-item, .prod-list-item, .user-list-item, .review-list-item {
            display: flex;
            gap: 10px;
            align-items: center;
            background: #f9f9f9;
            padding: 8px;
            border-radius: 12px;
            margin-bottom: 8px;
        }
        .cat-list-item img, .prod-list-item img {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
        }
        .cat-list-item i { font-size: 1.2rem; width: 30px; text-align: center; }
        .prod-list-item span { flex: 1; }
        .user-list-item, .review-list-item { flex-direction: column; align-items: flex-start; }
        .notif-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        .notif-item i {
            font-size: 1.5rem;
            color: var(--tokped-green);
        }
        .notif-item div {
            flex: 1;
        }
        .notif-item .notif-title {
            font-weight: 600;
            font-size: 0.95rem;
        }
        .notif-item .notif-time {
            font-size: 0.7rem;
            color: #999;
        }
        .image-gallery {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            margin: 10px 0;
            padding: 4px 0;
        }
        .gallery-image {
            width: 70px;
            height: 70px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid #ddd;
            cursor: pointer;
        }
        .main-image {
            width: 100%;
            aspect-ratio: 1/1;
            object-fit: cover;
            border-radius: 16px;
            margin-bottom: 10px;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 30px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        .status-ordered { background: #ffecb3; color: #b26a00; }
        .status-waiting_shipment { background: #ffe0b2; color: #bf360c; }
        .status-shipped { background: #b3e5fc; color: #01579b; }
        .status-delivered { background: #c8e6c9; color: #1b5e20; }
        .analytics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }
        .analytics-card {
            background: #f9f9f9;
            border-radius: 16px;
            padding: 16px;
            text-align: center;
        }
        .analytics-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--tokped-green);
        }
        .analytics-label {
            font-size: 0.8rem;
            color: #666;
        }
        .order-detail-item {
            font-size: 0.8rem;
            color: #555;
        }
        .star-rating {
            display: flex;
            gap: 4px;
            font-size: 1.5rem;
            cursor: pointer;
        }
        .star-rating .fa-star {
            color: #ddd;
        }
        .star-rating .fa-star.selected {
            color: #f9a825;
        }
        .also-viewed {
            padding: 16px;
            border-top: 8px solid #f1f3f4;
        }
        .also-viewed h4 {
            margin-bottom: 12px;
        }
        .also-viewed-scroll {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            scrollbar-width: none;
        }
        .also-viewed-scroll::-webkit-scrollbar { display: none; }
        .also-item {
            flex: 0 0 120px;
            border: 1px solid var(--tokped-border);
            border-radius: 12px;
            padding: 8px;
            cursor: pointer;
        }
        .also-item img {
            width: 100%;
            aspect-ratio: 1/1;
            object-fit: cover;
            border-radius: 8px;
        }
        .also-item .name {
            font-size: 0.75rem;
            margin-top: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .also-item .price {
            font-weight: 600;
            color: var(--tokped-price);
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <div class="app" id="app">
        <!-- HEADER -->
        <div class="header">
            <div class="top-row">
                <div class="logo-area">
                    <svg width="100%" height="45" viewBox="0 0 400 160" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg">
                        <style>
                            .brand-main { font-family: 'Segoe Script', 'Brush Script MT', cursive; font-size: 52px; fill: #2C2C2C; }
                            .accent-main { stroke: #C72A4C; stroke-width: 4; fill: none; stroke-linecap: round; stroke-linejoin: round; }
                        </style>
                        <path class="accent-main" d="M60 50 L80 40 L100 70 L90 110 L70 110 L60 70 L60 50" />
                        <circle cx="80" cy="60" r="8" fill="#C72A4C" opacity="0.9" />
                        <text x="120" y="95" class="brand-main">Teresa</text>
                    </svg>
                </div>
                <div class="action-icons">
                    <i class="fas fa-bell"></i>
                    <div class="cart-icon" id="cartIcon">
                        <i class="fas fa-shopping-cart"></i>
                        <span id="cartCount">0</span>
                    </div>
                </div>
            </div>
            <div class="search-bar">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Search in Teresa...">
            </div>
        </div>

        <!-- EXPRESS BANNER -->
        <div class="express-banner">
            <i class="fas fa-rocket"></i>
            <div>
                <div>Teresa Express</div>
                <div class="small">The BEST products, delivered faster. Now PAY on DELIVERY, Cash or Bank Transfer Anywhere, Zero Wahala!</div>
            </div>
        </div>

        <!-- BANNER CAROUSEL -->
        <div id="bannerCarousel" class="banner-carousel"></div>
        <div id="bannerDots" class="banner-dots"></div>

        <!-- CATEGORIES -->
        <div id="categoryContainer" class="categories"></div>

        <!-- ADMIN/SELLER BAR -->
        <div class="admin-bar">
            <span id="adminModeBadge" class="admin-badge" style="display: none;"><i class="fas fa-unlock-alt"></i> admin</span>
            <span id="sellerModeBadge" class="seller-badge" style="display: none;"><i class="fas fa-store"></i> seller</span>
        </div>

        <!-- PRODUCT GRID -->
        <div id="productGrid" class="product-grid"></div>

        <!-- ADD PRODUCT BUTTON (admin or seller) -->
        <button id="addProductBtn" class="btn-add-product" style="display: none;"><i class="fas fa-plus-circle"></i> Add new product</button>

        <!-- CUSTOMERS ALSO VIEWED -->
        <div id="alsoViewedSection" class="also-viewed" style="display: none;">
            <h4>Customers also viewed</h4>
            <div class="also-viewed-scroll" id="alsoViewedList"></div>
        </div>

        <!-- BOTTOM NAVIGATION -->
        <div class="bottom-nav">
            <div class="nav-item" data-nav="home"><i class="fas fa-home"></i><span>Home</span></div>
            <div class="nav-item" data-nav="promo"><i class="fas fa-tags"></i><span>Promo</span></div>
            <div class="nav-item" data-nav="orders"><i class="fas fa-clipboard-list"></i><span>Orders</span></div>
            <div class="nav-item" data-nav="notif"><i class="fas fa-bell"></i><span>Notif</span></div>
            <div class="nav-item" data-nav="me"><i class="fas fa-user"></i><span>Me</span></div>
        </div>
    </div>

    <!-- CART MODAL -->
    <div id="cartModal" class="modal">
        <div class="modal-card">
            <h3><i class="fas fa-shopping-cart"></i> Your cart</h3>
            <div id="cartItemsList"></div>
            <div id="cartTotal" class="cart-total" style="font-weight:700; margin:16px 0; text-align:right;">Total: KSh 0</div>
            <button class="wa-checkout-btn" id="cartWhatsappBtn"><i class="fab fa-whatsapp"></i> Order via WhatsApp</button>
            <button class="btn-save" id="checkoutBtn" style="margin-top:10px; width:100%;"><i class="fas fa-check"></i> Place order (trackable)</button>
            <div class="modal-actions" style="margin-top:12px;">
                <button class="btn-cancel" id="closeCartBtn">Close</button>
            </div>
        </div>
    </div>

    <!-- CHECKOUT DETAILS MODAL (with delivery & payment) -->
    <div id="checkoutDetailsModal" class="modal">
        <div class="modal-card">
            <h3><i class="fas fa-truck"></i> Delivery & Payment</h3>
            
            <div class="modal-field">
                <label>Full name</label>
                <input type="text" id="checkoutName" placeholder="John Doe">
            </div>
            <div class="modal-field">
                <label>Phone number</label>
                <input type="tel" id="checkoutPhone" placeholder="0712345678">
            </div>
            
            <!-- Delivery Method -->
            <div class="modal-field">
                <label>Delivery Method</label>
                <div id="deliveryOptions">
                    <div class="delivery-option" data-method="door" id="deliveryDoor">
                        <div class="delivery-option-header">
                            <span><i class="fas fa-truck"></i> Door Delivery</span>
                            <span>KSh <span id="deliveryFeeDisplay">250</span></span>
                        </div>
                        <div class="delivery-option-details">Ready for delivery between <span id="doorStart"></span> and <span id="doorEnd"></span></div>
                        <div class="delivery-option-time" id="doorTimer"></div>
                    </div>
                    <div class="delivery-option" data-method="pickup" id="deliveryPickup">
                        <div class="delivery-option-header">
                            <span><i class="fas fa-store"></i> Pickup Station</span>
                            <span>Free</span>
                        </div>
                        <div class="delivery-option-details">Pickup at Teresa Hub, Nairobi</div>
                        <div class="delivery-option-time">Ready for pickup between <span id="pickupStart"></span> and <span id="pickupEnd"></span></div>
                    </div>
                </div>
            </div>

            <!-- Address (only for door delivery) -->
            <div class="modal-field" id="addressField">
                <label>Shipping address</label>
                <textarea id="checkoutAddress" rows="2" placeholder="Street, city, building..."></textarea>
            </div>

            <!-- Payment Method -->
            <div class="modal-field">
                <label>Payment Method</label>
                <div id="paymentOptions">
                    <div class="payment-option">
                        <input type="radio" name="payment" value="cash" id="payCash" checked>
                        <label for="payCash"><i class="fas fa-money-bill-wave"></i> Cash on Delivery</label>
                    </div>
                    <div class="payment-option">
                        <input type="radio" name="payment" value="bank" id="payBank">
                        <label for="payBank"><i class="fas fa-university"></i> Bank Transfer (M-Pesa/Bank)</label>
                    </div>
                </div>
            </div>

            <div class="modal-field">
                <label>Order notes (optional)</label>
                <textarea id="checkoutNotes" rows="2" placeholder="Any special instructions"></textarea>
            </div>

            <div class="modal-actions">
                <button class="btn-cancel" id="checkoutCancel">Cancel</button>
                <button class="btn-save" id="checkoutConfirm">Confirm order</button>
            </div>
        </div>
    </div>

    <!-- AUTH MODAL -->
    <div id="authModal" class="modal">
        <div class="modal-card">
            <h3 id="authModalTitle">Login</h3>
            <div class="modal-field">
                <label>Email</label>
                <input type="email" id="authEmail" placeholder="your@email.com">
            </div>
            <div class="modal-field">
                <label>Password</label>
                <input type="password" id="authPassword" placeholder="••••••••">
            </div>
            <div class="modal-actions">
                <button class="btn-cancel" id="authCancel">Cancel</button>
                <button class="btn-save" id="authLoginBtn">Login</button>
            </div>
            <p style="text-align:center; margin-top:16px;">
                Don't have an account? <a href="#" id="showSignup">Sign up</a>
            </p>
        </div>
    </div>

    <!-- PROFILE MODAL (with seller features) -->
    <div id="profileModal" class="modal">
        <div class="modal-card">
            <h3><i class="fas fa-user"></i> My Account</h3>
            <p><strong id="profileEmail"></strong> <span id="profileRole" class="seller-badge"></span></p>
            <div id="sellerRequestSection" style="margin: 16px 0;"></div>
            <button class="btn-cancel" id="logoutBtn" style="width:100%; margin-bottom:20px;">Logout</button>

            <h4>My Orders</h4>
            <div id="userOrdersList"></div>

            <!-- Seller Dashboard -->
            <div id="sellerDashboard" style="display: none; margin-top:20px;">
                <h4>My Products</h4>
                <div id="sellerProductsList"></div>
                <button class="btn-save" id="sellerAddProductBtn" style="margin-top:10px; width:100%;"><i class="fas fa-plus"></i> Add Product</button>
                
                <h4 style="margin-top:20px;">Orders for My Products</h4>
                <div id="sellerOrdersList"></div>
            </div>

            <div class="modal-actions"><button class="btn-cancel" id="closeProfileBtn">Close</button></div>
        </div>
    </div>

    <!-- SELLER APPLICATION MODAL -->
    <div id="sellerApplyModal" class="modal">
        <div class="modal-card">
            <h3>Become a Seller</h3>
            <p>Apply to start selling your products on Teresa.</p>
            <div class="modal-actions">
                <button class="btn-cancel" id="sellerApplyCancel">Cancel</button>
                <button class="btn-save" id="sellerApplyConfirm">Submit Application</button>
            </div>
        </div>
    </div>

    <!-- REVIEW MODAL -->
    <div id="reviewModal" class="modal">
        <div class="modal-card">
            <h3><i class="fas fa-star"></i> Write a review</h3>
            <div class="modal-field">
                <label>Rating</label>
                <div class="star-rating" id="starRating">
                    <i class="fas fa-star" data-value="1"></i>
                    <i class="fas fa-star" data-value="2"></i>
                    <i class="fas fa-star" data-value="3"></i>
                    <i class="fas fa-star" data-value="4"></i>
                    <i class="fas fa-star" data-value="5"></i>
                </div>
                <input type="hidden" id="reviewRating" value="0">
            </div>
            <div class="modal-field">
                <label>Comment</label>
                <textarea id="reviewComment" rows="3" placeholder="Share your experience..."></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn-cancel" id="reviewCancel">Cancel</button>
                <button class="btn-save" id="reviewSubmit">Submit review</button>
            </div>
        </div>
    </div>

    <!-- ADMIN DASHBOARD MODAL -->
    <div id="adminModal" class="modal">
        <div class="modal-card">
            <h3><i class="fas fa-cog"></i> Admin dashboard</h3>
            <div class="admin-tabs">
                <div class="admin-tab active" data-tab="categories">Categories</div>
                <div class="admin-tab" data-tab="banners">Banners</div>
                <div class="admin-tab" data-tab="products">Products</div>
                <div class="admin-tab" data-tab="orders">Orders</div>
                <div class="admin-tab" data-tab="users">Users</div>
                <div class="admin-tab" data-tab="sellers">Seller Apps</div>
                <div class="admin-tab" data-tab="reviews">Reviews</div>
                <div class="admin-tab" data-tab="analytics">Analytics</div>
                <div class="admin-tab" data-tab="settings">Settings</div>
            </div>

            <!-- Categories tab -->
            <div id="tab-categories" class="tab-pane active">
                <div id="categoriesList"></div>
                <button class="btn-add-product" id="addCategoryBtn" style="margin:10px 0;"><i class="fas fa-plus"></i> Add category</button>
            </div>

            <!-- Banners tab -->
            <div id="tab-banners" class="tab-pane">
                <div id="bannersList"></div>
                <button class="btn-add-product" id="addBannerBtn" style="margin:10px 0;"><i class="fas fa-plus"></i> Add banner</button>
            </div>

            <!-- Products tab -->
            <div id="tab-products" class="tab-pane">
                <div id="productsList"></div>
            </div>

            <!-- Orders tab -->
            <div id="tab-orders" class="tab-pane">
                <div id="adminOrdersList"></div>
            </div>

            <!-- Users tab -->
            <div id="tab-users" class="tab-pane">
                <div id="usersList"></div>
            </div>

            <!-- Seller Applications tab -->
            <div id="tab-sellers" class="tab-pane">
                <div id="sellerApplicationsList"></div>
            </div>

            <!-- Reviews tab -->
            <div id="tab-reviews" class="tab-pane">
                <div id="reviewsList"></div>
            </div>

            <!-- Analytics tab -->
            <div id="tab-analytics" class="tab-pane">
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <div class="analytics-value" id="totalRevenue">0</div>
                        <div class="analytics-label">Revenue (KSh)</div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-value" id="totalProfit">0</div>
                        <div class="analytics-label">Profit (KSh)</div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-value" id="totalSold">0</div>
                        <div class="analytics-label">Products sold</div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-value" id="ordersByStatus">0</div>
                        <div class="analytics-label">Pending orders</div>
                    </div>
                </div>
                <div style="margin-top:20px;">
                    <h4>Orders by status</h4>
                    <div id="statusBreakdown"></div>
                </div>
            </div>

            <!-- Settings tab -->
            <div id="tab-settings" class="tab-pane">
                <div class="modal-field">
                    <label>WhatsApp number (with country code, no +)</label>
                    <input type="text" id="waNumberInput" placeholder="e.g. 254700000000">
                </div>
                <div class="modal-field">
                    <label>Door delivery fee (KSh)</label>
                    <input type="number" id="deliveryFeeInput" value="250">
                </div>
                <div class="modal-field">
                    <label>Pickup stations (comma separated)</label>
                    <input type="text" id="pickupStationsInput" value="Teresa Hub Nairobi, Teresa Hub Mombasa">
                </div>
                <button class="btn-save" id="saveSettingsBtn" style="width:100%;">Save Settings</button>
            </div>

            <div class="modal-actions"><button class="btn-cancel" id="closeAdminModal">Close</button></div>
        </div>
    </div>

    <!-- PRODUCT DETAIL MODAL (enhanced) -->
    <div id="productDetailModal" class="modal">
        <div class="modal-card">
            <h3 id="detailProductName"></h3>
            <div style="display: flex; gap: 5px; margin-bottom: 5px; flex-wrap: wrap;">
                <span class="badge official" id="detailOfficial" style="display: none;">Official Store</span>
                <span class="badge nonreturn" id="detailNonReturn" style="display: none;">Non-returnable</span>
                <span class="badge stock" id="detailInStock" style="display: none;">In stock</span>
                <span class="badge outstock" id="detailOutStock" style="display: none;">Out of stock</span>
            </div>
            <img id="detailMainImage" class="main-image" src="" alt="">
            <div class="image-gallery" id="detailGallery"></div>
            <p id="detailDescription" style="margin:12px 0;"></p>
            <div class="price-discount" style="margin-bottom:12px;">
                <span class="product-price" id="detailPrice"></span>
                <span class="original-price" id="detailOriginalPrice"></span>
                <span class="discount-badge" id="detailDiscount" style="display:none;"></span>
            </div>
            <div class="stock-status" id="detailStock"></div>
            <div style="font-size:0.8rem; margin-bottom:12px;" id="detailReturnPolicy"></div>
            <button class="add-to-cart-btn" id="detailAddToCart"><i class="fas fa-cart-plus"></i> Add to cart</button>
            <a href="#" target="_blank" rel="noopener" class="affiliate-btn" id="affiliateLinkBtn" style="display:none;"><i class="fas fa-external-link-alt"></i> Affiliate link</a>
            <button class="btn-copy-link" id="copyReferralLink" style="display:none;"><i class="fas fa-link"></i> Copy referral link</button>
            <div class="modal-actions"><button class="btn-cancel" id="closeDetailBtn">Close</button></div>
        </div>
    </div>

    <!-- EDIT PRODUCT MODAL (with new fields) -->
    <div id="productEditModal" class="modal">
        <div class="modal-card">
            <h3 id="productModalTitle">Edit product</h3>
            <div class="modal-field"><label>Product name</label><input type="text" id="prodName"></div>
            <div class="modal-field"><label>Price (KSh)</label><input type="number" id="prodPrice"></div>
            <div class="modal-field"><label>Cost price (for profit)</label><input type="number" id="prodCost" placeholder="KSh"></div>
            <div class="modal-field"><label>Original price (for discount)</label><input type="number" id="prodOriginalPrice" placeholder="0 = no discount"></div>
            <div class="modal-field"><label>Commission (%)</label><input type="number" id="prodCommission" value="10" min="0" max="100"></div>
            <div class="modal-field"><label>Stock</label><input type="number" id="prodStock" value="10"></div>
            <div class="modal-field"><label>Return policy</label><input type="text" id="prodReturnPolicy" value="Free return within 7 days"></div>
            <div class="modal-field">
                <label><input type="checkbox" id="prodOfficial"> Official Store</label>
            </div>
            <div class="modal-field">
                <label><input type="checkbox" id="prodNonReturn"> Non-returnable</label>
            </div>
            <div class="modal-field"><label>Main image URL</label><input type="text" id="prodImage"></div>
            <div class="modal-field"><label>Additional image URLs (comma separated)</label><input type="text" id="prodImages" placeholder="url1, url2, url3"></div>
            <div class="modal-field"><label>Description</label><textarea id="prodDescription" rows="3"></textarea></div>
            <div class="modal-field"><label>Affiliate link (optional)</label><input type="text" id="prodAffiliateLink" placeholder="https://..."></div>
            <div class="modal-field"><label>Category</label><select id="prodCategory"></select></div>
            <div class="modal-field"><label>Rating</label><input type="number" step="0.1" id="prodRating" value="4.5"></div>
            <div class="modal-field"><label>Sold count</label><input type="number" id="prodSold" value="0"></div>
            <div class="modal-field"><label>Small badge image URL (optional)</label><input type="text" id="prodBadgeImage" placeholder="https://..."></div>
            <div class="modal-field"><label>Badge text (e.g. RAMADAN EKSTRASERU)</label><input type="text" id="prodBadgeText" placeholder="Ramadan EKSTRASERU"></div>
            <div class="modal-actions">
                <button class="btn-cancel" id="productModalCancel">Cancel</button>
                <button class="btn-save" id="productModalSave">Save</button>
            </div>
        </div>
    </div>

    <!-- EDIT CATEGORY MODAL -->
    <div id="categoryEditModal" class="modal">
        <div class="modal-card">
            <h3>Edit category</h3>
            <div class="modal-field"><label>Category name</label><input type="text" id="catNameInput"></div>
            <div class="modal-field"><label>Icon class (Font Awesome fallback, e.g. fa-mobile-alt)</label><input type="text" id="catIconInput" placeholder="fa-mobile-alt"></div>
            <div class="modal-field"><label>Category image URL (optional, will replace icon)</label><input type="text" id="catImageInput" placeholder="https://..."></div>
            <div class="modal-actions">
                <button class="btn-cancel" id="catModalCancel">Cancel</button>
                <button class="btn-save" id="catModalSave">Save</button>
            </div>
        </div>
    </div>

    <!-- EDIT BANNER MODAL -->
    <div id="bannerEditModal" class="modal">
        <div class="modal-card">
            <h3>Edit banner</h3>
            <div class="modal-field"><label>Image URL</label><input type="text" id="bannerImageInput"></div>
            <div class="modal-field"><label>Link (optional)</label><input type="text" id="bannerLinkInput"></div>
            <div class="modal-field"><label>Title text</label><input type="text" id="bannerTitleInput"></div>
            <div class="modal-actions">
                <button class="btn-cancel" id="bannerModalCancel">Cancel</button>
                <button class="btn-save" id="bannerModalSave">Save</button>
            </div>
        </div>
    </div>

    <!-- NOTIFICATION MODAL -->
    <div id="notifModal" class="modal">
        <div class="modal-card">
            <h3><i class="fas fa-bell"></i> Notifications</h3>
            <div id="notificationsList"></div>
            <div class="modal-actions"><button class="btn-cancel" id="closeNotifBtn">Close</button></div>
        </div>
    </div>

    <script>
        (async function() {
            // ========== SUPABASE SETUP ==========
            const SUPABASE_URL = 'https://ykqhoacpopuiaupwoied.supabase.co'; // Replace with your project URL
            const SUPABASE_ANON_KEY = 'sb_publishable_O_d-72K0nB0pyLF4y5YZWw_KSWWFB_f'; // Replace with your anon key
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            // ========== REFERRAL TRACKING ==========
            const urlParams = new URLSearchParams(window.location.search);
            const ref = urlParams.get('ref');
            const productParam = urlParams.get('product');
            if (ref && ref.length > 0) {
                localStorage.setItem('referrer', ref);
                if (productParam) {
                    supabase.from('referral_clicks').insert([
                        { referrer_id: ref, product_id: productParam }
                    ]).then(console.log).catch(console.error);
                }
            }

            // ========== DEFAULT DATA ==========
            const DEFAULT_CATEGORIES = [
                { id: 'cat1', name: 'Gadgets', icon: 'fa-mobile-alt', image: '' },
                { id: 'cat2', name: 'Beauty', icon: 'fa-magic', image: '' },
                { id: 'cat3', name: 'Ladies', icon: 'fa-gem', image: '' },
                { id: 'cat4', name: 'Earrings', icon: 'fa-earrings', image: '' },
                { id: 'cat5', name: 'Nose ring', icon: 'fa-ring', image: '' }
            ];
            const DEFAULT_BANNERS = [
                { id: 'ban1', image: 'https://placehold.co/600x200/03ac0e/white?text=Gadgets+Sale', link: '', title: 'Gadgets Sale' },
                { id: 'ban2', image: 'https://placehold.co/600x200/f9a825/white?text=Beauty+Special', link: '', title: 'Beauty Special' }
            ];
            const DEFAULT_PRODUCTS = [
                { id: 'p1', name: 'Smartphone Android 13', price: 25999, costPrice: 22000, originalPrice: 29999, commission_percent: 10, image: 'https://placehold.co/400x400/03ac0e/white?text=Smartphone', images: [], description: 'Latest Android 13 smartphone with 128GB storage.', category: 'cat1', rating: 4.5, sold: 78, badgeImage: 'https://p16-uploadpedia-sg.tokopedia-static.net/tos-alisg-i-zxty12jeln-sg/8caaede0c21c7e3be9a1b4e8d550acce.png~tplv-zxty12jeln-image.image', badgeText: 'RAMADAN EKSTRASERU', affiliate_link: '', seller_id: null, stock: 10, return_policy: 'Free return within 7 days', is_official_store: true, is_non_returnable: false },
                { id: 'p2', name: 'TWS Wireless Earbuds Pro', price: 3999, costPrice: 2500, originalPrice: 5999, commission_percent: 10, image: 'https://placehold.co/400x400/03ac0e/white?text=Earbuds', images: [], description: 'Noise cancelling earbuds with charging case.', category: 'cat1', rating: 4.3, sold: 124, badgeImage: '', badgeText: '', affiliate_link: '', seller_id: null, stock: 5, return_policy: 'Free return within 7 days', is_official_store: false, is_non_returnable: false },
                { id: 'p3', name: 'Matte Lipstick Set (6 pcs)', price: 1299, costPrice: 800, originalPrice: 1899, commission_percent: 10, image: 'https://placehold.co/400x400/03ac0e/white?text=Lipstick', images: [], description: 'Set of 6 long-lasting matte lipsticks.', category: 'cat2', rating: 4.7, sold: 312, badgeImage: 'https://p16-uploadpedia-sg.tokopedia-static.net/tos-alisg-i-zxty12jeln-sg/8caaede0c21c7e3be9a1b4e8d550acce.png~tplv-zxty12jeln-image.image', badgeText: 'RAMADAN EKSTRASERU', affiliate_link: '', seller_id: null, stock: 20, return_policy: 'Free return within 7 days', is_official_store: true, is_non_returnable: false },
                { id: 'p4', name: 'Gold Plated Hoop Earrings', price: 3499, costPrice: 2000, originalPrice: 4499, commission_percent: 10, image: 'https://placehold.co/400x400/03ac0e/white?text=Earrings', images: [], description: 'Elegant gold plated hoop earrings.', category: 'cat4', rating: 4.8, sold: 56, badgeImage: '', badgeText: '', affiliate_link: '', seller_id: null, stock: 3, return_policy: 'Non-returnable', is_official_store: false, is_non_returnable: true },
                { id: 'p5', name: 'Silver Nose Ring', price: 899, costPrice: 400, originalPrice: 1199, commission_percent: 10, image: 'https://placehold.co/400x400/03ac0e/white?text=Nose+Ring', images: [], description: 'Adjustable silver nose ring.', category: 'cat5', rating: 4.4, sold: 103, badgeImage: '', badgeText: '', affiliate_link: '', seller_id: null, stock: 0, return_policy: 'Free return within 7 days', is_official_store: false, is_non_returnable: false }
            ];
            const DEFAULT_SETTINGS = { wa_number: '254700000000', delivery_fee: '250', pickup_stations: 'Teresa Hub Nairobi, Teresa Hub Mombasa' };

            // ========== STATE ==========
            let categories = [];
            let banners = [];
            let products = [];
            let settings = { ...DEFAULT_SETTINGS };
            let orders = [];
            let reviews = [];
            let profiles = [];
            let currentUser = null;
            let currentUserProfile = null;
            let cart = JSON.parse(localStorage.getItem('cart')) || [];

            let activeCategory = null;
            let activePromo = false;
            let searchTerm = '';
            let searchTimeout = null;

            let currentProductId = null, currentCategoryId = null, currentBannerId = null;
            let currentOrderIdForReview = null;

            // ========== DOM ELEMENTS ==========
            const categoryContainer = document.getElementById('categoryContainer');
            const bannerCarousel = document.getElementById('bannerCarousel');
            const bannerDots = document.getElementById('bannerDots');
            const productGrid = document.getElementById('productGrid');
            const adminBadge = document.getElementById('adminModeBadge');
            const sellerBadge = document.getElementById('sellerModeBadge');
            const addProductBtn = document.getElementById('addProductBtn');
            const cartIcon = document.getElementById('cartIcon');
            const cartCountSpan = document.getElementById('cartCount');
            const cartModal = document.getElementById('cartModal');
            const cartItemsList = document.getElementById('cartItemsList');
            const cartTotalSpan = document.getElementById('cartTotal');
            const cartWhatsappBtn = document.getElementById('cartWhatsappBtn');
            const checkoutBtn = document.getElementById('checkoutBtn');
            const closeCartBtn = document.getElementById('closeCartBtn');
            const checkoutDetailsModal = document.getElementById('checkoutDetailsModal');
            const checkoutName = document.getElementById('checkoutName');
            const checkoutPhone = document.getElementById('checkoutPhone');
            const checkoutAddress = document.getElementById('checkoutAddress');
            const checkoutNotes = document.getElementById('checkoutNotes');
            const checkoutCancel = document.getElementById('checkoutCancel');
            const checkoutConfirm = document.getElementById('checkoutConfirm');
            const deliveryOptions = document.getElementById('deliveryOptions');
            const deliveryDoor = document.getElementById('deliveryDoor');
            const deliveryPickup = document.getElementById('deliveryPickup');
            const addressField = document.getElementById('addressField');
            const doorStart = document.getElementById('doorStart');
            const doorEnd = document.getElementById('doorEnd');
            const doorTimer = document.getElementById('doorTimer');
            const pickupStart = document.getElementById('pickupStart');
            const pickupEnd = document.getElementById('pickupEnd');
            const deliveryFeeDisplay = document.getElementById('deliveryFeeDisplay');
            const paymentOptions = document.querySelectorAll('input[name="payment"]');
            const adminModal = document.getElementById('adminModal');
            const closeAdminModal = document.getElementById('closeAdminModal');
            const categoriesListDiv = document.getElementById('categoriesList');
            const bannersListDiv = document.getElementById('bannersList');
            const productsListDiv = document.getElementById('productsList');
            const adminOrdersListDiv = document.getElementById('adminOrdersList');
            const usersListDiv = document.getElementById('usersList');
            const reviewsListDiv = document.getElementById('reviewsList');
            const sellerApplicationsListDiv = document.getElementById('sellerApplicationsList');
            const addCategoryBtn = document.getElementById('addCategoryBtn');
            const addBannerBtn = document.getElementById('addBannerBtn');
            const productEditModal = document.getElementById('productEditModal');
            const prodName = document.getElementById('prodName');
            const prodPrice = document.getElementById('prodPrice');
            const prodCost = document.getElementById('prodCost');
            const prodOriginalPrice = document.getElementById('prodOriginalPrice');
            const prodCommission = document.getElementById('prodCommission');
            const prodStock = document.getElementById('prodStock');
            const prodReturnPolicy = document.getElementById('prodReturnPolicy');
            const prodOfficial = document.getElementById('prodOfficial');
            const prodNonReturn = document.getElementById('prodNonReturn');
            const prodImage = document.getElementById('prodImage');
            const prodImages = document.getElementById('prodImages');
            const prodDescription = document.getElementById('prodDescription');
            const prodAffiliateLink = document.getElementById('prodAffiliateLink');
            const prodCategory = document.getElementById('prodCategory');
            const prodRating = document.getElementById('prodRating');
            const prodSold = document.getElementById('prodSold');
            const prodBadgeImage = document.getElementById('prodBadgeImage');
            const prodBadgeText = document.getElementById('prodBadgeText');
            const productModalCancel = document.getElementById('productModalCancel');
            const productModalSave = document.getElementById('productModalSave');
            const categoryEditModal = document.getElementById('categoryEditModal');
            const catNameInput = document.getElementById('catNameInput');
            const catIconInput = document.getElementById('catIconInput');
            const catImageInput = document.getElementById('catImageInput');
            const catModalCancel = document.getElementById('catModalCancel');
            const catModalSave = document.getElementById('catModalSave');
            const bannerEditModal = document.getElementById('bannerEditModal');
            const bannerImageInput = document.getElementById('bannerImageInput');
            const bannerLinkInput = document.getElementById('bannerLinkInput');
            const bannerTitleInput = document.getElementById('bannerTitleInput');
            const bannerModalCancel = document.getElementById('bannerModalCancel');
            const bannerModalSave = document.getElementById('bannerModalSave');
            const searchInput = document.getElementById('searchInput');
            const notifModal = document.getElementById('notifModal');
            const notificationsList = document.getElementById('notificationsList');
            const closeNotifBtn = document.getElementById('closeNotifBtn');
            const waNumberInput = document.getElementById('waNumberInput');
            const deliveryFeeInput = document.getElementById('deliveryFeeInput');
            const pickupStationsInput = document.getElementById('pickupStationsInput');
            const saveSettingsBtn = document.getElementById('saveSettingsBtn');

            const authModal = document.getElementById('authModal');
            const authEmail = document.getElementById('authEmail');
            const authPassword = document.getElementById('authPassword');
            const authLoginBtn = document.getElementById('authLoginBtn');
            const authCancel = document.getElementById('authCancel');
            const showSignup = document.getElementById('showSignup');
            const authModalTitle = document.getElementById('authModalTitle');

            const profileModal = document.getElementById('profileModal');
            const profileEmail = document.getElementById('profileEmail');
            const profileRole = document.getElementById('profileRole');
            const sellerRequestSection = document.getElementById('sellerRequestSection');
            const sellerDashboard = document.getElementById('sellerDashboard');
            const sellerProductsList = document.getElementById('sellerProductsList');
            const sellerOrdersList = document.getElementById('sellerOrdersList');
            const sellerAddProductBtn = document.getElementById('sellerAddProductBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const userOrdersList = document.getElementById('userOrdersList');
            const closeProfileBtn = document.getElementById('closeProfileBtn');

            const sellerApplyModal = document.getElementById('sellerApplyModal');
            const sellerApplyCancel = document.getElementById('sellerApplyCancel');
            const sellerApplyConfirm = document.getElementById('sellerApplyConfirm');

            const totalClicksSpan = document.getElementById('totalClicks');
            const totalConversionsSpan = document.getElementById('totalConversions');
            const pendingEarningsSpan = document.getElementById('pendingEarnings');
            const paidEarningsSpan = document.getElementById('paidEarnings');

            const detailModal = document.getElementById('productDetailModal');
            const detailProductName = document.getElementById('detailProductName');
            const detailOfficial = document.getElementById('detailOfficial');
            const detailNonReturn = document.getElementById('detailNonReturn');
            const detailInStock = document.getElementById('detailInStock');
            const detailOutStock = document.getElementById('detailOutStock');
            const detailMainImage = document.getElementById('detailMainImage');
            const detailGallery = document.getElementById('detailGallery');
            const detailDescription = document.getElementById('detailDescription');
            const detailPrice = document.getElementById('detailPrice');
            const detailOriginalPrice = document.getElementById('detailOriginalPrice');
            const detailDiscount = document.getElementById('detailDiscount');
            const detailStock = document.getElementById('detailStock');
            const detailReturnPolicy = document.getElementById('detailReturnPolicy');
            const detailAddToCart = document.getElementById('detailAddToCart');
            const affiliateLinkBtn = document.getElementById('affiliateLinkBtn');
            const copyReferralLinkBtn = document.getElementById('copyReferralLink');
            const closeDetailBtn = document.getElementById('closeDetailBtn');

            const reviewModal = document.getElementById('reviewModal');
            const starRatingDiv = document.getElementById('starRating');
            const reviewRatingInput = document.getElementById('reviewRating');
            const reviewComment = document.getElementById('reviewComment');
            const reviewCancel = document.getElementById('reviewCancel');
            const reviewSubmit = document.getElementById('reviewSubmit');

            const alsoViewedSection = document.getElementById('alsoViewedSection');
            const alsoViewedList = document.getElementById('alsoViewedList');

            const navItems = document.querySelectorAll('.nav-item');

            // ========== STAR RATING HANDLER ==========
            const stars = starRatingDiv.querySelectorAll('.fa-star');
            stars.forEach(star => {
                star.addEventListener('click', () => {
                    const value = parseInt(star.dataset.value);
                    reviewRatingInput.value = value;
                    stars.forEach((s, i) => {
                        if (i < value) s.classList.add('selected');
                        else s.classList.remove('selected');
                    });
                });
            });

            // ========== PROFILE FUNCTIONS ==========
            async function getOrCreateProfile(user) {
                if (!user) return null;
                let { data: profile, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('user_id', user.id)
                    .single();
                
                if (error && error.code === 'PGRST116') {
                    // Create new profile
                    let role = 'customer';
                    let seller_status = null;
                    // If email is admin, set role to admin
                    if (user.email === 'admin@teresa.com') {
                        role = 'admin';
                    }
                    const newProfile = {
                        user_id: user.id,
                        email: user.email,
                        role: role,
                        seller_status: seller_status,
                        created_at: new Date().toISOString()
                    };
                    const { data: inserted, error: insertError } = await supabase
                        .from('profiles')
                        .insert([newProfile])
                        .select()
                        .single();
                    if (insertError) console.error('Profile creation error', insertError);
                    profile = inserted;
                } else if (error) {
                    console.error('Profile fetch error', error);
                } else {
                    // If existing profile but email is admin and role is not admin, upgrade
                    if (user.email === 'admin@teresa.com' && profile.role !== 'admin') {
                        await supabase.from('profiles').update({ role: 'admin' }).eq('user_id', user.id);
                        profile.role = 'admin';
                    }
                }
                return profile;
            }

            // ========== DELIVERY DATE HELPER ==========
            function getDeliveryDates() {
                const now = new Date();
                const orderCutoff = new Date(now.getTime() + (3 * 60 * 60 * 1000) + (43 * 60 * 1000)); // 3hrs 43mins from now
                const today = new Date();
                const startDoor = new Date(today);
                startDoor.setDate(today.getDate() + 2);
                const endDoor = new Date(today);
                endDoor.setDate(today.getDate() + 4);
                const startPickup = new Date(today);
                startPickup.setDate(today.getDate() + 1);
                const endPickup = new Date(today);
                endPickup.setDate(today.getDate() + 2);

                const formatDate = (d) => d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
                const formatTimeRemaining = () => {
                    const diff = orderCutoff - new Date();
                    if (diff <= 0) return 'Order now for fastest delivery';
                    const hours = Math.floor(diff / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    return `Place order within ${hours}hrs ${minutes}mins`;
                };

                return {
                    doorStart: startDoor,
                    doorEnd: endDoor,
                    pickupStart: startPickup,
                    pickupEnd: endPickup,
                    doorStartStr: formatDate(startDoor),
                    doorEndStr: formatDate(endDoor),
                    pickupStartStr: formatDate(startPickup),
                    pickupEndStr: formatDate(endPickup),
                    timer: formatTimeRemaining()
                };
            }

            // ========== SUPABASE FETCH & SEED ==========
            async function loadAllData() {
                // Load categories
                let { data: catData, error: catErr } = await supabase.from('categories').select('*');
                if (catErr) console.error('categories error', catErr);
                if (!catData || catData.length === 0) {
                    const { data: inserted } = await supabase.from('categories').insert(DEFAULT_CATEGORIES).select();
                    categories = inserted || DEFAULT_CATEGORIES;
                } else {
                    categories = catData;
                }

                // Load banners
                let { data: banData, error: banErr } = await supabase.from('banners').select('*');
                if (banErr) console.error('banners error', banErr);
                if (!banData || banData.length === 0) {
                    const { data: inserted } = await supabase.from('banners').insert(DEFAULT_BANNERS).select();
                    banners = inserted || DEFAULT_BANNERS;
                } else {
                    banners = banData;
                }

                // Load products
                let { data: prodData, error: prodErr } = await supabase.from('products').select('*');
                if (prodErr) console.error('products error', prodErr);
                if (!prodData || prodData.length === 0) {
                    const { data: inserted } = await supabase.from('products').insert(DEFAULT_PRODUCTS).select();
                    products = inserted || DEFAULT_PRODUCTS;
                } else {
                    products = prodData;
                }

                // Load settings
                let { data: settingsData, error: settingsErr } = await supabase.from('settings').select('*');
                if (settingsErr) console.error('settings error', settingsErr);
                if (settingsData) {
                    settingsData.forEach(s => settings[s.key] = s.value);
                }
                // Ensure defaults
                if (!settings.wa_number) settings.wa_number = DEFAULT_SETTINGS.wa_number;
                if (!settings.delivery_fee) settings.delivery_fee = DEFAULT_SETTINGS.delivery_fee;
                if (!settings.pickup_stations) settings.pickup_stations = DEFAULT_SETTINGS.pickup_stations;
                waNumberInput.value = settings.wa_number;
                deliveryFeeInput.value = settings.delivery_fee;
                deliveryFeeDisplay.innerText = settings.delivery_fee;
                pickupStationsInput.value = settings.pickup_stations;

                // Load orders
                let { data: ordersData, error: ordersErr } = await supabase.from('orders').select('*');
                if (ordersErr) console.error('orders error', ordersErr);
                if (ordersData) orders = ordersData;

                // Load reviews
                let { data: reviewsData, error: reviewsErr } = await supabase.from('reviews').select('*');
                if (reviewsErr) console.error('reviews error', reviewsErr);
                if (reviewsData) reviews = reviewsData;

                // Load profiles
                let { data: profilesData, error: profilesErr } = await supabase.from('profiles').select('*');
                if (profilesErr) console.error('profiles error', profilesErr);
                if (profilesData) profiles = profilesData;

                // Clean cart
                cart = cart.filter(item => products.some(p => p.id === item.id));
                localStorage.setItem('cart', JSON.stringify(cart));

                // Get current user and profile
                const { data: { user } } = await supabase.auth.getUser();
                currentUser = user;
                if (user) {
                    currentUserProfile = await getOrCreateProfile(user);
                } else {
                    currentUserProfile = null;
                }

                refreshUI();
            }

            // ========== REAL‑TIME SUBSCRIPTIONS ==========
            function setupSubscriptions() {
                supabase.channel('categories').on('postgres_changes', { event: '*', schema: 'public', table: 'categories' }, () => loadAllData()).subscribe();
                supabase.channel('banners').on('postgres_changes', { event: '*', schema: 'public', table: 'banners' }, () => loadAllData()).subscribe();
                supabase.channel('products').on('postgres_changes', { event: '*', schema: 'public', table: 'products' }, () => loadAllData()).subscribe();
                supabase.channel('settings').on('postgres_changes', { event: '*', schema: 'public', table: 'settings' }, () => loadAllData()).subscribe();
                supabase.channel('orders').on('postgres_changes', { event: '*', schema: 'public', table: 'orders' }, () => loadAllData()).subscribe();
                supabase.channel('reviews').on('postgres_changes', { event: '*', schema: 'public', table: 'reviews' }, () => loadAllData()).subscribe();
                supabase.channel('profiles').on('postgres_changes', { event: '*', schema: 'public', table: 'profiles' }, () => loadAllData()).subscribe();
            }

            // ========== HELPER FUNCTIONS ==========
            function updateCartCount() {
                const total = cart.reduce((acc, item) => acc + item.quantity, 0);
                cartCountSpan.innerText = total;
            }

            function getFilteredProducts() {
                let filtered = products;
                if (activeCategory) filtered = filtered.filter(p => p.category === activeCategory);
                if (activePromo) filtered = filtered.filter(p => p.originalPrice && p.originalPrice > p.price);
                if (searchTerm.trim() !== '') {
                    const term = searchTerm.toLowerCase();
                    filtered = filtered.filter(p => p.name.toLowerCase().includes(term));
                }
                return filtered;
            }

            // ========== RENDER FUNCTIONS ==========
            function renderCategories() {
                let html = '';
                categories.forEach(cat => {
                    const activeClass = activeCategory === cat.id ? 'active' : '';
                    html += `<span class="chip ${activeClass}" data-cat-id="${cat.id}">`;
                    if (cat.image) {
                        html += `<img src="${cat.image}" alt="${cat.name}">`;
                    } else {
                        html += `<i class="fas ${cat.icon}"></i>`;
                    }
                    html += ` ${cat.name}</span>`;
                });
                html += `<span class="chip ${activeCategory === null ? 'active' : ''}" data-cat-id="all"><i class="fas fa-th-large"></i> All</span>`;
                categoryContainer.innerHTML = html;
            }

            function renderBanners() {
                let carouselHtml = '', dotsHtml = '';
                banners.forEach((banner, idx) => {
                    carouselHtml += `<div class="banner-item" style="background-image: url('${banner.image}');"><a href="${banner.link || '#'}" target="_blank">${banner.title}</a></div>`;
                    dotsHtml += `<span class="dot ${idx === 0 ? 'active' : ''}" data-index="${idx}"></span>`;
                });
                bannerCarousel.innerHTML = carouselHtml;
                bannerDots.innerHTML = dotsHtml;
                bannerCarousel.removeEventListener('scroll', bannerScrollHandler);
                bannerCarousel.addEventListener('scroll', bannerScrollHandler);
            }

            function bannerScrollHandler() {
                const scrollPos = bannerCarousel.scrollLeft;
                const itemWidth = bannerCarousel.clientWidth * 0.9 + 10;
                const activeIndex = Math.round(scrollPos / itemWidth);
                document.querySelectorAll('.dot').forEach((d, i) => d.classList.toggle('active', i === activeIndex));
            }

            function renderProducts() {
                const filtered = getFilteredProducts();
                let html = '';
                filtered.forEach(prod => {
                    const discount = prod.originalPrice && prod.originalPrice > prod.price ? Math.round((1 - prod.price/prod.originalPrice)*100) : 0;
                    const hasBadge = prod.badgeImage || prod.badgeText;
                    const inStock = prod.stock > 0;
                    html += `<div class="product-card" data-product-id="${prod.id}">`;
                    html += `<div class="image-section">`;
                    html += `<img src="${prod.image}" class="product-image" onerror="this.src='https://placehold.co/400x400/eeeeee/aaaaaa?text=Product'">`;
                    html += `<div class="product-badges">`;
                    if (prod.is_official_store) html += `<span class="badge official">Official Store</span>`;
                    if (prod.is_non_returnable) html += `<span class="badge nonreturn">Non-returnable</span>`;
                    if (inStock) html += `<span class="badge stock">In stock</span>`; else html += `<span class="badge outstock">Out of stock</span>`;
                    html += `</div>`;
                    if (hasBadge) {
                        html += `<div class="product-badge-bottom">`;
                        if (prod.badgeImage) html += `<img src="${prod.badgeImage}" alt="badge">`;
                        if (prod.badgeText) html += `<span>${prod.badgeText}</span>`;
                        html += `</div>`;
                    }
                    html += `</div>`;
                    html += `<div class="product-info">
                        <div class="product-name">${prod.name}</div>
                        <div class="price-discount">`;
                    if (discount > 0) {
                        html += `<span class="product-price">KSh ${prod.price.toLocaleString()}</span>
                            <span class="original-price">KSh ${prod.originalPrice.toLocaleString()}</span>
                            <span class="discount-badge">-${discount}%</span>`;
                    } else {
                        html += `<span class="product-price">KSh ${prod.price.toLocaleString()}</span>`;
                    }
                    html += `</div><div class="product-rating"><i class="fas fa-star"></i> ${prod.rating} (${prod.sold}+ sold)</div>`;
                    html += `<div class="stock-status ${inStock ? '' : 'out'}">${inStock ? 'In stock' : 'Out of stock'}</div>`;
                    html += `<button class="add-to-cart-btn" data-id="${prod.id}" ${!inStock ? 'disabled' : ''}><i class="fas fa-cart-plus"></i> Add to cart</button>`;
                    
                    // Admin can edit/delete any product; sellers can edit/delete their own
                    if ((currentUserProfile?.role === 'admin') || (currentUserProfile?.role === 'seller' && prod.seller_id === currentUser?.id)) {
                        html += `<div class="admin-controls"><i class="fas fa-edit edit-btn" data-id="${prod.id}"></i><i class="fas fa-trash delete-btn" data-id="${prod.id}"></i></div>`;
                    }
                    html += `</div></div>`;
                });
                if (filtered.length === 0) html = '<div style="grid-column:span 2; text-align:center; padding:40px;">No products</div>';
                productGrid.innerHTML = html;

                // Also viewed: random 5 products not in filtered
                const otherProducts = products.filter(p => !filtered.includes(p)).sort(() => 0.5 - Math.random()).slice(0, 5);
                if (otherProducts.length > 0) {
                    let alsoHtml = '';
                    otherProducts.forEach(p => {
                        alsoHtml += `<div class="also-item" data-product-id="${p.id}">
                            <img src="${p.image}" onerror="this.src='https://placehold.co/120x120'">
                            <div class="name">${p.name}</div>
                            <div class="price">KSh ${p.price}</div>
                        </div>`;
                    });
                    alsoViewedList.innerHTML = alsoHtml;
                    alsoViewedSection.style.display = 'block';
                } else {
                    alsoViewedSection.style.display = 'none';
                }
            }

            function renderCartModal() {
                if (cart.length === 0) { cartItemsList.innerHTML = '<p style="text-align:center;color:#aaa;">Cart empty</p>'; cartTotalSpan.innerText = 'Total: KSh 0'; return; }
                let itemsHtml = '', total = 0;
                cart.forEach(item => {
                    const prod = products.find(p => p.id === item.id);
                    if (!prod) return;
                    total += prod.price * item.quantity;
                    itemsHtml += `<div class="cart-item" data-id="${item.id}"><img src="${prod.image}" class="cart-item-img"><div class="cart-item-details"><div class="cart-item-name">${prod.name}</div><div class="cart-item-price">KSh ${prod.price}</div><div class="cart-item-qty"><button class="cart-qty-minus" data-id="${item.id}">-</button><span>${item.quantity}</span><button class="cart-qty-plus" data-id="${item.id}">+</button><i class="fas fa-trash" style="margin-left:auto; color:#c0392b; cursor:pointer;" data-id="${item.id}" data-remove></i></div></div></div>`;
                });
                cartItemsList.innerHTML = itemsHtml;
                cartTotalSpan.innerText = `Total: KSh ${total}`;
            }

            function renderNotifications() {
                notificationsList.innerHTML = '<p style="text-align:center; color:#aaa;">No notifications</p>';
            }

            function refreshUI() {
                renderCategories();
                renderBanners();
                renderProducts();
                updateCartCount();
                
                // Update badges
                if (currentUserProfile?.role === 'admin') {
                    adminBadge.style.display = 'inline-flex';
                    sellerBadge.style.display = 'none';
                    addProductBtn.style.display = 'flex';
                } else if (currentUserProfile?.role === 'seller' && currentUserProfile.seller_status === 'approved') {
                    adminBadge.style.display = 'none';
                    sellerBadge.style.display = 'inline-flex';
                    addProductBtn.style.display = 'flex';
                } else {
                    adminBadge.style.display = 'none';
                    sellerBadge.style.display = 'none';
                    addProductBtn.style.display = 'none';
                }

                navItems.forEach(item => item.classList.remove('active'));
                if (activePromo) {
                    document.querySelector('[data-nav="promo"]').classList.add('active');
                } else {
                    document.querySelector('[data-nav="home"]').classList.add('active');
                }

                // Update delivery dates in checkout modal (if open)
                updateDeliveryDates();
            }

            function updateDeliveryDates() {
                const dates = getDeliveryDates();
                doorStart.innerText = dates.doorStartStr;
                doorEnd.innerText = dates.doorEndStr;
                doorTimer.innerText = dates.timer;
                pickupStart.innerText = dates.pickupStartStr;
                pickupEnd.innerText = dates.pickupEndStr;
            }

            // ========== AUTH FUNCTIONS ==========
            async function signUp(email, password) {
                const { data, error } = await supabase.auth.signUp({ email, password });
                if (error) {
                    alert('Sign up error: ' + error.message);
                } else {
                    alert('Sign up successful! You can now log in.');
                    authModal.style.display = 'none';
                }
            }

            async function signIn(email, password) {
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) {
                    alert('Login error: ' + error.message);
                } else {
                    currentUser = data.user;
                    currentUserProfile = await getOrCreateProfile(currentUser);
                    authModal.style.display = 'none';
                    refreshUI();
                }
            }

            async function signOut() {
                await supabase.auth.signOut();
                currentUser = null;
                currentUserProfile = null;
                refreshUI();
                profileModal.style.display = 'none';
            }

            // ========== ORDER FUNCTIONS ==========
            async function placeOrderWithDetails() {
                if (!currentUser) {
                    alert('Please login to place an order');
                    openAuthModal();
                    return;
                }
                if (cart.length === 0) {
                    alert('Cart is empty');
                    return;
                }
                // Reset delivery selection
                document.querySelectorAll('.delivery-option').forEach(opt => opt.classList.remove('selected'));
                deliveryDoor.classList.add('selected');
                addressField.style.display = 'block';
                updateDeliveryDates();
                checkoutDetailsModal.style.display = 'flex';
            }

            // Delivery option click
            deliveryDoor.addEventListener('click', () => {
                deliveryDoor.classList.add('selected');
                deliveryPickup.classList.remove('selected');
                addressField.style.display = 'block';
            });
            deliveryPickup.addEventListener('click', () => {
                deliveryPickup.classList.add('selected');
                deliveryDoor.classList.remove('selected');
                addressField.style.display = 'none';
            });

            checkoutConfirm.addEventListener('click', async () => {
                const name = checkoutName.value.trim();
                const phone = checkoutPhone.value.trim();
                let address = checkoutAddress.value.trim();
                const deliveryMethod = deliveryDoor.classList.contains('selected') ? 'door' : 'pickup';
                if (deliveryMethod === 'door' && !address) {
                    alert('Please enter your shipping address');
                    return;
                }
                if (!name || !phone) {
                    alert('Please fill in name and phone');
                    return;
                }
                const paymentMethod = document.querySelector('input[name="payment"]:checked')?.value;
                if (!paymentMethod) {
                    alert('Please select payment method');
                    return;
                }

                let total = 0;
                const orderItems = cart.map(item => {
                    const prod = products.find(p => p.id === item.id);
                    total += prod.price * item.quantity;
                    return {
                        product_id: item.id,
                        quantity: item.quantity,
                        price: prod.price
                    };
                });

                const deliveryFee = deliveryMethod === 'door' ? parseInt(settings.delivery_fee) : 0;
                total += deliveryFee;

                const dates = getDeliveryDates();
                const estimatedStart = deliveryMethod === 'door' ? dates.doorStart : dates.pickupStart;
                const estimatedEnd = deliveryMethod === 'door' ? dates.doorEnd : dates.pickupEnd;

                const newOrder = {
                    user_id: currentUser.id,
                    user_email: currentUser.email,
                    shipping_name: name,
                    shipping_phone: phone,
                    shipping_address: deliveryMethod === 'door' ? address : 'Pickup at station',
                    notes: checkoutNotes.value.trim(),
                    status: 'ordered',
                    total_amount: total,
                    payment_method: paymentMethod,
                    delivery_method: deliveryMethod,
                    delivery_fee: deliveryFee,
                    estimated_delivery_start: estimatedStart.toISOString().split('T')[0], // store as YYYY-MM-DD
                    estimated_delivery_end: estimatedEnd.toISOString().split('T')[0],
                    created_at: new Date().toISOString(),
                    items: JSON.stringify(orderItems)
                };

                const { data, error } = await supabase.from('orders').insert([newOrder]).select();

                if (error) {
                    alert('Order failed: ' + error.message);
                } else {
                    alert('Order placed successfully!');

                    const referrerId = localStorage.getItem('referrer');
                    if (referrerId) {
                        for (let item of orderItems) {
                            const prod = products.find(p => p.id === item.product_id);
                            if (prod && prod.commission_percent) {
                                const commissionAmount = Math.round(item.price * item.quantity * prod.commission_percent / 100);
                                await supabase.from('referral_commissions').insert([{
                                    referrer_id: referrerId,
                                    order_id: data[0].id,
                                    product_id: item.product_id,
                                    amount: commissionAmount,
                                    status: 'pending'
                                }]);
                            }
                        }
                        localStorage.removeItem('referrer');
                    }

                    cart = [];
                    localStorage.setItem('cart', JSON.stringify(cart));
                    renderCartModal();
                    updateCartCount();
                    checkoutDetailsModal.style.display = 'none';
                    cartModal.style.display = 'none';
                }
            });

            checkoutCancel.addEventListener('click', () => {
                checkoutDetailsModal.style.display = 'none';
            });

            // ========== REVIEW FUNCTIONS ==========
            async function openReviewModal(orderId) {
                currentOrderIdForReview = orderId;
                reviewRatingInput.value = 0;
                stars.forEach(s => s.classList.remove('selected'));
                reviewComment.value = '';
                reviewModal.style.display = 'flex';
            }

            reviewSubmit.addEventListener('click', async () => {
                if (!currentUser) {
                    alert('You must be logged in');
                    return;
                }
                const rating = parseInt(reviewRatingInput.value);
                if (rating < 1 || rating > 5) {
                    alert('Please select a rating');
                    return;
                }
                const comment = reviewComment.value.trim();
                if (!comment) {
                    alert('Please enter a comment');
                    return;
                }

                const order = orders.find(o => o.id === currentOrderIdForReview);
                if (!order) return;
                const items = JSON.parse(order.items || '[]');
                const productId = items.length > 0 ? items[0].product_id : null;

                const { error } = await supabase.from('reviews').insert([{
                    user_id: currentUser.id,
                    order_id: currentOrderIdForReview,
                    product_id: productId,
                    rating,
                    comment
                }]);

                if (error) {
                    alert('Error submitting review: ' + error.message);
                } else {
                    alert('Review submitted! Thank you.');
                    reviewModal.style.display = 'none';
                }
            });

            reviewCancel.addEventListener('click', () => {
                reviewModal.style.display = 'none';
            });

            // Render user orders with review buttons
            async function renderUserOrders() {
                if (!currentUser) return;
                const { data: userOrders, error } = await supabase
                    .from('orders')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });
                if (error) console.error(error);

                const { data: userReviews } = await supabase
                    .from('reviews')
                    .select('order_id')
                    .eq('user_id', currentUser.id);
                const reviewedOrderIds = new Set((userReviews || []).map(r => r.order_id));

                let html = '';
                if (userOrders && userOrders.length > 0) {
                    userOrders.forEach(order => {
                        const statusClass = `status-${order.status.replace('_', '-')}`;
                        const canReview = order.status === 'delivered' && !reviewedOrderIds.has(order.id);
                        const startDate = order.estimated_delivery_start ? new Date(order.estimated_delivery_start).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) : '';
                        const endDate = order.estimated_delivery_end ? new Date(order.estimated_delivery_end).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) : '';
                        html += `<div style="border-bottom:1px solid #eee; padding:10px 0;">
                            <div><strong>Order #${order.id.slice(-6)}</strong> <span class="status-badge ${statusClass}">${order.status}</span></div>
                            <div>Total: KSh ${order.total_amount} (incl. delivery)</div>
                            <div>Delivery: ${order.delivery_method === 'door' ? 'Door' : 'Pickup'}</div>
                            <div>Payment: ${order.payment_method}</div>
                            <div>Est. delivery: ${startDate} - ${endDate}</div>
                            <div>${new Date(order.created_at).toLocaleDateString()}</div>`;
                        if (canReview) {
                            html += `<button class="btn-save review-order-btn" data-order-id="${order.id}" style="margin-top:8px; padding:4px 12px; font-size:0.8rem;">Write a Review</button>`;
                        } else if (reviewedOrderIds.has(order.id)) {
                            html += `<div style="margin-top:8px; font-style:italic; color:#888;">✓ Review submitted</div>`;
                        }
                        html += `</div>`;
                    });
                } else {
                    html = '<p>No orders yet.</p>';
                }
                userOrdersList.innerHTML = html;

                document.querySelectorAll('.review-order-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const orderId = e.target.dataset.orderId;
                        openReviewModal(orderId);
                    });
                });
            }

            // ========== SELLER FUNCTIONS ==========
            async function renderSellerDashboard() {
                if (!currentUser || currentUserProfile?.role !== 'seller' || currentUserProfile.seller_status !== 'approved') return;
                
                sellerDashboard.style.display = 'block';
                
                const sellerProds = products.filter(p => p.seller_id === currentUser.id);
                let prodHtml = '';
                sellerProds.forEach(prod => {
                    prodHtml += `<div class="prod-list-item">
                        <img src="${prod.image}" style="width:30px; height:30px; border-radius:50%; object-fit:cover;">
                        <span>${prod.name} (KSh ${prod.price})</span>
                        <button class="edit-prod-btn" data-id="${prod.id}" style="margin-left:auto; background:none; border:none; color:var(--tokped-green);"><i class="fas fa-edit"></i></button>
                        <button class="delete-prod-btn" data-id="${prod.id}" style="background:none; border:none; color:#c0392b;"><i class="fas fa-trash"></i></button>
                    </div>`;
                });
                if (sellerProds.length === 0) prodHtml = '<p>You have no products yet.</p>';
                sellerProductsList.innerHTML = prodHtml;

                let ordersHtml = '';
                for (let order of orders) {
                    const items = JSON.parse(order.items || '[]');
                    const sellerItems = items.filter(item => {
                        const prod = products.find(p => p.id === item.product_id);
                        return prod && prod.seller_id === currentUser.id;
                    });
                    if (sellerItems.length > 0) {
                        ordersHtml += `<div style="border-bottom:1px solid #eee; padding:10px 0;">
                            <div><strong>Order #${order.id.slice(-6)}</strong> <span class="status-badge status-${order.status.replace('_', '-')}">${order.status}</span></div>
                            <div>Customer: ${order.shipping_name}</div>
                            <div>Items: ${sellerItems.map(i => `${i.quantity}x ${products.find(p => p.id === i.product_id)?.name}`).join(', ')}</div>
                        </div>`;
                    }
                }
                if (ordersHtml === '') ordersHtml = '<p>No orders for your products yet.</p>';
                sellerOrdersList.innerHTML = ordersHtml;
            }

            sellerAddProductBtn.addEventListener('click', () => {
                currentProductId = null;
                prodName.value = ''; 
                prodPrice.value = ''; 
                prodCost.value = ''; 
                prodOriginalPrice.value = ''; 
                prodCommission.value = '10'; 
                prodStock.value = '10';
                prodReturnPolicy.value = 'Free return within 7 days';
                prodOfficial.checked = false;
                prodNonReturn.checked = false;
                prodImage.value = ''; 
                prodImages.value = ''; 
                prodDescription.value = ''; 
                prodAffiliateLink.value = ''; 
                prodRating.value = '4.5'; 
                prodSold.value = '0'; 
                prodBadgeImage.value = ''; 
                prodBadgeText.value = '';

                let catOptions = '';
                categories.forEach(c => catOptions += `<option value="${c.id}">${c.name}</option>`);
                prodCategory.innerHTML = catOptions;
                if (prodCategory.options.length > 0) prodCategory.selectedIndex = 0;
                
                productEditModal.style.display = 'flex';
                profileModal.style.display = 'none';
            });

            // ========== SELLER APPLICATION ==========
            function openSellerApplyModal() {
                sellerApplyModal.style.display = 'flex';
            }

            sellerApplyCancel.addEventListener('click', () => {
                sellerApplyModal.style.display = 'none';
            });

            sellerApplyConfirm.addEventListener('click', async () => {
                if (!currentUser) return;
                const { error } = await supabase
                    .from('profiles')
                    .update({ seller_status: 'pending' })
                    .eq('user_id', currentUser.id);
                if (error) {
                    alert('Error: ' + error.message);
                } else {
                    alert('Application submitted! Admin will review.');
                    sellerApplyModal.style.display = 'none';
                    currentUserProfile.seller_status = 'pending';
                    refreshUI();
                }
            });

            // ========== ADMIN RENDERING ==========
            async function renderAdminOrders() {
                const { data: allOrders, error } = await supabase
                    .from('orders')
                    .select('*')
                    .order('created_at', { ascending: false });
                if (error) console.error(error);
                let html = '';
                if (allOrders && allOrders.length > 0) {
                    allOrders.forEach(order => {
                        const statusClass = `status-${order.status.replace('_', '-')}`;
                        const startDate = order.estimated_delivery_start ? new Date(order.estimated_delivery_start).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) : '';
                        const endDate = order.estimated_delivery_end ? new Date(order.estimated_delivery_end).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) : '';
                        html += `<div style="border-bottom:1px solid #eee; padding:10px 0;">
                            <div><strong>Order #${order.id.slice(-6)}</strong></div>
                            <div class="order-detail-item">Customer: ${order.user_email || 'N/A'} (${order.shipping_name})</div>
                            <div class="order-detail-item">Phone: ${order.shipping_phone}</div>
                            <div class="order-detail-item">Address: ${order.shipping_address}</div>
                            <div class="order-detail-item">Delivery: ${order.delivery_method}, Payment: ${order.payment_method}</div>
                            <div class="order-detail-item">Est. delivery: ${startDate} - ${endDate}</div>
                            ${order.notes ? `<div class="order-detail-item">Notes: ${order.notes}</div>` : ''}
                            <div class="order-detail-item">Total: KSh ${order.total_amount}</div>
                            <div>
                                <select class="order-status-select" data-order-id="${order.id}">
                                    <option value="ordered" ${order.status === 'ordered' ? 'selected' : ''}>Ordered</option>
                                    <option value="waiting_shipment" ${order.status === 'waiting_shipment' ? 'selected' : ''}>Waiting Shipment</option>
                                    <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>Shipped</option>
                                    <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                                </select>
                            </div>
                            <div>${new Date(order.created_at).toLocaleDateString()}</div>
                        </div>`;
                    });
                } else {
                    html = '<p>No orders.</p>';
                }
                adminOrdersListDiv.innerHTML = html;

                document.querySelectorAll('.order-status-select').forEach(select => {
                    select.addEventListener('change', async (e) => {
                        const orderId = e.target.dataset.orderId;
                        const newStatus = e.target.value;
                        const { error } = await supabase.from('orders').update({ status: newStatus }).eq('id', orderId);
                        if (error) {
                            alert('Error updating status: ' + error.message);
                        } else {
                            await loadAllData();
                        }
                    });
                });
            }

            async function renderUsersList() {
                const userMap = new Map();
                orders.forEach(order => {
                    if (!order.user_id) return;
                    if (!userMap.has(order.user_id)) {
                        userMap.set(order.user_id, {
                            user_id: order.user_id,
                            email: order.user_email || 'Unknown',
                            total_orders: 0,
                            total_spent: 0,
                            last_order: order.created_at
                        });
                    }
                    const user = userMap.get(order.user_id);
                    user.total_orders += 1;
                    user.total_spent += order.total_amount;
                    if (new Date(order.created_at) > new Date(user.last_order)) {
                        user.last_order = order.created_at;
                    }
                });

                let html = '';
                for (let [_, user] of userMap) {
                    html += `<div class="user-list-item">
                        <div><strong>${user.email}</strong> (ID: ${user.user_id.slice(-6)})</div>
                        <div>Orders: ${user.total_orders} | Total spent: KSh ${user.total_spent}</div>
                        <div>Last order: ${new Date(user.last_order).toLocaleDateString()}</div>
                    </div>`;
                }
                if (html === '') html = '<p>No users yet.</p>';
                usersListDiv.innerHTML = html;
            }

            async function renderSellerApplications() {
                const pendingSellers = profiles.filter(p => p.seller_status === 'pending');
                let html = '';
                pendingSellers.forEach(prof => {
                    html += `<div class="user-list-item">
                        <div><strong>${prof.email}</strong></div>
                        <div>Applied: ${new Date(prof.created_at).toLocaleDateString()}</div>
                        <div>
                            <button class="btn-save approve-seller" data-user-id="${prof.user_id}" style="padding:4px 12px;">Approve</button>
                            <button class="btn-cancel reject-seller" data-user-id="${prof.user_id}" style="padding:4px 12px;">Reject</button>
                        </div>
                    </div>`;
                });
                if (html === '') html = '<p>No pending applications.</p>';
                sellerApplicationsListDiv.innerHTML = html;

                document.querySelectorAll('.approve-seller').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const userId = e.target.dataset.userId;
                        await supabase.from('profiles').update({ role: 'seller', seller_status: 'approved' }).eq('user_id', userId);
                        loadAllData();
                    });
                });
                document.querySelectorAll('.reject-seller').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const userId = e.target.dataset.userId;
                        await supabase.from('profiles').update({ seller_status: 'rejected' }).eq('user_id', userId);
                        loadAllData();
                    });
                });
            }

            async function renderReviewsList() {
                const reviewsWithEmail = await Promise.all(reviews.map(async (rev) => {
                    const { data: order } = await supabase.from('orders').select('user_email').eq('id', rev.order_id).single();
                    return { ...rev, user_email: order?.user_email || 'Unknown' };
                }));

                let html = '';
                reviewsWithEmail.forEach(rev => {
                    const stars = '★'.repeat(rev.rating) + '☆'.repeat(5 - rev.rating);
                    html += `<div class="review-list-item">
                        <div><strong>${rev.user_email}</strong> on ${new Date(rev.created_at).toLocaleDateString()}</div>
                        <div>Rating: ${stars} (${rev.rating}/5)</div>
                        <div>Comment: ${rev.comment}</div>
                    </div>`;
                });
                if (html === '') html = '<p>No reviews yet.</p>';
                reviewsListDiv.innerHTML = html;
            }

            async function renderAnalytics() {
                const { data: deliveredOrders } = await supabase
                    .from('orders')
                    .select('total_amount')
                    .eq('status', 'delivered');
                const revenue = deliveredOrders ? deliveredOrders.reduce((sum, o) => sum + o.total_amount, 0) : 0;
                document.getElementById('totalRevenue').innerText = revenue.toLocaleString();

                const { data: allOrders } = await supabase.from('orders').select('items, status');
                let profit = 0;
                if (allOrders) {
                    for (let order of allOrders) {
                        if (order.status === 'delivered') {
                            const items = JSON.parse(order.items || '[]');
                            for (let item of items) {
                                const prod = products.find(p => p.id === item.product_id);
                                if (prod && prod.costPrice) {
                                    profit += (prod.price - prod.costPrice) * item.quantity;
                                }
                            }
                        }
                    }
                }
                document.getElementById('totalProfit').innerText = profit.toLocaleString();

                const { data: allItems } = await supabase.from('orders').select('items, status');
                let totalSold = 0;
                if (allItems) {
                    allItems.forEach(order => {
                        if (order.status === 'delivered') {
                            const items = JSON.parse(order.items || '[]');
                            items.forEach(item => totalSold += item.quantity);
                        }
                    });
                }
                document.getElementById('totalSold').innerText = totalSold;

                const statusCounts = {};
                const { data: allOrdersStatus } = await supabase.from('orders').select('status');
                if (allOrdersStatus) {
                    allOrdersStatus.forEach(o => {
                        statusCounts[o.status] = (statusCounts[o.status] || 0) + 1;
                    });
                }
                document.getElementById('ordersByStatus').innerText = statusCounts['ordered'] || 0;

                let breakdownHtml = '';
                for (let [status, count] of Object.entries(statusCounts)) {
                    breakdownHtml += `<div>${status}: ${count}</div>`;
                }
                document.getElementById('statusBreakdown').innerHTML = breakdownHtml;
            }

            // ========== REFERRAL DASHBOARD ==========
            async function loadReferralStats() {
                if (!currentUser) return;
                const { count: clicks } = await supabase
                    .from('referral_clicks')
                    .select('*', { count: 'exact', head: true })
                    .eq('referrer_id', currentUser.id);
                totalClicksSpan.innerText = clicks || 0;

                const { data: commissions } = await supabase
                    .from('referral_commissions')
                    .select('amount, status')
                    .eq('referrer_id', currentUser.id);
                let pending = 0, paid = 0;
                if (commissions) {
                    commissions.forEach(c => {
                        if (c.status === 'pending') pending += c.amount;
                        else if (c.status === 'paid') paid += c.amount;
                    });
                }
                pendingEarningsSpan.innerText = pending;
                paidEarningsSpan.innerText = paid;
                totalConversionsSpan.innerText = commissions ? commissions.length : 0;
            }

            // ========== EVENT LISTENERS ==========
            categoryContainer.addEventListener('click', (e) => {
                const chip = e.target.closest('.chip');
                if (!chip) return;
                const catId = chip.dataset.catId;
                activeCategory = catId === 'all' ? null : catId;
                activePromo = false;
                renderCategories();
                renderProducts();
            });

            // Open product detail
            productGrid.addEventListener('click', (e) => {
                if (e.target.closest('.add-to-cart-btn')) return;
                const card = e.target.closest('.product-card');
                if (!card) return;
                const prodId = card.dataset.productId;
                const prod = products.find(p => p.id === prodId);
                if (prod) {
                    detailProductName.innerText = prod.name;
                    detailMainImage.src = prod.image;
                    detailDescription.innerText = prod.description || 'No description';
                    detailPrice.innerText = `KSh ${prod.price.toLocaleString()}`;
                    if (prod.originalPrice && prod.originalPrice > prod.price) {
                        detailOriginalPrice.innerText = `KSh ${prod.originalPrice.toLocaleString()}`;
                        const discount = Math.round((1 - prod.price/prod.originalPrice)*100);
                        detailDiscount.innerText = `-${discount}%`;
                        detailDiscount.style.display = 'inline-block';
                    } else {
                        detailOriginalPrice.innerText = '';
                        detailDiscount.style.display = 'none';
                    }
                    // Badges
                    detailOfficial.style.display = prod.is_official_store ? 'inline-block' : 'none';
                    detailNonReturn.style.display = prod.is_non_returnable ? 'inline-block' : 'none';
                    const inStock = prod.stock > 0;
                    detailInStock.style.display = inStock ? 'inline-block' : 'none';
                    detailOutStock.style.display = !inStock ? 'inline-block' : 'none';
                    detailStock.innerText = inStock ? `In stock (${prod.stock} available)` : 'Out of stock';
                    detailReturnPolicy.innerText = prod.return_policy || 'Free return within 7 days';

                    let galleryHtml = '';
                    if (prod.images && Array.isArray(prod.images)) {
                        prod.images.forEach(img => {
                            galleryHtml += `<img src="${img}" class="gallery-image" onclick="document.getElementById('detailMainImage').src='${img}'">`;
                        });
                    }
                    detailGallery.innerHTML = galleryHtml;

                    if (prod.affiliate_link) {
                        affiliateLinkBtn.href = prod.affiliate_link;
                        affiliateLinkBtn.style.display = 'flex';
                    } else {
                        affiliateLinkBtn.style.display = 'none';
                    }

                    if (currentUser) {
                        const refLink = `${window.location.origin}?ref=${currentUser.id}&product=${prod.id}`;
                        copyReferralLinkBtn.onclick = () => {
                            navigator.clipboard.writeText(refLink);
                            alert('Referral link copied to clipboard!');
                        };
                        copyReferralLinkBtn.style.display = 'flex';
                    } else {
                        copyReferralLinkBtn.style.display = 'none';
                    }

                    detailAddToCart.dataset.id = prodId;
                    detailAddToCart.disabled = !inStock;
                    detailModal.style.display = 'flex';
                }
            });

            detailAddToCart.addEventListener('click', () => {
                const prodId = detailAddToCart.dataset.id;
                const prod = products.find(p => p.id === prodId);
                if (prod.stock <= 0) {
                    alert('Out of stock');
                    return;
                }
                const existing = cart.find(item => item.id === prodId);
                if (existing) existing.quantity++; else cart.push({ id: prodId, quantity: 1 });
                localStorage.setItem('cart', JSON.stringify(cart));
                renderCartModal();
                updateCartCount();
                detailModal.style.display = 'none';
            });

            closeDetailBtn.addEventListener('click', () => detailModal.style.display = 'none');

            // Also viewed click
            alsoViewedList.addEventListener('click', (e) => {
                const item = e.target.closest('.also-item');
                if (!item) return;
                const prodId = item.dataset.productId;
                const prod = products.find(p => p.id === prodId);
                if (prod) {
                    // Trigger product detail
                    const fakeEvent = { target: { closest: () => ({ dataset: { productId: prodId } }) } };
                    productGrid.dispatchEvent(new CustomEvent('click', { detail: fakeEvent }));
                }
            });

            // Add to cart buttons
            productGrid.addEventListener('click', (e) => {
                const btn = e.target.closest('.add-to-cart-btn');
                if (!btn) return;
                const prodId = btn.dataset.id;
                const prod = products.find(p => p.id === prodId);
                if (prod.stock <= 0) {
                    alert('Out of stock');
                    return;
                }
                const existing = cart.find(item => item.id === prodId);
                if (existing) existing.quantity++; else cart.push({ id: prodId, quantity: 1 });
                localStorage.setItem('cart', JSON.stringify(cart));
                renderCartModal();
                updateCartCount();
            });

            // Edit/delete product (admin or seller)
            productGrid.addEventListener('click', async (e) => {
                if (!currentUser) return;
                if (e.target.closest('.edit-btn')) {
                    const prodId = e.target.closest('.edit-btn').dataset.id;
                    const prod = products.find(p => p.id === prodId);
                    if (!prod) return;
                    if (currentUserProfile?.role !== 'admin' && prod.seller_id !== currentUser.id) {
                        alert('You can only edit your own products.');
                        return;
                    }
                    if (prod) {
                        currentProductId = prodId;
                        prodName.value = prod.name || '';
                        prodPrice.value = prod.price || '';
                        prodCost.value = prod.costPrice || '';
                        prodOriginalPrice.value = prod.originalPrice || '';
                        prodCommission.value = prod.commission_percent || 10;
                        prodStock.value = prod.stock || 10;
                        prodReturnPolicy.value = prod.return_policy || 'Free return within 7 days';
                        prodOfficial.checked = prod.is_official_store || false;
                        prodNonReturn.checked = prod.is_non_returnable || false;
                        prodImage.value = prod.image || '';
                        prodImages.value = (prod.images || []).join(', ');
                        prodDescription.value = prod.description || '';
                        prodAffiliateLink.value = prod.affiliate_link || '';
                        prodRating.value = prod.rating || 4.5;
                        prodSold.value = prod.sold || 0;
                        prodBadgeImage.value = prod.badgeImage || '';
                        prodBadgeText.value = prod.badgeText || '';

                        let catOptions = '';
                        categories.forEach(c => catOptions += `<option value="${c.id}" ${prod.category === c.id ? 'selected' : ''}>${c.name}</option>`);
                        prodCategory.innerHTML = catOptions;
                        productEditModal.style.display = 'flex';
                    }
                }
                if (e.target.closest('.delete-btn')) {
                    const prodId = e.target.closest('.delete-btn').dataset.id;
                    const prod = products.find(p => p.id === prodId);
                    if (!prod) return;
                    if (currentUserProfile?.role !== 'admin' && prod.seller_id !== currentUser.id) {
                        alert('You can only delete your own products.');
                        return;
                    }
                    if (confirm('Delete product?')) {
                        await supabase.from('products').delete().eq('id', prodId);
                    }
                }
            });

            cartIcon.addEventListener('click', () => { renderCartModal(); cartModal.style.display = 'flex'; });
            closeCartBtn.addEventListener('click', () => cartModal.style.display = 'none');

            cartItemsList.addEventListener('click', (e) => {
                const itemDiv = e.target.closest('.cart-item');
                if (!itemDiv) return;
                const prodId = itemDiv.dataset.id;
                const cartItem = cart.find(c => c.id === prodId);
                if (!cartItem) return;
                if (e.target.classList.contains('cart-qty-minus')) {
                    if (cartItem.quantity > 1) cartItem.quantity--; else cart = cart.filter(c => c.id !== prodId);
                    localStorage.setItem('cart', JSON.stringify(cart));
                    renderCartModal();
                } else if (e.target.classList.contains('cart-qty-plus')) {
                    cartItem.quantity++;
                    localStorage.setItem('cart', JSON.stringify(cart));
                    renderCartModal();
                } else if (e.target.classList.contains('fa-trash')) {
                    cart = cart.filter(c => c.id !== prodId);
                    localStorage.setItem('cart', JSON.stringify(cart));
                    renderCartModal();
                }
            });

            cartWhatsappBtn.addEventListener('click', () => {
                if (cart.length === 0) return alert('Cart empty');
                let msg = 'Hello, I want to order:%0A';
                let total = 0;
                cart.forEach(item => {
                    const prod = products.find(p => p.id === item.id);
                    if (prod) { msg += `- ${prod.name} x${item.quantity} = KSh ${prod.price * item.quantity}%0A`; total += prod.price * item.quantity; }
                });
                msg += `Total: KSh ${total}%0AThank you.`;
                window.open(`https://wa.me/${settings.wa_number}?text=${msg}`, '_blank');
            });

            checkoutBtn.addEventListener('click', placeOrderWithDetails);

            adminBadge.addEventListener('click', async () => {
                if (currentUserProfile?.role !== 'admin') return;
                await renderCategoriesList();
                await renderBannersList();
                await renderProductsList();
                await renderAdminOrders();
                await renderUsersList();
                await renderSellerApplications();
                await renderReviewsList();
                await renderAnalytics();
                waNumberInput.value = settings.wa_number;
                deliveryFeeInput.value = settings.delivery_fee;
                pickupStationsInput.value = settings.pickup_stations;
                adminModal.style.display = 'flex';
            });
            closeAdminModal.addEventListener('click', () => adminModal.style.display = 'none');

            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
                    document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
                    if (tab.dataset.tab === 'analytics') renderAnalytics();
                    if (tab.dataset.tab === 'orders') renderAdminOrders();
                    if (tab.dataset.tab === 'users') renderUsersList();
                    if (tab.dataset.tab === 'reviews') renderReviewsList();
                    if (tab.dataset.tab === 'sellers') renderSellerApplications();
                });
            });

            async function renderCategoriesList() {
                let html = '';
                categories.forEach(cat => {
                    html += `<div class="cat-list-item">`;
                    if (cat.image) {
                        html += `<img src="${cat.image}" alt="${cat.name}">`;
                    } else {
                        html += `<i class="fas ${cat.icon}"></i>`;
                    }
                    html += `<span>${cat.name}</span>
                        <button class="edit-cat-btn" data-id="${cat.id}" style="margin-left:auto; background:none; border:none; color:var(--tokped-green);"><i class="fas fa-edit"></i></button>
                        <button class="delete-cat-btn" data-id="${cat.id}" style="background:none; border:none; color:#c0392b;"><i class="fas fa-trash"></i></button>
                    </div>`;
                });
                categoriesListDiv.innerHTML = html;
            }

            async function renderBannersList() {
                let html = '';
                banners.forEach(b => {
                    html += `<div class="banner-list-item"><img src="${b.image}" style="width:50px; height:30px; object-fit:cover;"> <span>${b.title}</span>
                        <button class="edit-banner-btn" data-id="${b.id}" style="margin-left:auto; background:none; border:none; color:var(--tokped-green);"><i class="fas fa-edit"></i></button>
                        <button class="delete-banner-btn" data-id="${b.id}" style="background:none; border:none; color:#c0392b;"><i class="fas fa-trash"></i></button>
                    </div>`;
                });
                bannersListDiv.innerHTML = html;
            }

            async function renderProductsList() {
                let html = '';
                products.forEach(prod => {
                    html += `<div class="prod-list-item">`;
                    html += `<img src="${prod.image || 'https://placehold.co/30x30'}" alt="${prod.name}">`;
                    html += `<span>${prod.name} (KSh ${prod.price})</span>
                        <button class="edit-prod-btn" data-id="${prod.id}" style="margin-left:auto; background:none; border:none; color:var(--tokped-green);"><i class="fas fa-edit"></i></button>
                        <button class="delete-prod-btn" data-id="${prod.id}" style="background:none; border:none; color:#c0392b;"><i class="fas fa-trash"></i></button>
                    </div>`;
                });
                productsListDiv.innerHTML = html;
            }

            // Category CRUD
            addCategoryBtn.addEventListener('click', () => {
                currentCategoryId = null;
                catNameInput.value = ''; 
                catIconInput.value = 'fa-tag'; 
                catImageInput.value = '';
                categoryEditModal.style.display = 'flex';
            });

            categoriesListDiv.addEventListener('click', async (e) => {
                if (e.target.closest('.edit-cat-btn')) {
                    const id = e.target.closest('.edit-cat-btn').dataset.id;
                    const cat = categories.find(c => c.id === id);
                    if (cat) { 
                        currentCategoryId = id; 
                        catNameInput.value = cat.name; 
                        catIconInput.value = cat.icon; 
                        catImageInput.value = cat.image || ''; 
                        categoryEditModal.style.display = 'flex'; 
                    }
                }
                if (e.target.closest('.delete-cat-btn')) {
                    const id = e.target.closest('.delete-cat-btn').dataset.id;
                    if (confirm('Delete category?')) {
                        await supabase.from('categories').delete().eq('id', id);
                    }
                }
            });

            catModalSave.addEventListener('click', async () => {
                const name = catNameInput.value.trim(), icon = catIconInput.value.trim(), image = catImageInput.value.trim();
                if (!name) return alert('Category name is required');
                if (!icon) return alert('Icon class is required (e.g., fa-mobile-alt)');
                if (currentCategoryId) {
                    await supabase.from('categories').update({ name, icon, image }).eq('id', currentCategoryId);
                } else {
                    const newId = 'cat_' + Date.now() + Math.random().toString(36).substr(2, 4);
                    await supabase.from('categories').insert([{ id: newId, name, icon, image }]);
                }
                categoryEditModal.style.display = 'none';
            });
            catModalCancel.addEventListener('click', () => categoryEditModal.style.display = 'none');

            // Banner CRUD
            addBannerBtn.addEventListener('click', () => {
                currentBannerId = null;
                bannerImageInput.value = ''; bannerLinkInput.value = ''; bannerTitleInput.value = '';
                bannerEditModal.style.display = 'flex';
            });

            bannersListDiv.addEventListener('click', async (e) => {
                if (e.target.closest('.edit-banner-btn')) {
                    const id = e.target.closest('.edit-banner-btn').dataset.id;
                    const ban = banners.find(b => b.id === id);
                    if (ban) { currentBannerId = id; bannerImageInput.value = ban.image; bannerLinkInput.value = ban.link || ''; bannerTitleInput.value = ban.title || ''; bannerEditModal.style.display = 'flex'; }
                }
                if (e.target.closest('.delete-banner-btn')) {
                    const id = e.target.closest('.delete-banner-btn').dataset.id;
                    await supabase.from('banners').delete().eq('id', id);
                }
            });

            bannerModalSave.addEventListener('click', async () => {
                const img = bannerImageInput.value.trim(), link = bannerLinkInput.value.trim(), title = bannerTitleInput.value.trim();
                if (!img) return alert('Image URL required');
                if (currentBannerId) {
                    await supabase.from('banners').update({ image: img, link, title }).eq('id', currentBannerId);
                } else {
                    const newId = 'ban_' + Date.now() + Math.random().toString(36).substr(2, 4);
                    await supabase.from('banners').insert([{ id: newId, image: img, link, title }]);
                }
                bannerEditModal.style.display = 'none';
            });
            bannerModalCancel.addEventListener('click', () => bannerEditModal.style.display = 'none');

            // Product list actions (from admin panel)
            productsListDiv.addEventListener('click', async (e) => {
                if (e.target.closest('.edit-prod-btn')) {
                    const prodId = e.target.closest('.edit-prod-btn').dataset.id;
                    const prod = products.find(p => p.id === prodId);
                    if (prod) {
                        currentProductId = prodId;
                        prodName.value = prod.name;
                        prodPrice.value = prod.price;
                        prodCost.value = prod.costPrice || '';
                        prodOriginalPrice.value = prod.originalPrice || '';
                        prodCommission.value = prod.commission_percent || 10;
                        prodStock.value = prod.stock || 10;
                        prodReturnPolicy.value = prod.return_policy || 'Free return within 7 days';
                        prodOfficial.checked = prod.is_official_store || false;
                        prodNonReturn.checked = prod.is_non_returnable || false;
                        prodImage.value = prod.image || '';
                        prodImages.value = (prod.images || []).join(', ');
                        prodDescription.value = prod.description || '';
                        prodAffiliateLink.value = prod.affiliate_link || '';
                        prodRating.value = prod.rating || 4.5;
                        prodSold.value = prod.sold || 0;
                        prodBadgeImage.value = prod.badgeImage || '';
                        prodBadgeText.value = prod.badgeText || '';
                        let catOptions = '';
                        categories.forEach(c => catOptions += `<option value="${c.id}" ${prod.category === c.id ? 'selected' : ''}>${c.name}</option>`);
                        prodCategory.innerHTML = catOptions;
                        adminModal.style.display = 'none';
                        productEditModal.style.display = 'flex';
                    }
                }
                if (e.target.closest('.delete-prod-btn')) {
                    const prodId = e.target.closest('.delete-prod-btn').dataset.id;
                    if (confirm('Delete product?')) {
                        await supabase.from('products').delete().eq('id', prodId);
                    }
                }
            });

            // Add product button (main)
            addProductBtn.addEventListener('click', () => {
                if (!currentUser || (currentUserProfile?.role !== 'admin' && currentUserProfile?.role !== 'seller')) {
                    alert('You do not have permission to add products.');
                    return;
                }
                currentProductId = null;
                prodName.value = ''; 
                prodPrice.value = ''; 
                prodCost.value = ''; 
                prodOriginalPrice.value = ''; 
                prodCommission.value = '10'; 
                prodStock.value = '10';
                prodReturnPolicy.value = 'Free return within 7 days';
                prodOfficial.checked = false;
                prodNonReturn.checked = false;
                prodImage.value = ''; 
                prodImages.value = ''; 
                prodDescription.value = ''; 
                prodAffiliateLink.value = ''; 
                prodRating.value = '4.5'; 
                prodSold.value = '0'; 
                prodBadgeImage.value = ''; 
                prodBadgeText.value = '';

                let catOptions = '';
                categories.forEach(c => catOptions += `<option value="${c.id}">${c.name}</option>`);
                prodCategory.innerHTML = catOptions;
                if (prodCategory.options.length > 0) prodCategory.selectedIndex = 0;
                productEditModal.style.display = 'flex';
            });

            // Save product
            productModalSave.addEventListener('click', async () => {
                const name = prodName.value.trim(), price = parseFloat(prodPrice.value);
                if (!name || isNaN(price)) return alert('Name and price required');
                const imagesArray = prodImages.value.split(',').map(s => s.trim()).filter(s => s);
                const productData = {
                    name,
                    price,
                    costPrice: parseFloat(prodCost.value) || undefined,
                    originalPrice: parseFloat(prodOriginalPrice.value) || undefined,
                    commission_percent: parseInt(prodCommission.value) || 10,
                    stock: parseInt(prodStock.value) || 10,
                    return_policy: prodReturnPolicy.value.trim() || 'Free return within 7 days',
                    is_official_store: prodOfficial.checked,
                    is_non_returnable: prodNonReturn.checked,
                    image: prodImage.value.trim() || 'https://placehold.co/400x400/03ac0e/white?text=Product',
                    images: imagesArray,
                    description: prodDescription.value.trim(),
                    affiliate_link: prodAffiliateLink.value.trim() || undefined,
                    category: prodCategory.value,
                    rating: parseFloat(prodRating.value) || 4.5,
                    sold: parseInt(prodSold.value) || 0,
                    badgeImage: prodBadgeImage.value.trim() || '',
                    badgeText: prodBadgeText.value.trim() || '',
                    seller_id: currentUser?.id
                };
                if (currentProductId) {
                    const { error } = await supabase.from('products').update(productData).eq('id', currentProductId);
                    if (error) alert('Update error: ' + error.message);
                } else {
                    const newId = 'prod_' + Date.now() + Math.random().toString(36).substr(2, 4);
                    const { error } = await supabase.from('products').insert([{ id: newId, ...productData }]);
                    if (error) alert('Insert error: ' + error.message);
                }
                productEditModal.style.display = 'none';
            });
            productModalCancel.addEventListener('click', () => productEditModal.style.display = 'none');

            // Debounced search
            searchInput.addEventListener('input', (e) => {
                if (searchTimeout) clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    searchTerm = e.target.value;
                    renderProducts();
                }, 300);
            });

            // Save settings
            saveSettingsBtn.addEventListener('click', async () => {
                const newWa = waNumberInput.value.trim();
                const newFee = deliveryFeeInput.value.trim();
                const newStations = pickupStationsInput.value.trim();
                if (!newWa || !newFee || !newStations) return alert('All fields required');
                await supabase.from('settings').upsert([
                    { key: 'wa_number', value: newWa },
                    { key: 'delivery_fee', value: newFee },
                    { key: 'pickup_stations', value: newStations }
                ], { onConflict: 'key' });
                settings.wa_number = newWa;
                settings.delivery_fee = newFee;
                settings.pickup_stations = newStations;
                deliveryFeeDisplay.innerText = newFee;
                alert('Settings updated');
            });

            // Notifications modal
            function openNotifModal() {
                renderNotifications();
                notifModal.style.display = 'flex';
            }
            closeNotifBtn.addEventListener('click', () => notifModal.style.display = 'none');

            // Auth modal functions
            function openAuthModal() {
                authModal.style.display = 'flex';
                authModalTitle.innerText = 'Login';
                authLoginBtn.innerText = 'Login';
            }

            authCancel.addEventListener('click', () => authModal.style.display = 'none');
            showSignup.addEventListener('click', (e) => {
                e.preventDefault();
                if (authModalTitle.innerText === 'Login') {
                    authModalTitle.innerText = 'Sign Up';
                    authLoginBtn.innerText = 'Sign Up';
                } else {
                    authModalTitle.innerText = 'Login';
                    authLoginBtn.innerText = 'Login';
                }
            });

            authLoginBtn.addEventListener('click', async () => {
                const email = authEmail.value.trim();
                const password = authPassword.value.trim();
                if (!email || !password) return alert('Email and password required');
                if (authModalTitle.innerText === 'Login') {
                    await signIn(email, password);
                } else {
                    await signUp(email, password);
                }
            });

            // Profile modal
            async function openProfileModal() {
                if (!currentUser) {
                    openAuthModal();
                    return;
                }
                profileEmail.innerText = currentUser.email;
                profileRole.innerText = currentUserProfile?.role || 'customer';
                
                sellerRequestSection.innerHTML = '';
                if (currentUserProfile?.role === 'customer' && !currentUserProfile.seller_status) {
                    sellerRequestSection.innerHTML = '<button class="btn-save" id="applySellerBtn" style="width:100%; margin:10px 0;">Become a Seller</button>';
                    document.getElementById('applySellerBtn')?.addEventListener('click', openSellerApplyModal);
                } else if (currentUserProfile?.seller_status === 'pending') {
                    sellerRequestSection.innerHTML = '<p style="color:orange;">Seller application pending approval.</p>';
                } else if (currentUserProfile?.seller_status === 'rejected') {
                    sellerRequestSection.innerHTML = '<p style="color:red;">Seller application rejected. Contact admin.</p>';
                }

                await renderUserOrders();
                await loadReferralStats();

                if (currentUserProfile?.role === 'seller' && currentUserProfile.seller_status === 'approved') {
                    await renderSellerDashboard();
                } else {
                    sellerDashboard.style.display = 'none';
                }

                profileModal.style.display = 'flex';
            }

            logoutBtn.addEventListener('click', signOut);
            closeProfileBtn.addEventListener('click', () => profileModal.style.display = 'none');

            // Bottom navigation
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    const nav = item.dataset.nav;
                    navItems.forEach(n => n.classList.remove('active'));
                    item.classList.add('active');

                    switch (nav) {
                        case 'home':
                            activeCategory = null;
                            activePromo = false;
                            searchTerm = '';
                            searchInput.value = '';
                            renderCategories();
                            renderProducts();
                            break;
                        case 'promo':
                            activeCategory = null;
                            activePromo = true;
                            renderCategories();
                            renderProducts();
                            break;
                        case 'orders':
                            renderCartModal();
                            cartModal.style.display = 'flex';
                            break;
                        case 'notif':
                            openNotifModal();
                            break;
                        case 'me':
                            openProfileModal();
                            break;
                    }
                });
            });

            // Initial load and subscriptions
            await loadAllData();
            setupSubscriptions();
            updateCartCount();
        })();
    </script>
</body>
                            </html>
